<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"xht03.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="延绪的水上书">
<meta property="og:url" content="http://xht03.github.io/index.html">
<meta property="og:site_name" content="延绪的水上书">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="xht03">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://xht03.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>延绪的水上书</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">延绪的水上书</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://xht03.github.io/2024/08/20/%E6%91%98%E6%8A%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xht03">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="延绪的水上书">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/20/%E6%91%98%E6%8A%84/" class="post-title-link" itemprop="url">鸡汤煲</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-08-20 09:53:10 / 修改时间：11:56:08" itemprop="dateCreated datePublished" datetime="2024-08-20T09:53:10+08:00">2024-08-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Literature/" itemprop="url" rel="index"><span itemprop="name">Literature</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2024/08/20/%E6%91%98%E6%8A%84/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2024/08/20/摘抄/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="时间"><a href="#时间" class="headerlink" title="时间"></a>时间</h4><ul>
<li>时间是公平的，他不会给任何人多一分，也不会给任何人少一秒；但时间也是有偏向的，惜时如金者往往得到时间的奖励，虚掷光阴者往往徒留怅然。</li>
<li>壮士惜年，贤人惜日，圣人惜时。</li>
<li>我们如何使用时间可能取决于我们觉得自己还有多少时间。— <em>阿图·葛文德</em></li>
<li>人们常说，让时间解决一切，而我们常常忘记询问的是，是否还有足够的时间。— <em>若泽</em></li>
<li>过去的，让它过去，永远不要回顾；未来的，等来了时再说，不要空想；我们只抓住了现在。— <em>茅盾</em></li>
<li>念念不忘，必有回响。过去的歌已唱罢多年，回声才从山谷尽头遥遥传来。— <em>王家卫</em></li>
<li>把今天过到最好，而不是为了未来牺牲现在。— <em>《最好的告别》</em></li>
<li>零碎的时间最可贵，但也最容易丢弃。— <em>梁实秋</em></li>
<li>我不向时间争分夺秒，不让我的人生成为争分夺秒的战场，这反而使我的每一个当下都完好无损。— <em>周国平</em></li>
<li>在满园弥漫的沉静光芒中，一个人更容易看到时间，并看到自己的身影。— <em>史铁生</em></li>
<li>时光凿去狂妄，磨出温润。— <em>刘瑜</em></li>
<li>岁月不居，时节如流。— <em>孔融</em></li>
</ul>
<hr>
<h4 id="奋斗"><a href="#奋斗" class="headerlink" title="奋斗"></a>奋斗</h4><ul>
<li>日日行不怕千万里，天天讲不吝千万言，时时做不惧千万事。</li>
<li>最慢的步伐不是跬步，而是徘徊；最快的脚步不是冲刺，而是坚持。</li>
<li>新的长征路上，有风有雨是常态，风雨无阻是心态，风雨兼程是状态。</li>
<li>志不求易者成，事不避难者进。</li>
<li>自信挥戈能退日，山河依旧战旗红。— <em>朱德</em></li>
<li>自信人生二百年，会当击水三千里。— <em>毛泽东</em></li>
<li>喷泉的高度超不过它的源头，一个人的成就超不过他的理想。— <em>林肯</em></li>
<li>每一个不曾起舞的日子，都是对生命的辜负。— <em>尼采</em></li>
<li>当泪的潮涌渐渐退远，理想的岛屿就会浮现。— <em>顾城</em></li>
<li>力，形之所以奋也。—《墨经》</li>
<li>不是因为有希望才坚持，而是坚持了才有希望。</li>
<li>凿井者，起于三寸之坎，以就万仞之深。 — <em>刘昼</em></li>
<li>纵有千古，横有八荒，前途似海，来日方长。— <em>梁启超</em></li>
<li>莫道岁月晚，奋起正当时。</li>
<li>没有不可治愈的伤痛，没有不能结束的沉沦，所有失去的，会以另一种方式归来。— <em>约翰·肖尔斯</em></li>
<li>欢乐是人生的驿站，痛苦是生命的航程。— <em>汪国真</em></li>
<li>逆水行舟，进或有三秦之望，退岂存一锥之地？— <em>《南麓书院记》</em></li>
<li>不懈于日日夜夜的寸积铢累，不滞于夙兴夜寐的久久为功。</li>
<li>艰难方显勇毅，磨砺始得玉成。</li>
<li>一星陨落，黯淡不了星空灿烂；一花凋零，荒芜不了整个春天。— <em>巴尔扎克</em></li>
<li>留得子胥豪气在，三年归报楚王仇。— <em>杨超</em></li>
<li>成功不必在我，功力必不唐捐。— <em>胡适</em></li>
<li>抱怨身处黑暗，不如提灯前行。— <em>刘同</em></li>
<li>没有一件事是白费力气，没有一件事是毫无意义。— <em>小川系</em></li>
<li>人的命就像这琴弦，拉紧了才能弹好，弹好了就够了。— <em>史铁生</em></li>
<li>看似寻常最崎岖，成如容易却艰辛。</li>
<li>天生烝民，其命匪谌。靡不有初，鲜有克终。— <em>《诗经》</em></li>
<li>着力即差。— <em>苏轼</em></li>
<li>夫以五千之卒，敌十万之军，策罢乏之兵，当新羁之马，如此而欲图存，非奋斗不可。</li>
</ul>
<hr>
<h4 id="读书"><a href="#读书" class="headerlink" title="读书"></a>读书</h4><ul>
<li>粗缯大布裹身涯，腹有诗书气自华。— <em>苏轼</em></li>
</ul>
<hr>
<h4 id="信念"><a href="#信念" class="headerlink" title="信念"></a>信念</h4><ul>
<li>志之难者，不在胜人，在自胜也。— <em>《韩非子》</em></li>
<li>船得有航向，人得有追求。就连蚂蚁，看起来是盲动，其实也是各有所奔。— <em>萧乾</em></li>
<li>（孔子）穷于商周，困于陈蔡，受屈于季氏，见辱于阳虎。</li>
<li>一个人如果不知道他要驶向何方，那么任何风都不是顺风。— <em>塞涅卡</em></li>
<li>不说的理想，才像理想。</li>
<li>原来只要知道寻找的是什么，往往就能从身边随手拈来。— <em>乔伊斯</em></li>
<li>道之所存，虽千万人吾亦往矣。— <em>孟子</em></li>
<li>真金之物未必发光，漂泊四海未必迷茫。</li>
<li>岁月悠悠，衰微只及肌肤；热忱抛却，颓废必致灵魂。— <em>塞缪尔</em></li>
<li>人吃饭是为了活着，但活着却不是为了吃饭。— <em>季羡林</em></li>
<li>要有最朴素的生活和最遥远的理想，即使明天天寒地冻，山高水远，路遥马忘。— <em>海子</em></li>
<li>所谓天堂，即是人的仰望。— <em>史铁生</em></li>
<li>人生真正重要的不是目标，而是状态。只要状态是好的，就不必再目标的问题上追根究底了，或者可以说目标就是对的。目标的价值不在理论上，而在实践上，就是为了让你的人生有个好的状态。— <em>周国平</em></li>
<li>少年成为他想的模样，便是岁月最好的奖赏。</li>
<li>一念既出，万山无阻。</li>
<li>来时，无惧路上风雨，少年梦痴狂；归时，几度秋凉，鬓角如霜。</li>
<li>寇可往，亦我可往。</li>
</ul>
<hr>
<h4 id="乐观"><a href="#乐观" class="headerlink" title="乐观"></a>乐观</h4><ul>
<li>快乐，不是一个地方，而是一个方向。— <em>莎士比亚</em></li>
<li>历经万般红尘劫，犹如凉风轻拂面。</li>
<li>曾经沧海难为水，除却巫山不是云。</li>
<li>生活以痛吻我，我却报之以歌。岁月待我凉薄，我却一笑而过。— <em>泰戈尔</em></li>
<li>劝君立足眼前事，荆棘丛中也开花。</li>
<li>寄言燕雀莫相啅，自有云霄万里高。— <em>李白</em></li>
<li>将不幸一口气吸入肺腑，再化为感激呼出，你的人生终会闪闪发光。— <em>小川系</em></li>
<li>凡是过往，皆为序章。— <em>莎士比亚</em></li>
<li>所谓无底深渊，下去，也是前程万里。— <em>木心</em></li>
<li>我总是在最深的绝望中，遇见最美丽的惊喜。— <em>几米</em></li>
</ul>
<hr>
<h4 id="少年"><a href="#少年" class="headerlink" title="少年"></a>少年</h4><ul>
<li>乳虎啸谷，百兽震惶；鹰隼试翼，风尘翕张。— <em>梁启超</em></li>
<li>少年何方梦摘星，敢挽桑弓射玉衡。</li>
<li>四时可爱唯春日，一事能狂便少年。— <em>王维</em></li>
<li>鲜衣怒马少年时，不负韶华行且知。</li>
<li>青春须早为，岂能长少年。— <em>孟郊</em></li>
<li>理直气壮，眼中有光。</li>
<li>白马长枪飘如诗，所向披靡少年时。</li>
<li>志当存高远，英雄犹少年。</li>
<li>少年振衣，岂不可做千里风幡看；少年瞬目，亦可壮作万古清流想。— <em>张晓风</em></li>
</ul>
<hr>
<p>to be continued</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://xht03.github.io/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xht03">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="延绪的水上书">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/" class="post-title-link" itemprop="url">数据库笔记3：Indexing and Hashing</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-06-21 21:35:40" itemprop="dateCreated datePublished" datetime="2024-06-21T21:35:40+08:00">2024-06-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-06-23 15:15:00" itemprop="dateModified" datetime="2024-06-23T15:15:00+08:00">2024-06-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/The-Introduction-to-Database/" itemprop="url" rel="index"><span itemprop="name">The Introduction to Database</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2024/06/21/数据库3-索引/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>就像查字典有拼音索引、部首索引、笔画索引一样，为了方便查询，数据库中也有索引。主要有以下两种索引：</p>
<ul>
<li><strong>顺序索引（Ordered indices）</strong></li>
<li><strong>哈希索引（Hash indices）</strong></li>
</ul>
<p>首先，我们介绍一些预备知识。</p>
<p>查询记录时，我们会根据一个属性或者多个属性进行搜索。这个属性集，我们称为：<strong>搜索码（search key）</strong>。</p>
<p>索引包含若干索引项。<strong>索引项（index entry）</strong>由一个搜索码值和指向记录的一个或多个指针构成。</p>
<p>考虑到：数据库中更新记录，可以等价为先删除旧记录，在插入新记录。所以，我们只需要考虑插入索引和删除索引即可。</p>
<h3 id="顺序索引"><a href="#顺序索引" class="headerlink" title="顺序索引"></a>顺序索引</h3><p>在顺序索引中，<strong>索引项是按照 search key 进行排序存储的</strong>。</p>
<p>但是数据的存储顺序不一定与索引项的排序顺序相同。所以，根据是否与数据的排序顺序相符合，我们将索引分为两类：</p>
<ul>
<li><p><strong>主索引（ Clustering Index）</strong>：索引顺序与数据顺序相同。</p>
</li>
<li><p><strong>辅助索引（Non-clustering Index）</strong>：索引顺序与数据顺序不同。</p>
<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/secondary-index.png" alt="secondary index"></p>
</li>
</ul>
<p>除了这种分类方式，还可以根据索引项的密度进行分类：</p>
<ul>
<li><p><strong>稠密索引（Dense Index）</strong>：每一个搜索码都对应地有一个索引项。</p>
<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/dense-index.png" alt="dense index (but not clustering)"></p>
</li>
<li><p><strong>稀疏索引（Sparse Index）</strong>：索引项只涵盖了部分搜索码的可能取值。</p>
<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/sparse-index.png" alt="sparse index"></p>
</li>
</ul>
<p>请注意：<strong>辅助索引必须是稠密索引</strong>，即每个搜索码都有一个索引项。这是因为：辅助索引的顺序与数据顺序不同，如果一个搜索码没有对应的索引项，那么这个记录可能出现在数据库中的任何地方，那么索引也就失去作用了。</p>
<p>显然，如果索引是聚集且稀疏的，查询一个记录则可以这么做：先在索引中寻找不大于当前搜索码值的最大索引，在从这个索引项指向的记录开始，依次往后搜索。</p>
<p>所以，稀疏索引的好处时可以使用更少的空间来存储索引，但定位一个记录的时间会更慢一点。所以一个不错的权衡是：生成一个稀疏索引，<strong>为每一个块建一个索引项</strong>（generate a sparse index with an index entry for every block in file）。</p>
<h3 id="B-树索引"><a href="#B-树索引" class="headerlink" title="B+树索引"></a>B+树索引</h3><h4 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h4><p>B+树索引的好处和缺点如下：</p>
<table>
<thead>
<tr>
<th align="center">优点</th>
<th align="center">缺点</th>
</tr>
</thead>
<tbody><tr>
<td align="center">每次插入删除会自动重组索引结构</td>
<td align="center">每次插入删除都有额外的时间开销</td>
</tr>
<tr>
<td align="center">不需要重组整个文件来维持性能</td>
<td align="center">维持B+树的空间开销</td>
</tr>
</tbody></table>
<hr>
<h4 id="整体结构"><a href="#整体结构" class="headerlink" title="整体结构"></a>整体结构</h4><blockquote>
<p>中间节点（internal nodes）：既不是根节点，也不是叶节点</p>
</blockquote>
<p>B+树是一个有根节点的树，且满足以下性质：</p>
<ul>
<li>所有从根节点到叶节点的路径都一样长。（平衡树）</li>
<li>每个中间节点有 ⌈n&#x2F;2⌉ 到 n 个子节点。（n预先给定的）</li>
<li>叶节点有 ⌈(n-1)&#x2F;2⌉ 到 n-1个值。</li>
<li>如果根节点不是叶节点，则根节点至少有两个子节点。</li>
<li>如果根节点是叶节点，则根节点有 0 到 (n-1) 个值。</li>
</ul>
<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/B-plus.png" alt="B+ tree 1"></p>
<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/B-plus-example.png" alt="B+ tree 2"></p>
<hr>
<h4 id="节点结构"><a href="#节点结构" class="headerlink" title="节点结构"></a>节点结构</h4><p>对于非叶子节点：</p>
<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/node-structure.png" alt="B+ tree node structure"></p>
<p>其中：</p>
<ul>
<li><p>指针个数 n 称为：<strong>扇出（fanout）</strong>。</p>
</li>
<li><p>**K<sub>1</sub> &lt; K<sub>2</sub> &lt; …… &lt; K<sub>n-1</sub>**（假设搜索码不会重复）</p>
<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/k-condition.png" alt="K-condition"></p>
</li>
</ul>
<p>如果是叶子节点，则还有如下性质：</p>
<ul>
<li>最后一个指针 P<sub>n</sub> 指向下一个叶子节点。</li>
<li>P<sub>i</sub> 指向的记录的搜索码取值为 K<sub>i</sub> 。</li>
<li>如果叶节点 L<sub>i</sub> &lt; L<sub>j</sub> ，那么叶节点 L<sub>i</sub> 中所有记录的搜索码都小于等于 L<sub>j</sub> 中的。</li>
</ul>
<p>如果搜索码可能重复，那么 K<sub>i</sub> 序列不再是严格单增的。而是：<strong>K<sub>1</sub> &lt;&#x3D; K<sub>2</sub> &lt;&#x3D; …… &lt;&#x3D; K<sub>n-1</sub></strong></p>
<hr>
<h4 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h4><p>在 B+ 树种查找搜索码为 V 的记录，方法如下（伪代码表示）：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">set C = root node</span><br><span class="line"></span><br><span class="line">while(C is not a leaf node) &#123;</span><br><span class="line">    Let i = smallest number s.t. V &lt;= C.Ki</span><br><span class="line">    if no such i exists, then set C = C.Pm</span><br><span class="line">    	where Pm = last non-null pointer in the node</span><br><span class="line">    else if(V = C.Ki) then set C = C.Pi+1</span><br><span class="line">    else set C = C.Pi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Let i be the least value s.t. Ki = V</span><br><span class="line"></span><br><span class="line">if there is such a value i, return (C, i)</span><br><span class="line">else return null</span><br></pre></td></tr></table></figure>

<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/query-example.png" alt="query example"></p>
<hr>
<h4 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h4><p>由于 B+ 树对每个节点的子节点数有限制，所以每次插入删除都可能需要：</p>
<ul>
<li><strong>Split</strong> a node if the node becomes too large.</li>
<li><strong>Coalesce (合并)</strong> two or more nodes if a node becomes too  small.</li>
</ul>
<p>分裂和合并的规则描述起来比较复杂，我们直接看例子。</p>
<ol>
<li><p>插入”Adam”：</p>
<ul>
<li><p>先根据之前的查询的流程来定位。</p>
</li>
<li><p>插入“Adam”，检查是否需要分裂。若需要，则分裂。</p>
</li>
<li><p>子节点分裂可能导致父节点也需要分裂，所以需要一层层向上检查。</p>
<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/split-example1.1.png" alt="locate the node"></p>
<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/split-node.png" alt="split the node"></p>
<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/split-result.png" alt="split result"></p>
</li>
</ul>
</li>
<li><p>在1的基础上，再插入“Lamport”：</p>
<ul>
<li>与之前类似，不过这次插入导致上层节点也需要分裂。</li>
</ul>
<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/insert-result.png" alt="insert result"></p>
</li>
<li><p>删除“Srinivasan”：</p>
<ul>
<li>删除目标节点。</li>
<li>如果删除后子节点数不符合要求，那么与兄弟节点进行合并。</li>
<li>合并后，父节点可能也需要合并，所以需要向上一层层检查。</li>
</ul>
<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/delete-process.png" alt="delete example1"></p>
</li>
<li><p>再删除“Singh”和“Wu”：</p>
<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/delete-example2.png" alt="delete example2"></p>
</li>
<li><p>再删除“Gold”：</p>
<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/delete-example3.png" alt="delete example3"></p>
</li>
</ol>
<hr>
<h4 id="B-树索引-1"><a href="#B-树索引-1" class="headerlink" title="B 树索引"></a>B 树索引</h4><p>B 树类似于 B+ 树。B 树要求：<strong>每个搜索码的取值只能出现一次</strong>，从而消除重复储存搜索码的值。</p>
<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/B-tree.png" alt="B tree"></p>
<p>B 树优点在于：</p>
<ul>
<li>使用了更少的节点</li>
<li>可能更快地找到搜索码的值（因为不一定要遍历到叶节点）</li>
</ul>
<p>B 树缺点在于：</p>
<ul>
<li>只有很小一部分的搜索码的值是可以更快找到的。</li>
<li>插入和删除操作都会更复杂</li>
<li>实现也更加麻烦</li>
</ul>
<p>总的来说，B树不如B+树，缺点远胜优点。</p>
<h3 id="哈希索引"><a href="#哈希索引" class="headerlink" title="哈希索引"></a>哈希索引</h3><p>之前的索引方式都需要建立一种索引结构，但哈希索引则可以避免：</p>
<ul>
<li>通过计算<strong>哈希函数（hash function）</strong>，可以由 search key 计算得到包含目标记录的块地址。</li>
<li>A <strong>bucket</strong> is a unit of storage containing one or more records typically a disk block.</li>
</ul>
<hr>
<h4 id="静态哈希"><a href="#静态哈希" class="headerlink" title="静态哈希"></a>静态哈希</h4><p>在静态哈希种，<strong>桶的数量是固定的</strong>。</p>
<p>常见的哈希函数都是：<strong>计算搜索码的二进制表示，再模上桶的数量</strong>。</p>
<p>例如下图中：根据dept_name，在instructor表上建立哈希索引。</p>
<blockquote>
<p>桶个数&#x3D;8。</p>
<p>哈希函数是：将各字母在字母表中的序号相加，再 mod 8。</p>
</blockquote>
<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/static-hash.png" alt="static hash"></p>
<hr>
<h4 id="溢出桶"><a href="#溢出桶" class="headerlink" title="溢出桶"></a>溢出桶</h4><p>但如果插入记录时，发现桶里已经装满了记录，这就是：<strong>桶溢出（Bucket Overflow）</strong>。一般有如下两种原因：</p>
<ul>
<li>桶确实不足。即使所有桶全部装满，也装不完全部记录。</li>
<li>很多记录都装进了同一个桶，而其他很多桶还有很多空间。<strong>（Skew in distribution of records）</strong></li>
</ul>
<p>解决办法也很朴素：加桶（谁溢出，谁加桶）。</p>
<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/overflow-bucket.png" alt="overflow bucket"></p>
<hr>
<h4 id="动态哈希"><a href="#动态哈希" class="headerlink" title="动态哈希"></a>动态哈希</h4><p>静态哈希虽然易于实现，但缺点也明显：桶的数量是固定。</p>
<ul>
<li>如果设置的太小，那么需要不停的添加溢出桶，且一个 hash地址 中的记录也会非常多，导致查询效率降低。</li>
<li>如果设置的太大，在数据规模还没起来时，大量空间被浪费了。</li>
</ul>
<p>所以我们希望：桶的数量能动态变化。这便是：动态哈希。</p>
<p>这里，我们主要介绍：<strong>可扩充散列（Extendable Hashing）</strong>。</p>
<p>可扩充散列的核心思想是：<strong>当存储的记录不多时，我们只使用 hash 值的前几位。当存在有桶溢出的情况时，我们再使用更多的 hash 值位数。</strong></p>
<p>严格来说：</p>
<ul>
<li>假定 hash 函数产生的 hash 值是 b 位。</li>
<li>设每个桶所对应的 hash 值是 i 位，（0 &lt;&#x3D; i &lt;&#x3D; b）。</li>
<li>当一条记录经过 hash 函数计算得的 hash 值的前 i 位与桶的 hash 值相同时，这条记录存储在这个桶里。</li>
<li>当这个桶溢出时，这个桶会分成两个桶。它们的 hash 值都是 i+1 位，且前 i 位继承原来桶的 hash 值，最后一位则分别时0、1。原来桶中的记录依据 hash 值分别装进新的两个桶中。</li>
</ul>
<p>具体来说，我们举例说明：</p>
<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/extendable-hash1.png" alt="example"></p>
<ul>
<li>插入“Mozart”：</li>
</ul>
<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/extendable-example2.png" alt="Insert Mozart"></p>
<ul>
<li><p>插入“Einstein”：</p>
<blockquote>
<p>这时2号桶的 i<sub>2</sub> 需要加1，且 bucket address table 的前缀长度 &#x3D; max { i<sub>k</sub> | k &#x3D; 1, 2, … , b} 也会随着加1。</p>
</blockquote>
</li>
</ul>
<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/exetendable-example3.png" alt="Insert Einstein"></p>
<ul>
<li>插入“Gold”：</li>
</ul>
<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/extendable-example4.png" alt="Insert Gold"></p>
<hr>
<h4 id="一些比较"><a href="#一些比较" class="headerlink" title="一些比较"></a>一些比较</h4><p>如果是范围搜索，顺序索引更好。</p>
<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/range-query.png" alt="range query"></p>
<p>如果是搜索某个具体的值，哈希索引更好。</p>
<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/key-query.png" alt="query based on a key"></p>
<h3 id="位图索引"><a href="#位图索引" class="headerlink" title="位图索引"></a>位图索引</h3><p>位图索引（Bitmap Index）是一种特殊但非常高效的索引。但<strong>它一般只建立一个属性上，且该属性的可能取值很少</strong>（比如：性别、国家、省）。</p>
<p>具体来说：</p>
<ul>
<li>这个属性的每一个取值都有相应的 bitmap。</li>
<li>一个取值 V 的 bitmap 的第 i 位为1，表示第i条记录的该属性是 V。若是0，则不是 V。</li>
</ul>
<p><img src="/2024/06/21/%E6%95%B0%E6%8D%AE%E5%BA%933-%E7%B4%A2%E5%BC%95/bitmap.png" alt="bitmap"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://xht03.github.io/2024/06/13/%E6%95%B0%E6%8D%AE%E5%BA%932-%E5%B9%B6%E8%A1%8C%E6%8E%A7%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xht03">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="延绪的水上书">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/13/%E6%95%B0%E6%8D%AE%E5%BA%932-%E5%B9%B6%E8%A1%8C%E6%8E%A7%E5%88%B6/" class="post-title-link" itemprop="url">数据库笔记2：Concurrency Control</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-06-13 18:35:07" itemprop="dateCreated datePublished" datetime="2024-06-13T18:35:07+08:00">2024-06-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-06-21 21:32:41" itemprop="dateModified" datetime="2024-06-21T21:32:41+08:00">2024-06-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/The-Introduction-to-Database/" itemprop="url" rel="index"><span itemprop="name">The Introduction to Database</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2024/06/13/%E6%95%B0%E6%8D%AE%E5%BA%932-%E5%B9%B6%E8%A1%8C%E6%8E%A7%E5%88%B6/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2024/06/13/数据库2-并行控制/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>当数据库中多个事务并发执行时，事务的隔离性不一定能保持。为了保持事务的隔离性，数据库必须控制不同事务之间的互动。</p>
<p>这里我们将介绍两种常见的<strong>并发控制（concurrency control）</strong>的机制：</p>
<ul>
<li>two-phase locking（二相锁）</li>
<li>timestamp（时间戳）</li>
</ul>
<h3 id="二相锁"><a href="#二相锁" class="headerlink" title="二相锁"></a>二相锁</h3><p>就像“编辑在线文档”，为了避免自己写的内容被其他人篡改，最简单的方式就是：在自己编辑的时候给文档上锁，只有自己能修改其中的内容。等到修改完成后，再打开锁，允许其他人进行修改。</p>
<p>数据库中也是类似的。</p>
<hr>
<h4 id="什么是锁"><a href="#什么是锁" class="headerlink" title="什么是锁"></a>什么是锁</h4><p>数据项可以被加上以下两种模式的锁：</p>
<ul>
<li><strong>共享锁</strong> shared mode (S)：数据项只能被读。</li>
<li><strong>排他锁</strong> exclusive mode (X)：数据项可以被读或者写。</li>
</ul>
<p>显然，多个事务可以同时持有同一个数据的共享锁。但若有一个事务持有这个数据的排他锁，那么其他事务不能再持有该数据的共享锁。所以，不同锁之间也是存在<strong>兼容性（Lock-compatibility）</strong>的。</p>
<p><img src="/2024/06/13/%E6%95%B0%E6%8D%AE%E5%BA%932-%E5%B9%B6%E8%A1%8C%E6%8E%A7%E5%88%B6/compatibility.png" alt="Lock-compatibility"></p>
<p>当一个事务想访问一个数据时，它会向<strong>并发控制管理器（concurrency-control manager）</strong>发出请求。如果当前不存在与其不兼容的锁，则向该事务授权新锁；否则需要等待不兼容的锁全部被释放，才能再授权新锁。</p>
<hr>
<h4 id="基于锁的协议"><a href="#基于锁的协议" class="headerlink" title="基于锁的协议"></a>基于锁的协议</h4><p>但需要注意：<strong>上锁并不能保证调度是可序列化的</strong>。</p>
<p>例如：A账户有100元，B账户有200元；T1是从B向A转账50元，T2是打印A、B账户金额总和。具体调度如下图。</p>
<p><img src="/2024/06/13/%E6%95%B0%E6%8D%AE%E5%BA%932-%E5%B9%B6%E8%A1%8C%E6%8E%A7%E5%88%B6/example1.png" alt="example1"></p>
<p>可以发现，这样的调度就不满足事务的一致性。原因在于：</p>
<ul>
<li>T1 过早的释放了数据B的锁。这导致 T2 误以为自己已经获得了所有需要的数据，就开始执行。但 T2 读取的A并不是 T1 更新后的值。</li>
</ul>
<p>因此我们还需要：<strong>基于锁的协议（Lock-Based Protocols）</strong>来对申请和释放锁进行规定。（所谓协议，就是一些需遵守的规则罢了）</p>
<p>所以，针对上面例子，我们可以规定：<strong>释放锁被推迟到事务结束时</strong>。这样就能确保调度时可序列化的。</p>
<blockquote>
<p>Unlocking is delayed to the end of the transaction.</p>
</blockquote>
<hr>
<h4 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h4><p>当我们使用锁时，可能出现以下这种情况：</p>
<p><img src="/2024/06/13/%E6%95%B0%E6%8D%AE%E5%BA%932-%E5%B9%B6%E8%A1%8C%E6%8E%A7%E5%88%B6/deadlock.png" alt="deadlock"></p>
<p>T3 和 T4 都需要数据 A、B。但 T3 持有B并给B上锁；T4 持有A并给A上锁。此时，T3 和 T4 都有彼此想要的数据项，但又都不愿意释放出自己手中的数据。于是调度就僵持在这里，无法进行。这种情况，我们称之为：<strong>死锁（deadlock）</strong>。</p>
<hr>
<p>就像《剪刀手爱德华》里说的：“如果我没有刀，我无法保护你；如果我拿着刀，我无法拥抱你。”如果不采用锁，无法保证事务的一致性；但如果采用锁，又会产生死锁的情况。</p>
<p>“两害相权取其轻”。相较于数据的不一致，死锁是可以接受的。 处理死锁的思路一般有两种：</p>
<ul>
<li>预防：采用 deadlock prevention protocol，保证系统永远不会进入死锁状态。</li>
<li>修复：允许系统进入死锁状态，进入后进行恢复就好。</li>
</ul>
<p>当系统有很高频率进入死锁状态时，“预防”是更好的选择。否则“进入后再恢复”是更高效的方案。</p>
<hr>
<p><strong>死锁预防（deadlock prevention）</strong>有以下两种常见方式：</p>
<ul>
<li>一个事务在执行的开始就把所有需要的数据上锁。要么一次性锁住所有需要的数据，要么一个也不锁。</li>
<li>系统给所有资源分配一个全局的顺序号，事务必须按顺序请求资源。也就是说：如果一个事务已经持有了一个资源，它只能请求顺序号更大的资源，不能请求顺序号更小的资源。但如果一个事务需要请求顺序号更小的资源，它必须：1. 释放当前持有的所有锁；2. 按照顺序从小到大重新申请所有所需的资源。</li>
</ul>
<p>第一种策略易于实现，但缺点明显：在事务的开始时，系统难以预测它究竟需要哪些数据；其次这样的数据利用效率非常低。</p>
<p>第二种策略可能不那么易于理解，我们举一个例子：</p>
<p>假设有三个资源 A、B 和 C，它们的顺序号分别是 1、2 和 3。</p>
<ul>
<li>事务 T1 需要锁定资源 B 和 A。</li>
<li>事务 T2 需要锁定资源 A 和 B。</li>
</ul>
<p>此时事务 T1 已经锁定资源 B，事务 T2 已经锁定资源 A。但由于 资源A顺序 &lt; 资源B顺序 ，事务 T1 不能锁定 A，所以它会释放资源 B，重新请求上锁，这样事务 T2 就能顺利获得资源 B，从而避免死锁。</p>
<p>这种策略的优势在于：易于实现，不需要对底层的并发控制系统进行修改。</p>
<hr>
<p>死锁恢复一般采用<strong>抢占和回滚（preemption and transaction rollbacks）</strong>：其实就是，抢走一个事务手中的锁，并将这些锁给其他事务，并将被抢的事务回滚。但是谁抢走谁呢？这就需要一个判断标准：<strong>事务的时间戳（Transaction timestamps）</strong>。</p>
<p>形象地比喻就是“银行办理业务”：每个人都会到大厅机器上取一个号码，这个就是你的时间戳。大家根据时间戳先后决定谁先办理业务。</p>
<p>在数据库中也是相似的，一般有两种策略：</p>
<ul>
<li><strong>Wait-Die Scheme</strong>（new-die &amp; old-wait）：如果一个较老的事务请求一个被较新的事务持有的资源，那么较老的事务会等待。如果一个较新的事务请求一个被较老的事务持有的资源，那么较新的事务会被回滚。</li>
<li><strong>Wound-Wait Scheme</strong>（new-wait &amp; old-die）：如果果一个较老的事务请求一个被较新的事务持有的资源，那么较新的事务会被立即回滚。如果一个较新的事务请求一个被较老的事务持有的资源，那么较新的事务会等待。</li>
</ul>
<p>举例说明一下：</p>
<ul>
<li>事务 T14、T15 和 T16 的时间戳分别为 5、10 和 15。</li>
<li>在 Wait-Die 方案下：如果 T14 请求一个由 T15 持有的数据项，那么 T14 将会等待。如果 T16 请求一个由 T15 持有的数据项，那么 T16 将会被回滚。</li>
<li>在 Wound-Wait 方案下：如果 T14 请求一个由 T15 持有的数据项，那么数据项将从 T15 中被抢占，T15 将会被回滚。如果 T16 请求一个由 T15 持有的数据项，那么 T16 将会等待。</li>
</ul>
<p>但这两种策略都会带来不必要的回滚。</p>
<hr>
<p>还有一种解决死锁的方式：<strong>锁超时（lock-timeout）</strong>：申请锁的事务最多等待一定时间，如果没有得到锁，则该事务自动回滚，并重启。</p>
<p>这种方式介于预防和恢复之间。但超时的时间限制（timeout interval）是不好把握的。太长，死锁卡住的时间就久；太短，一个事务太没耐心，从而可能不停回滚。</p>
<hr>
<h4 id="饿死"><a href="#饿死" class="headerlink" title="饿死"></a>饿死</h4><p>当我们使用锁时，会出现以下这种情况：</p>
<ul>
<li>一个事务可能在等待某个数据的排他锁，同时，许多其他事务请求并获得了该项目上的S锁（共享锁）。</li>
</ul>
<p>形象的比喻就是“银行业务办理窗口”：</p>
<ul>
<li>事务比作人，数据比作窗口，若干事务正在排队访问数据。你前面有一个人正在读数据，但你是想写数据，你只能等待。这这时后面的人说：“嘿，我就读数据，让我凑过去看一眼”，于是他插队到你前面（获得了共享锁）。后面所有想读数据的人，都能这样插队到你前面。即使最开始的读数据的人已经完成离开了，但还有新的人正在读数据。如此，你就一直无法获取到写数据的排他锁。</li>
</ul>
<p>这种情况，我们称之为：<strong>饿死（Starvation）</strong>。</p>
<p>避免这样的“插队”问题，也是很简单的——遵守“先来后到”的规则就好。具体如下。</p>
<p>当事务T请求数据Q的M型锁时，并发控制管理器授权加锁的条件是：</p>
<ul>
<li>此时，数据Q上没有与M不兼容的锁</li>
<li>此时，不存在 “正在等待加锁的” 且 “排队在事务T之前的” 的事务。</li>
</ul>
<hr>
<h4 id="二相锁协议"><a href="#二相锁协议" class="headerlink" title="二相锁协议"></a>二相锁协议</h4><blockquote>
<p>在 two-phase locking protocol 中：释放锁不必须在事务结束时进行。</p>
</blockquote>
<p>二相锁协议是<strong>能保证调度可序列化的</strong>。它要求每个事务分两个阶段提出加锁、解锁的申请：</p>
<ul>
<li><strong>growing phase</strong>：事务只能获得锁。</li>
<li><strong>shrinking phase</strong>：事务只能释放锁。</li>
</ul>
<p>例如下图中：T1 和 T2 就不是二相锁，T3 和 T4 就是二相锁。（且将<code>unlock(B)</code>提前到<code>lock-X(A)</code>后面执行，也仍是遵守协议的）</p>
<p><img src="/2024/06/13/%E6%95%B0%E6%8D%AE%E5%BA%932-%E5%B9%B6%E8%A1%8C%E6%8E%A7%E5%88%B6/example2.png" alt="example2"></p>
<p>对于任何事务，它获得它的最后一个锁的时候，也就是增长阶段结束的时候，我们称之为：事务的<strong>封锁点（lock point）</strong>。</p>
<p>二相锁是可序列化的，且：<strong>各个事务实际上就是按照 lock point 的先后进行顺序执行完成的。</strong></p>
<p><img src="/2024/06/13/%E6%95%B0%E6%8D%AE%E5%BA%932-%E5%B9%B6%E8%A1%8C%E6%8E%A7%E5%88%B6/two-phase.png" alt="two phase lock"></p>
<p>但二相锁并不是完美的：</p>
<ul>
<li>二相锁<strong>不能避免死锁</strong>的问题。</li>
<li>二项锁<strong>不是无级联的</strong>。它仍然可能出现级联回滚（cascading roll back）的情况。</li>
</ul>
<p>为了避免级联回滚，我们可以提出更严格的二相锁协议：</p>
<ul>
<li><strong>Strict two-phase locking protocol</strong>：一个事务必须持有 <em>所有的排他锁</em> 直到它提交或中止。</li>
<li><strong>Rigorous two-phase locking protocol</strong>：一个事务必须持有 <em>所有锁</em> 直到它提交或中止。</li>
</ul>
<p>其中后者的序列化的顺序是按照事务的提交时间（而不再是lock point）。</p>
<hr>
<h4 id="锁的转换"><a href="#锁的转换" class="headerlink" title="锁的转换"></a>锁的转换</h4><p>共享锁和排他锁时可以相互转换的，通过<strong>升级（upgrading）</strong>和<strong>降级（downgrading）</strong>。</p>
<p>例如：当事务T已经拥有S锁，且又需要X锁时：它可以将S锁升级成X锁。</p>
<p><img src="/2024/06/13/%E6%95%B0%E6%8D%AE%E5%BA%932-%E5%B9%B6%E8%A1%8C%E6%8E%A7%E5%88%B6/conversion.png" alt="conversion"></p>
<p>但锁的升级和降级不是能乱来的：</p>
<ul>
<li>升级只能发生在 growing phase</li>
<li>降级只能发生在 shrinking phase</li>
</ul>
<p>且进行锁转换时也需要注意：是否与当前已有的锁兼容。若不兼容，则需要等待。</p>
<p>所以，当一个事务需要锁时，并不是直接申请，而是先检查是否已有锁。若有，则请求升级或者降级；若无，再申请加锁。</p>
<blockquote>
<p>大部分数据库都采用 Strict two-phase locking protocol 和 lock conversion 的机制。</p>
</blockquote>
<hr>
<h4 id="锁管理器"><a href="#锁管理器" class="headerlink" title="锁管理器"></a>锁管理器</h4><p>锁管理器（lock manager）就是一个<strong>进程</strong>，并维护一个记录已有锁和等待锁的数据结构——<strong>锁表（lock table）</strong>。各个事务向其发送加锁、解锁的请求。</p>
<p>锁表结构如下图所示：</p>
<ul>
<li>用哈希链表存储各个数据项17、123、1912、14、144</li>
<li>某一个数据项上的锁，存储在指向当前数据项的链表中。第一个是被授权的锁，后续的是正在等待的锁。</li>
<li>例如：T2 申请 “数据123” 上的排他锁，此时 T1 和 T8 已持有其共享锁。那么 T2 的申请会被添加到 “数据123” 的链表的末尾。</li>
<li>如果一个事务终止（aborted），锁管理器会释放该事务持有的所有锁。</li>
</ul>
<p><img src="/2024/06/13/%E6%95%B0%E6%8D%AE%E5%BA%932-%E5%B9%B6%E8%A1%8C%E6%8E%A7%E5%88%B6/lock-table.png" alt="lock table"></p>
<hr>
<h3 id="多粒度"><a href="#多粒度" class="headerlink" title="多粒度"></a>多粒度</h3><p>截至目前，我们讨论的并发控制都是以一个个数据为单位，但实际情况中，一个事务可能请求访问整个数据库的内容，这时一个个数据的上锁会非常耽误时间，我们希望能直接一次请求就能锁住整个数据库。所以，我们需要根据各种数据项大小，定义数据粒度的层次。</p>
<p><strong>多粒度机制（Multiple granularity mechanism）</strong>允许数据项具有不同的大小，并定义一个数据粒度的层次结构，其中较小的粒度嵌套在较大的粒度之内。这样的层次结构可以用树状图形来表示。树中的每个节点都可以单独加锁。当一个事务显式地锁定树中的一个节点时，它隐式地以相同的模式锁定该节点的所有子孙节点。</p>
<p><img src="/2024/06/13/%E6%95%B0%E6%8D%AE%E5%BA%932-%E5%B9%B6%E8%A1%8C%E6%8E%A7%E5%88%B6/tree.png" alt="granularity"></p>
<p>但是，每一次加锁，都需要判定当前节点是否能加锁。例如：事务 T1 想给 A1 加共享锁，但是系统必须检查 A1 的所有子节点中是否有排他锁。若有，则不能加锁。但如果每次加锁都需要搜索整个树，就违背了多粒度机制的初衷——快速地给大量数据加锁。</p>
<p>所以我们引入了一种新的锁的模式：<strong>意向锁（intention lock mode）</strong>。</p>
<hr>
<h4 id="意向锁"><a href="#意向锁" class="headerlink" title="意向锁"></a>意向锁</h4><blockquote>
<p>意向锁也是可能出现死锁的。</p>
</blockquote>
<p>意向锁有五种锁的模式：</p>
<ul>
<li>S（共享锁）</li>
<li>X（排他锁）</li>
<li><strong>IS（共享意向锁）</strong>：表明将要在更低层次加共享锁。</li>
<li><strong>IX（排他意向锁）</strong>：表明将要在更低层次加排他锁。</li>
<li><strong>SIX（共享排他意向锁）</strong>：表明在更高层次加了共享锁，并且将要在更低层次加独占锁。（SIX &#x3D; S + IX）</li>
</ul>
<p><img src="/2024/06/13/%E6%95%B0%E6%8D%AE%E5%BA%932-%E5%B9%B6%E8%A1%8C%E6%8E%A7%E5%88%B6/intention-lock.png" alt="intention lock"></p>
<p>核心想法就是：增加 IS、IX、SIX 模式，来反映子节点的上锁情况。这样给当前节点上锁时，就不必搜索当前节点的子树，检查当前节点的锁就能知道其子节点的上锁情况。当我们给一个节点上意向锁时，我们只需要更新当前节点和其父节点的锁即可，不需要更改其子节点的锁。</p>
<p>事务 T<sub>i</sub> 可以使用以下规则锁定节点 Q：</p>
<ul>
<li>必须遵守上图种的锁兼容矩阵。</li>
<li>必须首先锁定树的根节点，并且可以以任何模式锁定。</li>
<li>事务 T<sub>i</sub> 只有在 Q 的父节点被 T<sub>i</sub> 以 IX 或 IS 模式锁定时，才能以 S 或 IS 模式锁定节点 Q。</li>
<li>事务 T<sub>i</sub> 只有在 Q 的父节点被 T<sub>i</sub> 以 IX 或 SIX 模式锁定时，才能以 X、SIX 或 IX 模式锁定节点 Q。</li>
<li>事务 T<sub>i</sub> 只有在之前没有解锁过任何节点的情况下才能锁定节点（即：T<sub>i</sub> 遵循二相锁协议）。</li>
<li>事务 T<sub>i</sub> 只有在 Q 的子节点都没有被 T<sub>i</sub> 锁定的情况下才能解锁节点 Q。</li>
</ul>
<p>请注意：锁定是从根到叶节点的顺序进行的，而解锁是从叶到根的顺序进行的。</p>
<p>举例说明一下，假设依次发生以下请求：</p>
<ul>
<li><p>事务 T<sub>1</sub> 读取记录 r<sub>a<sub>1</sub></sub> 。</p>
<p><img src="/2024/06/13/%E6%95%B0%E6%8D%AE%E5%BA%932-%E5%B9%B6%E8%A1%8C%E6%8E%A7%E5%88%B6/example3.1.png" alt="example3.1"></p>
</li>
<li><p>事务 T<sub>2</sub> 更新记录 r<sub>a<sub>2</sub></sub> 。</p>
<p><img src="/2024/06/13/%E6%95%B0%E6%8D%AE%E5%BA%932-%E5%B9%B6%E8%A1%8C%E6%8E%A7%E5%88%B6/example3.2.png" alt="example3.2"></p>
</li>
<li><p>事务 T<sub>3</sub> 读取文件 F<sub>a</sub> 。（但此时 S<sub>T<sub>3 </sub></sub> 锁和 IX<sub>T<sub>2</sub></sub> 锁相矛盾了，所以 T<sub>3</sub> 会进行等待）</p>
<p><img src="/2024/06/13/%E6%95%B0%E6%8D%AE%E5%BA%932-%E5%B9%B6%E8%A1%8C%E6%8E%A7%E5%88%B6/example3.3.png" alt="example3.3"></p>
</li>
</ul>
<h3 id="时间戳"><a href="#时间戳" class="headerlink" title="时间戳"></a>时间戳</h3><p>之前基于锁的各种协议，最终可序列化的顺序都是由上锁的时刻决定。现在我们介绍第二种实现并行控制的方法：<strong>基于时间戳的协议（Timestamp-Based Protocols）</strong>。这种方法的事务可序列化顺序是预先决定的。</p>
<hr>
<h4 id="事务时间戳"><a href="#事务时间戳" class="headerlink" title="事务时间戳"></a>事务时间戳</h4><p>每个事务 T<sub>i</sub> 都会被分配一个唯一的固定时间戳 TS(T<sub>i</sub>)。这个时间戳在事务 T<sub>i</sub> 开始执行之前由数据库系统分配。</p>
<ul>
<li><p>如果事务 T<sub>i</sub> 被分配了时间戳 TS(T<sub>i</sub>)，并且有一个新的事务 T<sub>j</sub> 进入系统，那么 TS(T<sub>i</sub>) &lt; TS(T<sub>j</sub>)。</p>
</li>
<li><p>有两种简单的方法来实现时间戳方案：</p>
<ul>
<li><p>使用<strong>系统时钟</strong>的值作为时间戳——事务的时间戳等于事务进入系统时的时钟值。</p>
</li>
<li><p>使用<strong>逻辑计数器</strong>，该计数器在分配新时间戳后递增——事务的时间戳等于事务进入系统时计数器的值。</p>
</li>
</ul>
</li>
</ul>
<p><strong>时间戳决定了可串行化的顺序</strong>。</p>
<ul>
<li>如果 TS(T<sub>i</sub>) &lt; TS(T<sub>j</sub>)，则生成度必须等效于一个串行调度，其中 T<sub>i</sub> 出现在事务 T<sub>j</sub> 之前。</li>
</ul>
<hr>
<h4 id="数据时间戳"><a href="#数据时间戳" class="headerlink" title="数据时间戳"></a>数据时间戳</h4><p>为了实现这个方案，协议为每个数据项 Q 维护两个时间戳值：</p>
<ul>
<li>**W-timestamp(Q)**：成功执行写操作 write(Q) 的任意事务的最大时间戳。</li>
<li>**R-timestamp(Q)**：成功执行读操作 read(Q) 的任意事务的最大时间戳。</li>
</ul>
<p>当新的指令（read(Q) 或 write(Q)）执行时，时间戳会被更新。</p>
<hr>
<h4 id="时间戳协议"><a href="#时间戳协议" class="headerlink" title="时间戳协议"></a>时间戳协议</h4><p>时间戳排序协议确保：<strong>任何冲突的读写操作按照时间戳顺序执行</strong>。</p>
<p>假设事务 T<sub>i</sub> 执行一个<strong>读操作</strong> read(Q)：</p>
<ul>
<li><p>如果 TS(T<sub>i</sub>) &lt; W-timestamp(Q)，那么 T<sub>i</sub> 需要读取一个已被后续事务覆盖的数据值。因此，读操作会被拒绝，并且 T<sub>i</sub> 将被回滚。</p>
</li>
<li><p>如果 TS(T<sub>i</sub>) ≥ W-timestamp(Q)，则读操作会被执行，并且 R-timestamp(Q) 被设置为 R-timestamp(Q) 和 TS(T<sub>i</sub>) 中的最大值。</p>
</li>
</ul>
<p>假设事务 执行一个<strong>写操作</strong> write(Q)：</p>
<ul>
<li><p>如果 TS(T<sub>i</sub>) &lt; R-timestamp(Q)，则表示 T<sub>i</sub> 正想写一个已经被后续事务读取了的数据 Q 的值，但系统认为这个值不会再被产生。因此，写操作会被拒绝，并且 T<sub>i</sub> 将被回滚。</p>
</li>
<li><p>如果 TS(T<sub>i</sub>) &lt; W-timestamp(Q)，则表示 T<sub>i</sub> 尝试写入一个已经过时的 Q 的值。因此，这个写操作也会被拒绝，并且 T<sub>i</sub> 将被回滚。</p>
</li>
<li><p>否则，写操作会被执行，并且设置 W-timestamp(Q) &#x3D; TS(T<sub>i</sub>)。</p>
</li>
</ul>
<p>请注意：如果一个事务被回滚了，系统会重新给它分配一个时间戳，并重启它。</p>
<p>时间戳协议保证了所有事务按照时间戳的顺序执行完成。所以，<strong>在时间戳协议里，不会出现死锁</strong>。但是仍然可能出现饿死的情况：一系列短事务可能会不断的被重启，因为一些长事务一直在执行。</p>
<p><img src="/2024/06/13/%E6%95%B0%E6%8D%AE%E5%BA%932-%E5%B9%B6%E8%A1%8C%E6%8E%A7%E5%88%B6/time-stamp.png" alt="timestamp serializability"></p>
<hr>
<p>时间戳协议虽然避免了死锁的问题，但它<strong>不能避免级联</strong>，而且很可能<strong>不是可恢复的</strong>。</p>
<p>举例说明一下。假设事务 T<sub>i</sub> 中止（abort），但是事务 T<sub>j</sub> 已经读取了由 T<sub>i</sub> 写入的数据项：</p>
<ul>
<li>那么事务 T<sub>j</sub> 必须中止（abort）。如果允许 T<sub>j</sub> 先提交，那么该调度就不是可恢复的。</li>
<li>此外，任何已经读取了由 T<sub>j</sub> 写入的数据项的事务都必须中止（abort）。</li>
<li>这可能导致级联回滚，即一系列的事务被迫回滚。</li>
</ul>
<p>这个问题的核心在于：当数据项 Q 在“被事务 T<sub>j</sub> 写后”和“事务 T<sub>j</sub> 提交”之间的时间里，数据项 Q 并不是盖棺定论的，可能因事务 T<sub>j</sub> 的回滚而改变，但数据项 Q 又可能被其他事务读取。所以解决方法的核心也就是：让所有事务都等到数据盖棺定论的时候再读取。</p>
<p>常见解决方法有以下三种：</p>
<ul>
<li>在事务结束时一次性执行所有写操作。</li>
<li>延迟读取未提交数据项，直到更新该数据项的事务已提交为止。</li>
<li>跟踪未提交的写操作，只允许事务 T<sub>i</sub> 在读取的值都是由已提交事务写入后才能提交（即提交依赖）。</li>
</ul>
<hr>
<h4 id="Thomas-写规则"><a href="#Thomas-写规则" class="headerlink" title="Thomas 写规则"></a>Thomas 写规则</h4><p>在时间戳协议的基础上，我们可以进一步增强数据库系统的并行能力。</p>
<p>考虑下图中的例子：事务 T<sub>27 </sub> 因为 <code>write(Q)</code> 操作被迫回滚。但实际上，按照“事务 T<sub>27 </sub> 先执行，事务 T<sub>28</sub> 后执行”的顺序，事务 T<sub>27</sub> 的 <code>write(Q)</code> 操作实际上会被事务 T<sub>28</sub> 的 <code>write(Q)</code> 操作覆盖掉。也就是说：事务 T<sub>27</sub> 的 <code>write(Q)</code> 操作根本没必要执行，事务 T<sub>27</sub> 也不必回滚。</p>
<p><img src="/2024/06/13/%E6%95%B0%E6%8D%AE%E5%BA%932-%E5%B9%B6%E8%A1%8C%E6%8E%A7%E5%88%B6/example4.png" alt="example4"></p>
<p><strong>对于过时的写操作，我们进行忽略</strong>。于是有了 <strong>Thomas’ Write Rule</strong>。</p>
<p>假设事务 T<sub>i</sub> 发出写操作 write(Q)。</p>
<ol>
<li>如果 TS(T<sub>i</sub>) &lt; R-timestamp(Q)：则表示 T<sub>i</sub> 正在更新一个已经被后续事务读取了的 Q，而系统曾假定这个值不会再被产生。因此，系统拒绝写操作，并回滚事务 T<sub>i</sub>。（与原协议相同）</li>
<li>如果 TS(T<sub>i</sub>) &lt; W-timestamp(Q)：则表示 T<sub>i</sub> 尝试写入一个过时的 Q 的值。根据修改后的规则，这个写操作可以被忽略。<strong>（新规则）</strong></li>
<li>否则：系统执行写操作，并将 W-timestamp(Q) 设置为 TS(T<sub>i</sub>)。（与原协议相同）</li>
</ol>
<hr>
<h4 id="（视图）可序列化"><a href="#（视图）可序列化" class="headerlink" title="（视图）可序列化"></a>（视图）可序列化</h4><p>通过忽略过时的写操作，Thomas 的写入规则允许产生：<strong>不符合冲突可串行化但是正确的</strong>调度。这就促使我们定义一种新的可序列化：视图可串行化。</p>
<p>如果两个调度 S 和 S’ 包含相同的一组事务，并且满足以下三个条件，那么它们被称为<strong>视图等价</strong>。</p>
<blockquote>
<p>第1、2条件保证了相同的值和计算。第2、3个条件保证了相同的最终状态。</p>
</blockquote>
<ul>
<li><strong>对于每个数据项 Q</strong>，如果事务 T<sub>i</sub> 在调度 S 中读取了 Q 的初始值，则在调度 S’ 中，事务 T<sub>i</sub> 也必须读取 Q 的初始值。<strong>（确保读取相同的初始值）</strong></li>
<li><strong>对于每个数据项 Q</strong>，如果事务 T<sub>i</sub> 在调度 S 中执行了 read(Q) 操作，并且这个值是由事务 T<sub>j</sub> 执行的 write(Q) 操作产生的，则在调度 S’ 中，事务 T<sub>i</sub> 也必须读取到由同一个事务 T<sub>j</sub> 执行的 write(Q) 操作产生的值。<strong>（确保读取由同一事务写入的值）</strong></li>
<li><strong>对于每个数据项 Q</strong>，在调度 S 中执行最终的 write(Q) 操作的事务（如果有的话），在调度 S’ 中也必须执行最终的 write(Q) 操作。<strong>（确保执行相同的最终写操作）</strong></li>
</ul>
<p>如果它与某个串行调度视图等价，调度 S 是<strong>视图可串行化（View Serializable）</strong>的。</p>
<p><img src="/2024/06/13/%E6%95%B0%E6%8D%AE%E5%BA%932-%E5%B9%B6%E8%A1%8C%E6%8E%A7%E5%88%B6/view-serializability.png" alt="View Serializability"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://xht03.github.io/2024/06/09/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xht03">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="延绪的水上书">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/09/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C/" class="post-title-link" itemprop="url">Block Nested Loop Join</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-06-09 20:44:52" itemprop="dateCreated datePublished" datetime="2024-06-09T20:44:52+08:00">2024-06-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-06-10 17:30:30" itemprop="dateModified" datetime="2024-06-10T17:30:30+08:00">2024-06-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/The-Introduction-to-Database/" itemprop="url" rel="index"><span itemprop="name">The Introduction to Database</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2024/06/09/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2024/06/09/数据库实验/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>在数据库中，join 是经常使用的操作，但其工作量也可能是很大的。那么如何高效地完成 join 操作呢？</p>
<p>这篇 blog 将介绍：</p>
<ul>
<li>常见的 join 实现方式</li>
<li>如何在 Postgresql 源代码中实现 block nested loop join</li>
</ul>
<h3 id="常见-join-算法"><a href="#常见-join-算法" class="headerlink" title="常见 join 算法"></a>常见 join 算法</h3><h4 id="Simple-Nested-Loop-Join"><a href="#Simple-Nested-Loop-Join" class="headerlink" title="Simple Nested-Loop Join"></a>Simple Nested-Loop Join</h4><p>简单来说，Simple Nested-Loop Join 就是一个双层 for 循环 ，通过循环外层表的行数据，逐个与内层表的所有行数据进行比较来获取结果。</p>
<p>用伪代码描述大致如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (each tuple i in outer relation) &#123;</span><br><span class="line">	<span class="keyword">for</span> (each tuple j in inner relation) &#123;</span><br><span class="line">        <span class="keyword">if</span> (join_condition(tuple i, tuple j) is <span class="literal">true</span>)</span><br><span class="line">      		emit (tuple i, tuple j)</span><br><span class="line">       	<span class="keyword">else</span></span><br><span class="line">      		<span class="keyword">continue</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>特点：</strong></p>
<p>Nested-Loop Join 简单粗暴容易理解，就是通过双层循环比较数据来获得结果，但是这种算法显然太过于粗鲁，如果每个表有1万条数据，那么对数据比较的次数&#x3D;1万 * 1万 &#x3D; 1亿次，很显然这种查询效率会非常慢。</p>
<p>当然，数据库肯定不会这么粗暴地 join，所以就出现了后面的两种对Nested-Loop Join 优化算法。在执行 join 查询时，数据库会根据情况选择后面的两种 join 优化算法的进行join查询。</p>
<hr>
<h4 id="Index-Nested-Loop-Join"><a href="#Index-Nested-Loop-Join" class="headerlink" title="Index Nested-Loop Join"></a>Index Nested-Loop Join</h4><p>Index Nested-Loop Join 的优化思路主要是：减少内层表数据的匹配次数。</p>
<p>简单来说，Index Nested-Loop Join 就是通过外层表匹配条件，直接与内层表索引进行匹配，避免和内层表的每条记录去进行比较，这样极大的减少了对内层表的匹配次数，从原来的 “匹配次数&#x3D;外层表行数 * 内层表行数”，变成了 “外层表的行数 * 内层表索引的高度”，极大的提升了 join 的性能。</p>
<p><img src="/2024/06/09/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C/Index-Nested-Loop-Join.jpg" alt="Index Nested-Loop Join"></p>
<p><strong>但是</strong>，Index Nested-Loop Join 算法的前提是：匹配的字段必须建立了索引。</p>
<hr>
<h4 id="Block-Nested-Loop-join"><a href="#Block-Nested-Loop-join" class="headerlink" title="Block Nested-Loop join"></a>Block Nested-Loop join</h4><p>Block Nested-Loop Join 其优化思路是：减少内层表的扫表次数。</p>
<p>Block Nested-Loop Join 算法意在通过一次性缓存外层表的多条数据，以此来减少内层表的扫表次数，从而达到提升性能的目的。</p>
<p><img src="/2024/06/09/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C/Block-Nested-Loop-Join.jpg" alt="Block Nested-Loop Join"></p>
<p>如果无法使用 Index Nested-Loop Join 时候，一般都会使用 Block Nested-Loop Join 算法。</p>
<h3 id="PostgreSQL-实验"><a href="#PostgreSQL-实验" class="headerlink" title="PostgreSQL 实验"></a>PostgreSQL 实验</h3><h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><ol>
<li><p>下载 postgresql 源代码：</p>
<p><a target="_blank" rel="noopener" href="https://www.postgresql.org/ftp/source/v12.0/">https://www.postgresql.org/ftp/source/v12.0/</a></p>
</li>
<li><p>在本地编译并安装 postgresql：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换到源代码目录</span></span><br><span class="line"><span class="built_in">cd</span> postgresql-12.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化 make 配置</span></span><br><span class="line">/configure --enable-depend --enable-cassert --enable-debug CFLAGS=<span class="string">&quot;-O0&quot;</span> --prefix=<span class="variable">$HOME</span>/pgsql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编译</span></span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装(一般会安装到$HOME/pgsql)</span></span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化本地 postgresql 服务器：</p>
<blockquote>
<p>若你不幸把 pgsql 装到别的位置，把 <code>$HOME/pgsql</code> 替换成你安装的路径。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$HOME</span>/pgsql/bin/initdb -D <span class="variable">$HOME</span>/pgsql/data --locale=C</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动 postgresql 服务器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/[guanz]/pgsql/bin/pg_ctl -D /home/[guanz]/pgsql/data -l logfile start</span><br></pre></td></tr></table></figure>
</li>
<li><p>连接 postgresql 服务器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$HOME</span>/pgsql/bin/psql postgres</span><br></pre></td></tr></table></figure>
</li>
<li><p>关闭 postgresql 服务器：</p>
<blockquote>
<p>“Ctrl + D” 和 <code>\q</code> 均可以退出 postgresql 命令行。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This command depends on your installation location, please modify it</span></span><br><span class="line">/home/[guanz]/pgsql/bin/pg_ctl -D /home/[guanz]/pgsql/data stop</span><br></pre></td></tr></table></figure>
</li>
<li><p>加载测试数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">postgres<span class="operator">=</span># <span class="keyword">CREATE</span> DATABASE similarity;</span><br><span class="line">postgres<span class="operator">-</span># \c similarity</span><br><span class="line">postgres<span class="operator">-</span># \i <span class="operator">/</span>home<span class="operator">/</span>[guanz<span class="operator">/</span>data<span class="operator">/</span>]similarity_data.sql</span><br></pre></td></tr></table></figure>

<p><img src="/2024/06/09/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C/select.png" alt="select_example"></p>
</li>
</ol>
<hr>
<h4 id="源代码解读"><a href="#源代码解读" class="headerlink" title="源代码解读"></a>源代码解读</h4><p>虽然源代码很多，但我们只关注以下几个文件：</p>
<ul>
<li>src&#x2F;backend&#x2F;executor&#x2F;nodeNestloop.c</li>
<li>src&#x2F;include&#x2F;executor&#x2F;nodeNestloop.h</li>
<li>src&#x2F;include&#x2F;nodes&#x2F;execnodes.h</li>
</ul>
<p>Nested-Loop 主要算法都在 nodeNestloop.c 中实现：</p>
<blockquote>
<p>其中 ExecNestLoop() 是执行嵌套循环连接，其余两个  ExecInitNestLoop() 和 ExecEndNestLoop() 则分别完成初始化和终止。</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* xht03：</span></span><br><span class="line"><span class="comment">* ExecNestLoop 是迭代器函数，不是一次执行完所有循环，</span></span><br><span class="line"><span class="comment">* 而是每次循环时执行一次的函数</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">static</span> TupleTableSlot *</span><br><span class="line"><span class="title function_">ExecNestLoop</span><span class="params">(PlanState *pstate)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * xht03：</span></span><br><span class="line"><span class="comment">    * node 指的是查询计划树中的一个节点。</span></span><br><span class="line"><span class="comment">    * 在这段代码中，NestLoopState *node 是</span></span><br><span class="line"><span class="comment">    * 一个指向 NestLoopState 结构体的指针，</span></span><br><span class="line"><span class="comment">    * 这个结构体通常包含了执行Nested Loop Join 所需要的状态信息。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    NestLoopState *node = castNode(NestLoopState, pstate);</span><br><span class="line">	NestLoop   *nl;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * xht03：</span></span><br><span class="line"><span class="comment">    * Plan 指的是查询计划，</span></span><br><span class="line"><span class="comment">    * 它是数据库查询优化器生成的一种数据结构，</span></span><br><span class="line"><span class="comment">    * 用于描述如何执行一个SQL查询。</span></span><br><span class="line"><span class="comment">    * 查询计划是由一系列的操作步骤（或称为操作符）组成的树状结构，</span></span><br><span class="line"><span class="comment">    * 每一个操作步骤都对应查询计划树中的一个节点。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">	PlanState  *innerPlan;</span><br><span class="line">	PlanState  *outerPlan;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * xht03：</span></span><br><span class="line"><span class="comment">    * slot 意为“槽”</span></span><br><span class="line"><span class="comment">    * outerTupleSlot和innerTupleSlot是用来：</span></span><br><span class="line"><span class="comment">    * 存储从外部/内部关系（或称为左/右表）获取的当前元组</span></span><br><span class="line"><span class="comment">    */</span>  </span><br><span class="line">	TupleTableSlot *outerTupleSlot;</span><br><span class="line">	TupleTableSlot *innerTupleSlot;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 连接条件</span></span><br><span class="line">    <span class="comment">// 其他条件（比如：where后面跟的表达式）</span></span><br><span class="line">	ExprState  *joinqual;</span><br><span class="line">	ExprState  *otherqual;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 存储执行过程中的上下文</span></span><br><span class="line">	ExprContext *econtext;</span><br><span class="line">	ListCell   *lc;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">// 检查中断（不用管）</span></span><br><span class="line">	CHECK_FOR_INTERRUPTS();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * get information from the node</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ENL1_printf(<span class="string">&quot;getting info from node&quot;</span>);</span><br><span class="line"></span><br><span class="line">	nl = (NestLoop *) node-&gt;js.ps.plan;</span><br><span class="line">	joinqual = node-&gt;js.joinqual;</span><br><span class="line">	otherqual = node-&gt;js.ps.qual;</span><br><span class="line">	outerPlan = outerPlanState(node);	<span class="comment">// 记录外表所在的tuple</span></span><br><span class="line">	innerPlan = innerPlanState(node);	<span class="comment">// 记录内表所在的tuple</span></span><br><span class="line">	econtext = node-&gt;js.ps.ps_ExprContext;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Reset per-tuple memory context to free any expression evaluation</span></span><br><span class="line"><span class="comment">	 * storage allocated in the previous tuple cycle.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ResetExprContext(econtext);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Ok, everything is setup for the join so now loop until we return a</span></span><br><span class="line"><span class="comment">	 * qualifying join tuple.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ENL1_printf(<span class="string">&quot;entering main loop&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (;;)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * xht03:</span></span><br><span class="line"><span class="comment">		 * 当需要新的外部元组时，获取下一个的外部元组，</span></span><br><span class="line"><span class="comment">		 * 并让内表从头开始扫描（重置）</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (node-&gt;nl_NeedNewOuter)</span><br><span class="line">		&#123;</span><br><span class="line">			ENL1_printf(<span class="string">&quot;getting new outer tuple&quot;</span>);</span><br><span class="line">			outerTupleSlot = ExecProcNode(outerPlan);</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * xht03：</span></span><br><span class="line"><span class="comment">			 * 如果下一个外部元组为空，则 join 完成了</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (TupIsNull(outerTupleSlot))</span><br><span class="line">			&#123;</span><br><span class="line">				ENL1_printf(<span class="string">&quot;no outer tuple, ending join&quot;</span>);</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			ENL1_printf(<span class="string">&quot;saving new outer tuple information&quot;</span>);</span><br><span class="line">			econtext-&gt;ecxt_outertuple = outerTupleSlot;</span><br><span class="line">			node-&gt;nl_NeedNewOuter = <span class="literal">false</span>;</span><br><span class="line">			node-&gt;nl_MatchedOuter = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * fetch the values of any outer Vars that must be passed to the</span></span><br><span class="line"><span class="comment">			 * inner scan, and store them in the appropriate PARAM_EXEC slots.</span></span><br><span class="line"><span class="comment">			 *</span></span><br><span class="line"><span class="comment">			 * xht03：</span></span><br><span class="line"><span class="comment">			 * 传递一些参数，不用管，也不要改</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			foreach(lc, nl-&gt;nestParams)</span><br><span class="line">			&#123;</span><br><span class="line">				NestLoopParam *nlp = (NestLoopParam *) lfirst(lc);</span><br><span class="line">				<span class="type">int</span>			paramno = nlp-&gt;paramno;</span><br><span class="line">				ParamExecData *prm;</span><br><span class="line"></span><br><span class="line">				prm = &amp;(econtext-&gt;ecxt_param_exec_vals[paramno]);</span><br><span class="line">				<span class="comment">/* Param value should be an OUTER_VAR var */</span></span><br><span class="line">				Assert(IsA(nlp-&gt;paramval, Var));</span><br><span class="line">				Assert(nlp-&gt;paramval-&gt;varno == OUTER_VAR);</span><br><span class="line">				Assert(nlp-&gt;paramval-&gt;varattno &gt; <span class="number">0</span>);</span><br><span class="line">				prm-&gt;value = slot_getattr(outerTupleSlot,</span><br><span class="line">										  nlp-&gt;paramval-&gt;varattno,</span><br><span class="line">										  &amp;(prm-&gt;isnull));</span><br><span class="line">				<span class="comment">/* Flag parameter value as changed */</span></span><br><span class="line">				innerPlan-&gt;chgParam = bms_add_member(innerPlan-&gt;chgParam,</span><br><span class="line">													 paramno);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * now rescan the inner plan</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			ENL1_printf(<span class="string">&quot;rescanning inner plan&quot;</span>);</span><br><span class="line">			ExecReScan(innerPlan);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * we have an outerTuple, try to get the next inner tuple.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		ENL1_printf(<span class="string">&quot;getting new inner tuple&quot;</span>);</span><br><span class="line"></span><br><span class="line">		innerTupleSlot = ExecProcNode(innerPlan);</span><br><span class="line">		econtext-&gt;ecxt_innertuple = innerTupleSlot;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (TupIsNull(innerTupleSlot))</span><br><span class="line">		&#123;</span><br><span class="line">			ENL1_printf(<span class="string">&quot;no inner tuple, need new outer tuple&quot;</span>);</span><br><span class="line"></span><br><span class="line">			node-&gt;nl_NeedNewOuter = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!node-&gt;nl_MatchedOuter &amp;&amp;</span><br><span class="line">				(node-&gt;js.jointype == JOIN_LEFT ||</span><br><span class="line">				 node-&gt;js.jointype == JOIN_ANTI))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">/*</span></span><br><span class="line"><span class="comment">				 * We are doing an outer join and there were no join matches</span></span><br><span class="line"><span class="comment">				 * for this outer tuple.  Generate a fake join tuple with</span></span><br><span class="line"><span class="comment">				 * nulls for the inner tuple, and return it if it passes the</span></span><br><span class="line"><span class="comment">				 * non-join quals.</span></span><br><span class="line"><span class="comment">				 * </span></span><br><span class="line"><span class="comment">				 * xht03：</span></span><br><span class="line"><span class="comment">				 * 你可能也发现了：外部元组和内部元组的值，除了会存进 outerTupleSlot</span></span><br><span class="line"><span class="comment">				 * 和 innerTupleSlot，还要存进上下文 econtext 里。</span></span><br><span class="line"><span class="comment">				 * 这是因为：ExecQual() 判断是否满足等式条件的函数，是使用上下文中</span></span><br><span class="line"><span class="comment">				 * 存储的内外部元组信息进行判断的。</span></span><br><span class="line"><span class="comment">				 * 这样的函数还有很多，所以一定要记得更新上下文</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">				econtext-&gt;ecxt_innertuple = node-&gt;nl_NullInnerTupleSlot;</span><br><span class="line"></span><br><span class="line">				ENL1_printf(<span class="string">&quot;testing qualification for outer-join tuple&quot;</span>);</span><br><span class="line">				</span><br><span class="line">				<span class="keyword">if</span> (otherqual == <span class="literal">NULL</span> || ExecQual(otherqual, econtext))</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">/*</span></span><br><span class="line"><span class="comment">					 * qualification was satisfied so we project and return</span></span><br><span class="line"><span class="comment">					 * the slot containing the result tuple using</span></span><br><span class="line"><span class="comment">					 * ExecProject().</span></span><br><span class="line"><span class="comment">					 */</span></span><br><span class="line">					ENL1_printf(<span class="string">&quot;qualification succeeded, projecting tuple&quot;</span>);</span><br><span class="line">					<span class="keyword">return</span> ExecProject(node-&gt;js.ps.ps_ProjInfo);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">					InstrCountFiltered2(node, <span class="number">1</span>);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Otherwise just return to top of loop for a new outer tuple.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * at this point we have a new pair of inner and outer tuples so we</span></span><br><span class="line"><span class="comment">		 * test the inner and outer tuples to see if they satisfy the node&#x27;s</span></span><br><span class="line"><span class="comment">		 * qualification.</span></span><br><span class="line"><span class="comment">		 *</span></span><br><span class="line"><span class="comment">		 * Only the joinquals determine MatchedOuter status, but all quals</span></span><br><span class="line"><span class="comment">		 * must pass to actually return the tuple.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		ENL1_printf(<span class="string">&quot;testing qualification&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (ExecQual(joinqual, econtext))</span><br><span class="line">		&#123;</span><br><span class="line">			node-&gt;nl_MatchedOuter = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* In an antijoin, we never return a matched tuple */</span></span><br><span class="line">			<span class="keyword">if</span> (node-&gt;js.jointype == JOIN_ANTI)</span><br><span class="line">			&#123;</span><br><span class="line">				node-&gt;nl_NeedNewOuter = <span class="literal">true</span>;</span><br><span class="line">				<span class="keyword">continue</span>;		<span class="comment">/* return to top of loop */</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * If we only need to join to the first matching inner tuple, then</span></span><br><span class="line"><span class="comment">			 * consider returning this one, but after that continue with next</span></span><br><span class="line"><span class="comment">			 * outer tuple.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">if</span> (node-&gt;js.single_match)</span><br><span class="line">				node-&gt;nl_NeedNewOuter = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (otherqual == <span class="literal">NULL</span> || ExecQual(otherqual, econtext))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">/*</span></span><br><span class="line"><span class="comment">				 * qualification was satisfied so we project and return the</span></span><br><span class="line"><span class="comment">				 * slot containing the result tuple using ExecProject().</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">				ENL1_printf(<span class="string">&quot;qualification succeeded, projecting tuple&quot;</span>);</span><br><span class="line"></span><br><span class="line">				<span class="keyword">return</span> ExecProject(node-&gt;js.ps.ps_ProjInfo);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				InstrCountFiltered2(node, <span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			InstrCountFiltered1(node, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Tuple fails qual, so free per-tuple memory and try again.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		ResetExprContext(econtext);</span><br><span class="line"></span><br><span class="line">		ENL1_printf(<span class="string">&quot;qualification failed, looping&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ----------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> *		ExecInitNestLoop</span></span><br><span class="line"><span class="comment"> * ----------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">NestLoopState *</span><br><span class="line"><span class="title function_">ExecInitNestLoop</span><span class="params">(NestLoop *node, EState *estate, <span class="type">int</span> eflags)</span></span><br><span class="line">&#123;</span><br><span class="line">	NestLoopState *nlstate;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* check for unsupported flags */</span></span><br><span class="line">	Assert(!(eflags &amp; (EXEC_FLAG_BACKWARD | EXEC_FLAG_MARK)));</span><br><span class="line"></span><br><span class="line">	NL1_printf(<span class="string">&quot;ExecInitNestLoop: %s\n&quot;</span>,</span><br><span class="line">			   <span class="string">&quot;initializing node&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * create state structure</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	nlstate = makeNode(NestLoopState);</span><br><span class="line">	nlstate-&gt;js.ps.plan = (Plan *) node;</span><br><span class="line">	nlstate-&gt;js.ps.state = estate;</span><br><span class="line">	nlstate-&gt;js.ps.ExecProcNode = ExecNestLoop;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Miscellaneous initialization</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * create expression context for node</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ExecAssignExprContext(estate, &amp;nlstate-&gt;js.ps);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * initialize child nodes</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * If we have no parameters to pass into the inner rel from the outer,</span></span><br><span class="line"><span class="comment">	 * tell the inner child that cheap rescans would be good.  If we do have</span></span><br><span class="line"><span class="comment">	 * such parameters, then there is no point in REWIND support at all in the</span></span><br><span class="line"><span class="comment">	 * inner child, because it will always be rescanned with fresh parameter</span></span><br><span class="line"><span class="comment">	 * values.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	outerPlanState(nlstate) = ExecInitNode(outerPlan(node), estate, eflags);</span><br><span class="line">	<span class="keyword">if</span> (node-&gt;nestParams == NIL)</span><br><span class="line">		eflags |= EXEC_FLAG_REWIND;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		eflags &amp;= ~EXEC_FLAG_REWIND;</span><br><span class="line">	innerPlanState(nlstate) = ExecInitNode(innerPlan(node), estate, eflags);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Initialize result slot, type and projection.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ExecInitResultTupleSlotTL(&amp;nlstate-&gt;js.ps, &amp;TTSOpsVirtual);</span><br><span class="line">	ExecAssignProjectionInfo(&amp;nlstate-&gt;js.ps, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * initialize child expressions</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	nlstate-&gt;js.ps.qual =</span><br><span class="line">		ExecInitQual(node-&gt;join.plan.qual, (PlanState *) nlstate);</span><br><span class="line">	nlstate-&gt;js.jointype = node-&gt;join.jointype;</span><br><span class="line">	nlstate-&gt;js.joinqual =</span><br><span class="line">		ExecInitQual(node-&gt;join.joinqual, (PlanState *) nlstate);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * detect whether we need only consider the first matching inner tuple</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	nlstate-&gt;js.single_match = (node-&gt;join.inner_unique ||</span><br><span class="line">								node-&gt;join.jointype == JOIN_SEMI);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* set up null tuples for outer joins, if needed */</span></span><br><span class="line">	<span class="keyword">switch</span> (node-&gt;join.jointype)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> JOIN_INNER:</span><br><span class="line">		<span class="keyword">case</span> JOIN_SEMI:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> JOIN_LEFT:</span><br><span class="line">		<span class="keyword">case</span> JOIN_ANTI:</span><br><span class="line">			nlstate-&gt;nl_NullInnerTupleSlot =</span><br><span class="line">				ExecInitNullTupleSlot(estate,</span><br><span class="line">									  ExecGetResultType(innerPlanState(nlstate)),</span><br><span class="line">									  &amp;TTSOpsVirtual);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			elog(ERROR, <span class="string">&quot;unrecognized join type: %d&quot;</span>,</span><br><span class="line">				 (<span class="type">int</span>) node-&gt;join.jointype);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * finally, wipe the current outer tuple clean.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	nlstate-&gt;nl_NeedNewOuter = <span class="literal">true</span>;</span><br><span class="line">	nlstate-&gt;nl_MatchedOuter = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	NL1_printf(<span class="string">&quot;ExecInitNestLoop: %s\n&quot;</span>,</span><br><span class="line">			   <span class="string">&quot;node initialized&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> nlstate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ----------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> *		ExecEndNestLoop</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *		closes down scans and frees allocated storage</span></span><br><span class="line"><span class="comment"> * ----------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">ExecEndNestLoop</span><span class="params">(NestLoopState *node)</span></span><br><span class="line">&#123;</span><br><span class="line">	NL1_printf(<span class="string">&quot;ExecEndNestLoop: %s\n&quot;</span>,</span><br><span class="line">			   <span class="string">&quot;ending node processing&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Free the exprcontext</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ExecFreeExprContext(&amp;node-&gt;js.ps);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * clean out the tuple table</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ExecClearTuple(node-&gt;js.ps.ps_ResultTupleSlot);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * close down subplans</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ExecEndNode(outerPlanState(node));</span><br><span class="line">	ExecEndNode(innerPlanState(node));</span><br><span class="line"></span><br><span class="line">	NL1_printf(<span class="string">&quot;ExecEndNestLoop: %s\n&quot;</span>,</span><br><span class="line">			   <span class="string">&quot;node processing ended&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ----------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> *		ExecReScanNestLoop</span></span><br><span class="line"><span class="comment"> * ----------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">ExecReScanNestLoop</span><span class="params">(NestLoopState *node)</span></span><br><span class="line">&#123;</span><br><span class="line">	PlanState  *outerPlan = outerPlanState(node);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If outerPlan-&gt;chgParam is not null then plan will be automatically</span></span><br><span class="line"><span class="comment">	 * re-scanned by first ExecProcNode.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (outerPlan-&gt;chgParam == <span class="literal">NULL</span>)</span><br><span class="line">		ExecReScan(outerPlan);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * innerPlan is re-scanned for each new outer tuple and MUST NOT be</span></span><br><span class="line"><span class="comment">	 * re-scanned from here or you&#x27;ll get troubles from inner index scans when</span></span><br><span class="line"><span class="comment">	 * outer Vars are used as run-time keys...</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"></span><br><span class="line">	node-&gt;nl_NeedNewOuter = <span class="literal">true</span>;</span><br><span class="line">	node-&gt;nl_MatchedOuter = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<h4 id="源代码修改"><a href="#源代码修改" class="headerlink" title="源代码修改"></a>源代码修改</h4><p>我们主要做了一下修改：</p>
<ul>
<li>新增了结构体类型 <strong>NestedBlock</strong> ，用于存放中间缓存的外部元组。</li>
</ul>
<p>与之相应地：</p>
<ul>
<li>增加了 <strong>GetNestedBlock()</strong> 函数，用于获取新的中间元组。</li>
<li>在上下文类型 <strong>ExprContext</strong> 中增加 <strong>NestedBlock</strong> 变量，将中间缓存元组记录在上下文中。</li>
<li>修改 <strong>ExecNestLoop()</strong> 函数：外部元组一次取出至多 <strong>NESTED_BLOCK_SIZE</strong> 个元组放入缓存 <strong>NestedBlock</strong> 中，并照旧扫描内部元组。但每次需要将缓存中的所有 outer tuple 一一与 inner tuple 进行比较，且外部元组的指针需要往后移动 <strong>NESTED_BLOCK_SIZE</strong> 个元组。</li>
</ul>
<p>修改细节如下（修改之处都加有 <em>xht03</em> 注释）：</p>
<blockquote>
<p>execnodes.h</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// xht03</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NESTED_BLOCK_SIZE 64</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">NestedBlock</span>&#123;</span></span><br><span class="line">    TupleTableSlot *tuple[NESTED_BLOCK_SIZE];	<span class="comment">// 存放外部元组</span></span><br><span class="line">	<span class="type">bool</span> isMatched[NESTED_BLOCK_SIZE];			<span class="comment">// 是否在内部关系中匹配到过</span></span><br><span class="line">    <span class="type">int</span> size;									<span class="comment">// 缓存中的元组个数</span></span><br><span class="line">&#125; NestedBlock;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ExprContext</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	NodeTag		type;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Tuples that Var nodes in expression may refer to */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIELDNO_EXPRCONTEXT_SCANTUPLE 1</span></span><br><span class="line">	TupleTableSlot *ecxt_scantuple;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIELDNO_EXPRCONTEXT_INNERTUPLE 2</span></span><br><span class="line">	TupleTableSlot *ecxt_innertuple;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIELDNO_EXPRCONTEXT_OUTERTUPLE 3</span></span><br><span class="line">	TupleTableSlot *ecxt_outertuple;</span><br><span class="line"></span><br><span class="line"><span class="comment">// xht03</span></span><br><span class="line">	NestedBlock *ecxt_block;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Memory contexts for expression evaluation --- see notes above */</span></span><br><span class="line">	MemoryContext ecxt_per_query_memory;</span><br><span class="line">	MemoryContext ecxt_per_tuple_memory;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Values to substitute for Param nodes in expression */</span></span><br><span class="line">	ParamExecData *ecxt_param_exec_vals;	<span class="comment">/* for PARAM_EXEC params */</span></span><br><span class="line">	ParamListInfo ecxt_param_list_info; <span class="comment">/* for other param types */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Values to substitute for Aggref nodes in the expressions of an Agg</span></span><br><span class="line"><span class="comment">	 * node, or for WindowFunc nodes within a WindowAgg node.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIELDNO_EXPRCONTEXT_AGGVALUES 8</span></span><br><span class="line">	Datum	   *ecxt_aggvalues; <span class="comment">/* precomputed values for aggs/windowfuncs */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIELDNO_EXPRCONTEXT_AGGNULLS 9</span></span><br><span class="line">	<span class="type">bool</span>	   *ecxt_aggnulls;	<span class="comment">/* null flags for aggs/windowfuncs */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Value to substitute for CaseTestExpr nodes in expression */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIELDNO_EXPRCONTEXT_CASEDATUM 10</span></span><br><span class="line">	Datum		caseValue_datum;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIELDNO_EXPRCONTEXT_CASENULL 11</span></span><br><span class="line">	<span class="type">bool</span>		caseValue_isNull;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Value to substitute for CoerceToDomainValue nodes in expression */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIELDNO_EXPRCONTEXT_DOMAINDATUM 12</span></span><br><span class="line">	Datum		domainValue_datum;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FIELDNO_EXPRCONTEXT_DOMAINNULL 13</span></span><br><span class="line">	<span class="type">bool</span>		domainValue_isNull;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Link to containing EState (NULL if a standalone ExprContext) */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">EState</span> *<span class="title">ecxt_estate</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Functions to call back when ExprContext is shut down or rescanned */</span></span><br><span class="line">	ExprContext_CB *ecxt_callbacks;</span><br><span class="line">&#125; ExprContext;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>nodeNestloop.h</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> NODENESTLOOP_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NODENESTLOOP_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;nodes/execnodes.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// xht03</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> *<span class="title function_">GetNestedBlock</span><span class="params">(NestedBlock *block, PlanState *outerPlan)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> NestLoopState *<span class="title function_">ExecInitNestLoop</span><span class="params">(NestLoop *node, EState *estate, <span class="type">int</span> eflags)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">ExecEndNestLoop</span><span class="params">(NestLoopState *node)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">ExecReScanNestLoop</span><span class="params">(NestLoopState *node)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>							<span class="comment">/* NODENESTLOOP_H */</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>nodeNestloop.c</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// xht03</span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">GetNestedBlock</span><span class="params">(NestedBlock *block, PlanState *outerPlan)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; NESTED_BLOCK_SIZE; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        block-&gt;tuple[i] = ExecProcNode(outerPlan);</span><br><span class="line">		block-&gt;isMatched[i] = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(TupIsNull(block-&gt;tuple[i]))</span><br><span class="line">        &#123;</span><br><span class="line">            block-&gt;size = i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> TupleTableSlot *</span><br><span class="line"><span class="title function_">ExecNestLoop</span><span class="params">(PlanState *pstate)</span>	</span><br><span class="line">&#123;</span><br><span class="line">	NestLoopState *node = castNode(NestLoopState, pstate);</span><br><span class="line">	NestLoop   *nl;</span><br><span class="line">	PlanState  *innerPlan;</span><br><span class="line">	PlanState  *outerPlan;</span><br><span class="line">	TupleTableSlot *outerTupleSlot;</span><br><span class="line">	TupleTableSlot *innerTupleSlot;</span><br><span class="line">	ExprState  *joinqual;</span><br><span class="line">	ExprState  *otherqual;</span><br><span class="line">	ExprContext *econtext;</span><br><span class="line">	ListCell   *lc;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// xht03</span></span><br><span class="line">	NestedBlock block;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	CHECK_FOR_INTERRUPTS();	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * get information from the node</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ENL1_printf(<span class="string">&quot;getting info from node&quot;</span>);</span><br><span class="line"></span><br><span class="line">	nl = (NestLoop *) node-&gt;js.ps.plan;</span><br><span class="line">	joinqual = node-&gt;js.joinqual;</span><br><span class="line">	otherqual = node-&gt;js.ps.qual;</span><br><span class="line">	outerPlan = outerPlanState(node);</span><br><span class="line">	innerPlan = innerPlanState(node);</span><br><span class="line">	econtext = node-&gt;js.ps.ps_ExprContext;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Reset per-tuple memory context to free any expression evaluation</span></span><br><span class="line"><span class="comment">	 * storage allocated in the previous tuple cycle.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ResetExprContext(econtext);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Ok, everything is setup for the join so now loop until we return a</span></span><br><span class="line"><span class="comment">	 * qualifying join tuple.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ENL1_printf(<span class="string">&quot;entering main loop&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (;;)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * If we don&#x27;t have an outer tuple, get the next one and reset the</span></span><br><span class="line"><span class="comment">		 * inner scan.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (node-&gt;nl_NeedNewOuter)</span><br><span class="line">		&#123;</span><br><span class="line">			ENL1_printf(<span class="string">&quot;getting new outer tuple&quot;</span>);</span><br><span class="line">			<span class="comment">// xht03</span></span><br><span class="line">			GetNestedBlock(&amp;block, outerPlan);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 	 * if there are no more outer tuples, then the join is complete..</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="comment">// xht03</span></span><br><span class="line">			<span class="keyword">if</span> (block.size == <span class="number">0</span>)</span><br><span class="line">			&#123;</span><br><span class="line">				ENL1_printf(<span class="string">&quot;no outer tuple, ending join&quot;</span>);</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			ENL1_printf(<span class="string">&quot;saving new outer tuple information&quot;</span>);</span><br><span class="line">			<span class="comment">//econtext-&gt;ecxt_outertuple = outerTupleSlot;	// 记录外表所在的tuple，更新上下文</span></span><br><span class="line">			</span><br><span class="line">			<span class="comment">// xht03</span></span><br><span class="line">			outerTupleSlot = block.tuple[block.size - <span class="number">1</span>];</span><br><span class="line">			econtext-&gt;ecxt_outertuple = outerTupleSlot;</span><br><span class="line">			econtext-&gt;ecxt_block = &amp;block;</span><br><span class="line">			node-&gt;nl_NeedNewOuter = <span class="literal">false</span>;</span><br><span class="line">			node-&gt;nl_MatchedOuter = <span class="literal">false</span>;</span><br><span class="line">            </span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * fetch the values of any outer Vars that must be passed to the</span></span><br><span class="line"><span class="comment">			 * inner scan, and store them in the appropriate PARAM_EXEC slots.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">            <span class="comment">// 将外表的一些参数传递给内表</span></span><br><span class="line">			foreach(lc, nl-&gt;nestParams)</span><br><span class="line">			&#123;</span><br><span class="line">				NestLoopParam *nlp = (NestLoopParam *) lfirst(lc);</span><br><span class="line">				<span class="type">int</span>			paramno = nlp-&gt;paramno;</span><br><span class="line">				ParamExecData *prm;</span><br><span class="line">				prm = &amp;(econtext-&gt;ecxt_param_exec_vals[paramno]);</span><br><span class="line">				<span class="comment">/* Param value should be an OUTER_VAR var */</span></span><br><span class="line">				Assert(IsA(nlp-&gt;paramval, Var));</span><br><span class="line">				Assert(nlp-&gt;paramval-&gt;varno == OUTER_VAR);</span><br><span class="line">				Assert(nlp-&gt;paramval-&gt;varattno &gt; <span class="number">0</span>);</span><br><span class="line">				prm-&gt;value = slot_getattr(outerTupleSlot,</span><br><span class="line">										  nlp-&gt;paramval-&gt;varattno,</span><br><span class="line">										  &amp;(prm-&gt;isnull));</span><br><span class="line">				<span class="comment">/* Flag parameter value as changed */</span></span><br><span class="line">				innerPlan-&gt;chgParam = bms_add_member(innerPlan-&gt;chgParam,</span><br><span class="line">													 paramno);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * now rescan the inner plan</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">            <span class="comment">// 重新确定内表从哪里开始扫描</span></span><br><span class="line">			ENL1_printf(<span class="string">&quot;rescanning inner plan&quot;</span>);</span><br><span class="line">			ExecReScan(innerPlan);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * we have an outerTuple, try to get the next inner tuple.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		ENL1_printf(<span class="string">&quot;getting new inner tuple&quot;</span>);</span><br><span class="line">		innerTupleSlot = ExecProcNode(innerPlan);		<span class="comment">// 获取新的内部节点（tuple）</span></span><br><span class="line">		econtext-&gt;ecxt_innertuple = innerTupleSlot;		<span class="comment">// 记录内表所在的tuple，更新上下文</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (TupIsNull(innerTupleSlot))</span><br><span class="line">		&#123;</span><br><span class="line">			ENL1_printf(<span class="string">&quot;no inner tuple, need new outer tuple&quot;</span>);</span><br><span class="line">			node-&gt;nl_NeedNewOuter = <span class="literal">true</span>;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			* xht03:</span></span><br><span class="line"><span class="comment">			* If not all the tuples in the block have been matched,</span></span><br><span class="line"><span class="comment">			* or the join type is left-join or anti-join</span></span><br><span class="line"><span class="comment">			*/</span></span><br><span class="line">			<span class="keyword">if</span> (!node-&gt;nl_MatchedOuter &amp;&amp;</span><br><span class="line">				(node-&gt;js.jointype == JOIN_LEFT ||</span><br><span class="line">				 node-&gt;js.jointype == JOIN_ANTI))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">/*</span></span><br><span class="line"><span class="comment">				 * We are doing an outer join and there were no join matches</span></span><br><span class="line"><span class="comment">				 * for this outer tuple.  Generate a fake join tuple with</span></span><br><span class="line"><span class="comment">				 * nulls for the inner tuple, and return it if it passes the</span></span><br><span class="line"><span class="comment">				 * non-join quals.</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line"></span><br><span class="line">				<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; block.size; i++)&#123;</span><br><span class="line">					econtext-&gt;ecxt_outertuple = block.tuple[i];</span><br><span class="line">					<span class="keyword">if</span>(!block.isMatched[i])&#123;</span><br><span class="line">                        <span class="comment">// set to a empty tuple</span></span><br><span class="line">						econtext-&gt;ecxt_innertuple = node-&gt;nl_NullInnerTupleSlot;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// 检查非连接条件（non-join quals）的其他条件是否满足</span></span><br><span class="line">						ENL1_printf(<span class="string">&quot;testing qualification for outer-join tuple&quot;</span>);</span><br><span class="line">						<span class="keyword">if</span> (otherqual == <span class="literal">NULL</span> || ExecQual(otherqual, econtext))</span><br><span class="line">						&#123;</span><br><span class="line">							<span class="comment">/*</span></span><br><span class="line"><span class="comment">						 	* qualification was satisfied so we project and return</span></span><br><span class="line"><span class="comment">						 	* the slot containing the result tuple using</span></span><br><span class="line"><span class="comment">						 	* ExecProject().</span></span><br><span class="line"><span class="comment">						 	*/</span></span><br><span class="line">							ENL1_printf(<span class="string">&quot;qualification succeeded, projecting tuple&quot;</span>);</span><br><span class="line">							<span class="keyword">return</span> ExecProject(node-&gt;js.ps.ps_ProjInfo);</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">else</span></span><br><span class="line">							InstrCountFiltered2(node, <span class="number">1</span>);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Otherwise just return to top of loop for a new outer tuple.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * at this point we have a new pair of inner and outer tuples so we</span></span><br><span class="line"><span class="comment">		 * test the inner and outer tuples to see if they satisfy the node&#x27;s</span></span><br><span class="line"><span class="comment">		 * qualification.</span></span><br><span class="line"><span class="comment">		 *</span></span><br><span class="line"><span class="comment">		 * Only the joinquals determine MatchedOuter status, but all quals</span></span><br><span class="line"><span class="comment">		 * must pass to actually return the tuple.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		ENL1_printf(<span class="string">&quot;testing qualification&quot;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 测试是否满足 join 条件</span></span><br><span class="line">		<span class="comment">// xht03</span></span><br><span class="line">		<span class="type">int</span> matched_num = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; block.size; i++)&#123;</span><br><span class="line">			econtext-&gt;ecxt_outertuple = block.tuple[i];</span><br><span class="line">			<span class="keyword">if</span> (ExecQual(joinqual, econtext))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="comment">//xht03</span></span><br><span class="line">				<span class="keyword">if</span>(!block.isMatched[i])&#123;</span><br><span class="line">					matched_num++;</span><br><span class="line">					block.isMatched[i] = <span class="literal">true</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">/*</span></span><br><span class="line"><span class="comment">				* If we only need to join to the first matching inner tuple, then</span></span><br><span class="line"><span class="comment">				* consider returning this one, but after that continue with next</span></span><br><span class="line"><span class="comment">				* outer tuple.</span></span><br><span class="line"><span class="comment">				*/</span></span><br><span class="line">			</span><br><span class="line">				<span class="keyword">if</span> (otherqual == <span class="literal">NULL</span> || ExecQual(otherqual, econtext))</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="comment">/*</span></span><br><span class="line"><span class="comment">					* qualification was satisfied so we project and return the</span></span><br><span class="line"><span class="comment">					* slot containing the result tuple using ExecProject().</span></span><br><span class="line"><span class="comment">					*/</span></span><br><span class="line">					ENL1_printf(<span class="string">&quot;qualification succeeded, projecting tuple&quot;</span>);</span><br><span class="line">					<span class="keyword">return</span> ExecProject(node-&gt;js.ps.ps_ProjInfo);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">					InstrCountFiltered2(node, <span class="number">1</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				InstrCountFiltered1(node, <span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		* xht03:</span></span><br><span class="line"><span class="comment">		* If all tuples in the block have been matched</span></span><br><span class="line"><span class="comment">		*/</span></span><br><span class="line">		<span class="keyword">if</span>(matched_num == block.size)</span><br><span class="line">		&#123;</span><br><span class="line">			node-&gt;nl_MatchedOuter = <span class="literal">true</span>;</span><br><span class="line">			<span class="comment">/* In an antijoin, we never return a matched tuple */</span></span><br><span class="line">			<span class="keyword">if</span> (node-&gt;js.jointype == JOIN_ANTI || node-&gt;js.single_match)</span><br><span class="line">			&#123;</span><br><span class="line">				node-&gt;nl_NeedNewOuter = <span class="literal">true</span>;</span><br><span class="line">			&#125;	</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">			</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Tuple fails qual, so free per-tuple memory and try again.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		ResetExprContext(econtext);</span><br><span class="line">		ENL1_printf(<span class="string">&quot;qualification failed, looping&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<h4 id="源代码测试"><a href="#源代码测试" class="headerlink" title="源代码测试"></a>源代码测试</h4><p>重新编译并安装 postgresql 后，设置 NESTED_BLOCK_SIZE &#x3D; 1、2、8、64、128、1024，运行下面语句两次，取第二次运行时间。</p>
<blockquote>
<p>在数据库命令行中输入：<code>\timing</code>，打开测时间功能。</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">FROM</span> restaurantaddress ra, restaurantphone rp <span class="keyword">WHERE</span> ra.name <span class="operator">=</span> rp.name;</span><br></pre></td></tr></table></figure>

<p><img src="/2024/06/09/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AE%9E%E9%AA%8C/1024.png" alt="Timing"></p>
<table>
<thead>
<tr>
<th align="center">NESTED_BLOCK_SIZE</th>
<th align="center">时间1&#x2F;ms</th>
<th align="center">时间2&#x2F;ms</th>
<th align="center">时间3&#x2F;ms</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">2.710</td>
<td align="center">2.559</td>
<td align="center">2.565</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">2.579</td>
<td align="center">2.753</td>
<td align="center">2.636</td>
</tr>
<tr>
<td align="center">8</td>
<td align="center">2.337</td>
<td align="center">2.483</td>
<td align="center">2.716</td>
</tr>
<tr>
<td align="center">64</td>
<td align="center">2.277</td>
<td align="center">2.441</td>
<td align="center">1.896</td>
</tr>
<tr>
<td align="center">128</td>
<td align="center">2.657</td>
<td align="center">2.543</td>
<td align="center">2.464</td>
</tr>
<tr>
<td align="center">1024</td>
<td align="center">2.871</td>
<td align="center">2.743</td>
<td align="center">2.778</td>
</tr>
</tbody></table>
<p>这样的实验结果是符合预期的：</p>
<ul>
<li><strong>NESTED_BLOCK_SIZE</strong> 太小时，与 Simple Nested-Loop 相近；当 <strong>NESTED_BLOCK_SIZE</strong> 太大时，就相当于内外表互换后的 Simple Nested-Loop。所以当 <strong>NESTED_BLOCK_SIZE</strong> 取一个大小适中的值时，Block Nested-Loop 才能性能最大化。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://xht03.github.io/2024/06/06/%E6%95%B0%E6%8D%AE%E5%BA%931-%E4%BA%8B%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xht03">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="延绪的水上书">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/06/%E6%95%B0%E6%8D%AE%E5%BA%931-%E4%BA%8B%E5%8A%A1/" class="post-title-link" itemprop="url">数据库笔记1：Transaction</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-06-06 19:05:36" itemprop="dateCreated datePublished" datetime="2024-06-06T19:05:36+08:00">2024-06-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-06-21 21:32:01" itemprop="dateModified" datetime="2024-06-21T21:32:01+08:00">2024-06-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/The-Introduction-to-Database/" itemprop="url" rel="index"><span itemprop="name">The Introduction to Database</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2024/06/06/%E6%95%B0%E6%8D%AE%E5%BA%931-%E4%BA%8B%E5%8A%A1/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2024/06/06/数据库1-事务/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><p>在实际场景中，数据库并不是完全可靠的。数据库可能在执行某些操作时崩了，导致一系列操作戛然而止。但有很多操作是必须一起执行的，比如银行转账，不能只执行从A账户扣钱，但不继续执行向B账户里加钱，这样会破坏数据一致性。</p>
<p>为了保证数据库在出现故障时，仍能保证数据的正确，我们引入了“事务”。</p>
<h3 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h3><blockquote>
<p>A transaction is a unit of program execution that  accesses and possibly updates various data items.</p>
</blockquote>
<p>总的来说，<strong>事务（transaction）</strong>是一种机制，用来确保多个操作（如读取和写入数据）要么全部成功，要么全部失败，从而保持数据的一致性和完整性。事务中的所有操作作为一个整体，要么全部完成（提交），要么全部撤销（回滚），因此保证了数据在任何情况下都是一致的。</p>
<hr>
<h4 id="ACID性质"><a href="#ACID性质" class="headerlink" title="ACID性质"></a>ACID性质</h4><p>在数据库系统中，Transaction需要保持一下四个性质（ACID properties）：</p>
<ul>
<li><strong>原子性（Atomicity）</strong>：事务中的操作，要么全部执行，要么全部没执行。</li>
<li><strong>一致性（Consistency）</strong></li>
<li><strong>隔离性（Isolation）</strong></li>
<li><strong>永久性（Durability）</strong>：事务成功完成后，即使系统出现故障，它对数据库所做的更改也会持久存在。</li>
</ul>
<p>通俗地讲，一致性是指，在仅当前事务执行时（没有事务并发执行），<strong>数据库中的某些不变量要保持一致</strong>。比如银行转账时两个账户的余额之和要保持不变。（英文释义：If a transaction is run atomically in isolation starting  from a consistent database, the database must again be  consistent at the end of the transaction. ）</p>
<p>但是，像银行转账，先从A账户扣钱，再向B账户里转钱，必然有处于不一致状态的时候。执行一个事务时也是如此。我们必须保证：<strong>不一致状态是不可见的</strong>。这也是为什么要保证原子性——要么全做完，要么回退到全部没做，不能位于中间不一致状态。</p>
<p><img src="/2024/06/06/%E6%95%B0%E6%8D%AE%E5%BA%931-%E4%BA%8B%E5%8A%A1/consistent.png" alt="consistency"></p>
<p>原子性一般这样实现：数据库会记录一个事务对任何数据进行写操作前的旧值。 这些信息被写入一个称为<strong>日志（log）</strong>的文件中。如果事务没有完成其执行，数据库系统会从日志中恢复旧值，使其看起来像事务从未执行过一样。而且日志记录需要发生在事务开始修改数据库之前（log records need to be written to stable storage before any  changes are made to the database on disk.）</p>
<p>诚然，事务序列运行（serially）是更容易实现的，但多个事务的并发运行能显著地提升性能，就像“一个人干活 Vs 一群人同时干活”：</p>
<ul>
<li>提升吞吐量和资源利用</li>
<li>减少事务等待时间</li>
</ul>
<p>但是，如果多个事务并发执行，它们的操作可能以某种不理想的方式交错进行，导致数据库处于不一致的状态。这就需要隔离性（保证隔离性才能实现并行控制）。</p>
<p>隔离性是指，多个事务可能并发执行，数据库要保证：</p>
<ul>
<li>对于任意两个事务 T<sub>i</sub> 和 T<sub>j</sub> 来说，T<sub>i</sub> <em>看起来</em> 要么是 T<sub>j</sub> 在 T<sub>i</sub> 开始之前就已经完成了执行，要么是 T<sub>j</sub> 在 T<sub>i</sub> 完成之后才开始执行。</li>
</ul>
<p>从而实现，每个事务都不知道系统中同时执行的其他事务。</p>
<hr>
<h4 id="事务状态"><a href="#事务状态" class="headerlink" title="事务状态"></a>事务状态</h4><p>为了跟准确地描述一个事务执行了多少，我们引入事务状态。</p>
<ul>
<li>Active：初始状态，事务在执行过程中处于该状态。</li>
<li>Partially committed：在执行了最后一个语句之后，事务进入该状态。</li>
<li>Failed：在发现正常执行无法继续后，事务进入该状态。</li>
<li>Aborted：在事务被回滚（roll back）且数据库恢复到事务开始之前的状态后，事务进入中止状态。</li>
<li>Committed：在当前事务成功完成执行后，事务进入该状态。</li>
</ul>
<p><img src="/2024/06/06/%E6%95%B0%E6%8D%AE%E5%BA%931-%E4%BA%8B%E5%8A%A1/state.png" alt="states"></p>
<p>特别地，我们需要小心：可观察的外部写操作（比如写入用户的屏幕，一旦发生，就不能撤销）。大多数系统允许这种写操作仅在事务进入Committed状态后才进行。</p>
<h3 id="调度"><a href="#调度" class="headerlink" title="调度"></a>调度</h3><p><strong>调度（Schedule）</strong>是指一系列指令，并指定并发事务的指令在系统中执行的时间顺序。</p>
<p>且一个调度要满足：</p>
<ul>
<li>对于一组事务的调度必须包含这些事务中的所有指令。</li>
<li>必须保持各个事务中指令的相对顺序（</li>
<li>成功完成执行的事务，其最后一个语句将是commit指令。</li>
<li>未成功完成执行的事务，其最后一个语句将是abort指令。</li>
</ul>
<p>举一个例子：T1事务是从A转账50元到B，T2事务是A转账10%到B。下图的调度1是一个<strong>序列化的（serial）</strong>调度。</p>
<p><img src="/2024/06/06/%E6%95%B0%E6%8D%AE%E5%BA%931-%E4%BA%8B%E5%8A%A1/schedule1.png" alt="schedule1"></p>
<hr>
<h4 id="可序列化"><a href="#可序列化" class="headerlink" title="可序列化"></a>可序列化</h4><blockquote>
<p>等价（equivalent）有很多种，因此对应的可序列化（Serializable）也有多种。这里我们指的都是冲突等价和冲突可序列化。</p>
</blockquote>
<p>如果一个调度是等价于一个序列调度，则称为<strong>可序列化的（serializable）</strong>。所谓等价，通俗地讲，则是两个调度的最终结果相同。之后我们会给出严格定义。</p>
<p>下图中，调度3与调度1等价，是可序列化的调度。</p>
<p><img src="/2024/06/06/%E6%95%B0%E6%8D%AE%E5%BA%931-%E4%BA%8B%E5%8A%A1/schedule3.png" alt="schedule3"></p>
<p>我们只关心read和write两类操作，特别是它们执行的先后顺序，忽略其他类型的操作。大多数时候出问题都是因为：最新值还未写入数据库，而另一事务已经提前读取或写入了数据。但需要指出的是：可能存在两个调度，它们产生相同的结果，但它们不是冲突等价的（相当于是“充分条件，但不必要”）。</p>
<p>我们考虑调度 S 中的两个连续的指令 I 、 J 。</p>
<p>如果 I 、 J 分别作用于不同的数据，那么它们的先后顺序不影响数据结果，怎么样都可以，不冲突。</p>
<p>如果 I 、 J 分别作用于同一个数据 Q ，那么有4种可能情况：</p>
<ul>
<li><p>I &#x3D; read(Q), J &#x3D; read(Q) </p>
</li>
<li><p>I &#x3D; read(Q), J &#x3D; <strong>write(Q)</strong> </p>
</li>
<li><p>I &#x3D; <strong>write(Q)</strong>, J &#x3D; read(Q) </p>
</li>
<li><p>I &#x3D; <strong>write(Q)</strong>, J &#x3D; <strong>write(Q)</strong></p>
</li>
</ul>
<p> I 、 J 同时读取一个数据并不在意顺序，不冲突。但是 I 、 J 只要有至少一个是write操作，就会<strong>冲突（conflict）</strong>，需要考虑其执行顺序。</p>
<p>从而我们可以严格的定义等价：</p>
<p>如果一个调度 S 可以通过一系列非冲突指令的交换转换为另一个调度 S’，我们称 S 和 S’ 是<strong>冲突等价（Conflict Equivalent）</strong>的。</p>
<hr>
<h4 id="可恢复性"><a href="#可恢复性" class="headerlink" title="可恢复性"></a>可恢复性</h4><blockquote>
<p>Transaction T<sub>j</sub> is <strong>dependent</strong> on T<sub>i</sub>  means that T<sub>j</sub> has read data written by T<sub>i</sub> .</p>
</blockquote>
<p>到目前为止，我们都在假定事务不会失败的情况下讨论，但实际情况是事务失败总会发生。为了保证原子性，我们就必须撤销该事务的所有操作。但如果T<sub>i</sub> 失败了，且 T<sub>j</sub> 依赖于 T<sub>i</sub> ，那么我们需要也将 T<sub>j</sub> 撤销。 </p>
<p>例如下图中，调度9中的T<sub>7</sub>使用了T<sub>6</sub>写入的A值，如果T<sub>6</sub>结果出问题，则T<sub>7</sub>结果也有问题。所以，T<sub>7</sub>依赖于T<sub>6 </sub> 。</p>
<p><img src="/2024/06/06/%E6%95%B0%E6%8D%AE%E5%BA%931-%E4%BA%8B%E5%8A%A1/schedule9.png" alt="schedule9"></p>
<p><strong>可恢复调度（recoverable schedule）</strong>应当满足：</p>
<ul>
<li>如果一个事务 T<sub>j</sub> 读取了之前由事务 T<sub>i</sub> 写入的数据项，那么事务 T<sub>i</sub> 将在事务 T<sub>j</sub> 提交之前提交。</li>
</ul>
<p><img src="/2024/06/06/%E6%95%B0%E6%8D%AE%E5%BA%931-%E4%BA%8B%E5%8A%A1/recoverable.png" alt="recoverable"></p>
<p>可恢复性确保了：如果一个事务要用其他事务的数据项，则一定用的是最终数据，而不是过程中的数据。这样避免了一个数据出错导致一系列数据出错（级联效应）。</p>
<hr>
<h4 id="无级联的"><a href="#无级联的" class="headerlink" title="无级联的"></a>无级联的</h4><p>像上面所所的，一个事务的失败可能触发一系列事务的回滚。这种情况称为<strong>级联回滚（cascading rollback）</strong>。这样的情况会大大降低数据库的性能。</p>
<p>所以我们希望调度是<strong>无级联的（cascadeless）</strong>，亦即：</p>
<ul>
<li>任意一对事务 T<sub>i</sub> 和 T<sub>j</sub> ，如果一个事务 T<sub>j</sub> 读取了之前由事务 T<sub>i</sub> 写入的数据项，那么事务 T<sub>i</sub> 将在事务 T<sub>j</sub> 提交之前提交。</li>
</ul>
<p><img src="/2024/06/06/%E6%95%B0%E6%8D%AE%E5%BA%931-%E4%BA%8B%E5%8A%A1/cascadeless.png" alt="cascadeless"></p>
<p>不难发现，无级联则可恢复。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://xht03.github.io/2024/04/16/HTML%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xht03">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="延绪的水上书">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/04/16/HTML%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8B/" class="post-title-link" itemprop="url">HTML简明教程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-04-16 15:37:49 / 修改时间：17:58:14" itemprop="dateCreated datePublished" datetime="2024-04-16T15:37:49+08:00">2024-04-16</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Web-Development/" itemprop="url" rel="index"><span itemprop="name">Web Development</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2024/04/16/HTML%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8B/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2024/04/16/HTML简明教程/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="基本结构"><a href="#基本结构" class="headerlink" title="基本结构"></a>基本结构</h3><blockquote>
<p>添加注释快捷键：<code>ctrl + /</code></p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- DOCTYPE：告诉浏览器我们使用什么规范，省略亦可 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 写在html标签里的内容才会显示 --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- meta：描述性标签，描述网页的一些信息，一般用来做SEO（搜索引擎优化） --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;keyword&quot;</span> <span class="attr">content</span>=<span class="string">&quot;HTML example&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;description&quot;</span> <span class="attr">content</span>=<span class="string">&quot;This is an example of HTML&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>我的第一个HTML页面<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>欢迎来到我的网页<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Hello World!<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>这是一个简单的HTML页面。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>&lt;html&gt;</code>称为开放标签，<code>&lt;/html&gt;</code>称为闭合标签。</li>
<li><code>&lt;meta&gt; charset=&quot;UTF-8&quot;</code>称为自闭合标签。</li>
<li><code>title</code>是指浏览器顶部页眉方框所显示的，并不是页面内的标题。</li>
</ul>
<p><img src="/2024/04/16/HTML%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8B/Users\Keats\Desktop\Erewhon\Yanxu-Blog\source_posts\HTML简明教程\helloworld.png" alt="hello world"></p>
<h3 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h3><blockquote>
<p>输入<code>p</code>并按<code>tab</code>键，会自动生成<code>&lt;p&gt;&lt;/p&gt;</code>标签。其余类似。</p>
</blockquote>
<h4 id="基本标签"><a href="#基本标签" class="headerlink" title="基本标签"></a>基本标签</h4><ul>
<li><code>&lt;h1&gt;&lt;/h1&gt;</code>：标题</li>
<li><code>&lt;p&gt;&lt;/p&gt;</code>：段落</li>
<li><code>&lt;hr&gt;</code>或<code>&lt;hr/&gt;</code>：水平线</li>
<li><code>&lt;br&gt;</code>：换行</li>
<li><code>&lt;b&gt;&lt;/b&gt;</code>或<code>&lt;strong&gt;&lt;/strong&gt;</code>：粗体</li>
<li><code>&lt;i&gt;&lt;/i&gt;</code>或<code>&lt;em&gt;&lt;/em&gt;</code>：斜体</li>
<li><code>&amp;...;</code>：转义字符（<code>&amp;</code>表示转义）</li>
<li><code>&amp;nbsp;</code>：空格</li>
<li><code>&lt;img src=&quot;&quot; alt=&quot;&quot;&gt;</code>：图像</li>
</ul>
<blockquote>
<ol>
<li>空格键无论多少，都视为一个空格。多空格需用转义字符<code>&amp;nbsp</code>。</li>
<li>图像引用中<code>src</code>和<code>alt</code>必不可少。其余字段可以添加或省略。</li>
</ol>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>基本标签<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 标题标签 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>欢迎来到我的网页<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>一首小诗<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 段落标签 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Do not go gentle into that good night<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Old age should burn and rave at close of day<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>Rage, rage against the dying of the light<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 水平线 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 换行 --&gt;</span></span><br><span class="line">    两只老虎	两只老虎	跑得快 <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    一只没有眼睛	一直没有尾巴 <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    真奇怪		真奇怪 <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 粗体与斜体 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">b</span>&gt;</span> I love you. <span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">strong</span>&gt;</span> I love you. <span class="tag">&lt;/<span class="name">strong</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">i</span>&gt;</span> I miss you. <span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">em</span>&gt;</span> I miss you. <span class="tag">&lt;/<span class="name">em</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 特殊符号 --&gt;</span></span><br><span class="line">    <span class="symbol">&amp;copy;</span> 版权归延绪所有（版权符号） <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="symbol">&amp;lt;</span> <span class="symbol">&amp;gt;</span> <span class="symbol">&amp;amp;</span> <span class="symbol">&amp;quot;</span> <span class="symbol">&amp;nbsp;</span>（小于、大于、与、引号、空格） <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    空<span class="symbol">&amp;nbsp;</span><span class="symbol">&amp;nbsp;</span><span class="symbol">&amp;nbsp;</span>格 <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 图像标签 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;../resources/images/SummerGhost3.png&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;替代文字&quot;</span> <span class="attr">title</span>=<span class="string">&quot;悬停文字&quot;</span> <span class="attr">width</span>=<span class="string">&quot;960&quot;</span> <span class="attr">height</span>=<span class="string">&quot;540&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/2024/04/16/HTML%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8B/Users\Keats\Desktop\Erewhon\Yanxu-Blog\source_posts\HTML简明教程\tags.png" alt="tags"></p>
<h4 id="超链接标签"><a href="#超链接标签" class="headerlink" title="超链接标签"></a>超链接标签</h4>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://xht03.github.io/2024/04/01/PostgreSQL%E6%91%98%E8%A6%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xht03">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="延绪的水上书">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/04/01/PostgreSQL%E6%91%98%E8%A6%81/" class="post-title-link" itemprop="url">PostgreSQL摘要</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-04-01 13:34:43" itemprop="dateCreated datePublished" datetime="2024-04-01T13:34:43+08:00">2024-04-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-06-10 17:45:33" itemprop="dateModified" datetime="2024-06-10T17:45:33+08:00">2024-06-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/The-Introduction-to-Database/" itemprop="url" rel="index"><span itemprop="name">The Introduction to Database</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2024/04/01/PostgreSQL%E6%91%98%E8%A6%81/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2024/04/01/PostgreSQL摘要/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p> Relational Databases 关系数据库</p>
<p>Database Design </p>
<p>Data Storage and Query</p>
<p>Transaction Management</p>
<h3 id="Relational-Model"><a href="#Relational-Model" class="headerlink" title="Relational Model"></a>Relational Model</h3><h4 id="Structure-结构"><a href="#Structure-结构" class="headerlink" title="Structure 结构"></a>Structure 结构</h4><blockquote>
<p>在 <em>关系模型</em> 中：每一个表是一个关系，每一行是一个元组，每一列是一个属性。</p>
</blockquote>
<ul>
<li>A relational database consists of a collection of tables.</li>
<li>A row in a table represents a relationship among a set of values.</li>
<li>The order in which tuples appear in a relation is irrelevant, since a relation is a set of tuples .</li>
</ul>
<h4 id="Domain-域"><a href="#Domain-域" class="headerlink" title="Domain 域"></a>Domain 域</h4><blockquote>
<p>域就是属性的值域（取值集合）。原子性意为“<strong>不可再分</strong>”。</p>
</blockquote>
<ul>
<li><p>For each attribute of a relation, there is a set of permitted values , called the domain of that attribute.</p>
</li>
<li><p>For all relations r , the domains of all attributes of <em>r</em> be <strong>atomic</strong>.</p>
</li>
</ul>
<h4 id="Null-Value-空值"><a href="#Null-Value-空值" class="headerlink" title="Null Value 空值"></a>Null Value 空值</h4><ul>
<li>空值是一种特殊值，表示：取值未知或不存在。</li>
<li>任何域都含有空值。</li>
</ul>
<h4 id="Schema-模式"><a href="#Schema-模式" class="headerlink" title="Schema 模式"></a>Schema 模式</h4><p>Database schema : the logical design of the database.</p>
<p>Database instance : a snapshot of the data in the database at a given instant in time.</p>
<blockquote>
<p>例如：<code>instructor = (ID, name, dept_name, salary)</code></p>
</blockquote>
<h4 id="Keys-键"><a href="#Keys-键" class="headerlink" title="Keys 键"></a>Keys 键</h4><blockquote>
<p>We must have a way to specify how tuples within a given relation are distinguished.</p>
</blockquote>
<ul>
<li><strong>superkey</strong> : A superkey is a set of one or more attributes that, taken collectively, allow us to identify uniquely a tuple in the relation.</li>
<li><strong>candidate key</strong> : The superkeys, for which no proper subset is a superkey, are called candidate keys.</li>
<li><strong>primary key</strong> : A primary key is a candidate key that is chosen by the database designer as the principal means of identifying tuples within a relation.</li>
<li><strong>foreign key</strong> : A relation, may include among its attributes the primary key of another relation. This attribute is called a foreign key.</li>
</ul>
<blockquote>
<p>注意：</p>
<ol>
<li><p>A superkey may contain extraneous attributes.</p>
</li>
<li><p>It is possible that several distinct sets of attributes could<br>serve as a candidate key.</p>
</li>
</ol>
</blockquote>
<h4 id="Schema-Diagrams-模式图"><a href="#Schema-Diagrams-模式图" class="headerlink" title="Schema Diagrams 模式图"></a>Schema Diagrams 模式图</h4><blockquote>
<p>Schema diagram &#x3D; database schema + primary key and foreign key dependencies</p>
</blockquote>
<p><img src="/2024/04/01/PostgreSQL%E6%91%98%E8%A6%81/Users\Keats\Desktop\Erewhon\Yanxu-Blog\source_posts\PostgreSQL摘要\schema_diagrams.png" alt="Schema Diagrams"></p>
<h4 id="Query-Languages"><a href="#Query-Languages" class="headerlink" title="Query Languages"></a>Query Languages</h4><p>A query language is a language in which a user requests information from the database.</p>
<blockquote>
<p>Query Languages 通常有两类：</p>
<ul>
<li><em>procedural</em>：指定查询什么数据以及如何获取数据。</li>
<li><em>declarative</em>：只需指定查询什么数据，不必指定如何查询数据。</li>
</ul>
</blockquote>
<h3 id="Relational-Algebra"><a href="#Relational-Algebra" class="headerlink" title="Relational Algebra"></a>Relational Algebra</h3><h3 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h3><h4 id="What-is-SQL"><a href="#What-is-SQL" class="headerlink" title="What is SQL"></a>What is SQL</h4><p>数据库系统提供：</p>
<ul>
<li><em>data-definition language</em> (DDL)：定义数据库模式。</li>
<li><em>data-manipulation language</em> (DML)：表达数据库查询和更新。</li>
</ul>
<p>但实际上，<em>DDL</em> 和 <em>DML</em> 并不是两种分离的语言。相反地，它们简单地构成单一的数据库语言，比如：SQL。</p>
<blockquote>
<p>查询 (query) 是对所求信息进行检索的语句。DML中涉及信息检索的部分称作 <em>query language</em> 。但实践中常将 query language 和 DML 视为同义词。</p>
</blockquote>
<h4 id="Domain-Types"><a href="#Domain-Types" class="headerlink" title="Domain Types"></a>Domain Types</h4><ul>
<li><code>char(n)</code>：固定长度字符串（长度为 n ）</li>
<li><code>varchar(n)</code>：变长度字符串（最大长度为 n ）</li>
<li><code>int</code>：整数</li>
<li><code>smallint</code>：小整数</li>
<li><code>numeric(p, d)</code>：固定点数（有效数字 p 位，小数点后 d 位）</li>
<li><code>real</code>、<code>double percision</code>：实数、双精度浮点数</li>
<li><code>float(n)</code>：浮点数（有效数字 n 位）</li>
</ul>
<h4 id="Common-Operation"><a href="#Common-Operation" class="headerlink" title="Common Operation"></a>Common Operation</h4><blockquote>
<p>创建 table</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Users(</span><br><span class="line">	user_id <span class="type">char</span>(<span class="number">6</span>) <span class="keyword">NOT</span> <span class="keyword">Null</span>,</span><br><span class="line">	username <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line">	realname <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line">	age <span class="type">int</span>,</span><br><span class="line">	password <span class="type">varchar</span>(<span class="number">30</span>),</span><br><span class="line">	permisson <span class="type">int</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>创建 procedure</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="Relational-Database-Design"><a href="#Relational-Database-Design" class="headerlink" title="Relational Database Design"></a>Relational Database Design</h3><h4 id="函数依赖"><a href="#函数依赖" class="headerlink" title="函数依赖"></a>函数依赖</h4><blockquote>
<p>函数依赖本质上就是：两个属性之间存在单射</p>
</blockquote>
<p>设R是一个关系模式，X 和 Y 是 R 的属性集的子集。如果对于 R 的任意一个关系r，对于r中的任意两个元组 t1 和 t2 ，只要 t1 和 t2 在 X 上的值相等，那么它们在 Y 上的值也相等，那么我们就说 Y 在 X 上函数依赖，记作 <code>X-&gt;Y</code> 。</p>
<p>K is a superkey for R &harr; <code>K -&gt; R</code></p>
<p>K is a candidate key for R &harr; <code>K-&gt;R</code> and no &alpha;K,   R</p>
<h4 id="第一范式"><a href="#第一范式" class="headerlink" title="第一范式"></a>第一范式</h4><p>R 满足第一范式 &harr; R的所有属性的域都是原子的。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://xht03.github.io/2024/03/06/RV64%E5%8D%95%E5%91%A8%E6%9C%9FCPU/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xht03">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="延绪的水上书">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/03/06/RV64%E5%8D%95%E5%91%A8%E6%9C%9FCPU/" class="post-title-link" itemprop="url">RV64单周期CPU</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-03-06 08:04:28" itemprop="dateCreated datePublished" datetime="2024-03-06T08:04:28+08:00">2024-03-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-05-13 16:09:37" itemprop="dateModified" datetime="2024-05-13T16:09:37+08:00">2024-05-13</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ICS/" itemprop="url" rel="index"><span itemprop="name">ICS</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2024/03/06/RV64%E5%8D%95%E5%91%A8%E6%9C%9FCPU/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2024/03/06/RV64单周期CPU/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h3><p><img src="/2024/03/06/RV64%E5%8D%95%E5%91%A8%E6%9C%9FCPU/RISC-V.png" alt="架构图"></p>
<p>我设计的RV64-CPU总共有14个模块：</p>
<ul>
<li>PC：更新下一条指令地址。</li>
<li>PCincrement：将PC加4，作为PCNext的可能值。</li>
<li>PCNext：根据Jump和CndCode信号，判断PC是跳转还是累加，计算出PCNext值。</li>
<li>InstMem：指令内存。根据PC值取出指令并解析。</li>
<li>RegFile：寄存器文件。执行读取和写回操作。</li>
<li>ImmGen：立即数生成器。将立即数补位成64位。</li>
<li>Control：控制模块。判断指令类型，并输出控制信号。</li>
<li>ALU_A：选择ALU端口A的数据来源。</li>
<li>ALU_B：选择ALU端口B的数据来源。</li>
<li>ALU_control：选择ALU功能。</li>
<li>ALU：执行算术逻辑运算。</li>
<li>DataMem：数据内存。执行写入和读取内存操作。</li>
<li>Conditional：计算Conditional Code。</li>
<li>RegBack：选择写回寄存器的数据来源。</li>
</ul>
<p>其中控制信号有以下：</p>
<ul>
<li>Branch：是否是Branch类指令</li>
<li>Jump：是否是<code>jal</code>指令</li>
<li>JumpReg：是否是<code>jalr</code>指令</li>
<li>MemRead：是否读取内存</li>
<li>MemWrite：是否写入内存</li>
<li>ALUop：指令类型</li>
<li>ALUSrc：ALU_B数据来源</li>
<li>RegWrite：是否写回寄存器</li>
<li>Halt：停止执行</li>
</ul>
<p>我没有设置MemtoReg信号。这是因为：目前，MemtoReg信号和MemRead信号一致，读取内存一定是存进寄存器里。</p>
<h3 id="RISC-V指令集"><a href="#RISC-V指令集" class="headerlink" title="RISC-V指令集 "></a><a target="_blank" rel="noopener" href="https://www.cs.sfu.ca/~ashriram/Courses/CS295/assets/notebooks/RISCV/RISCV_CARD.pdf">RISC-V指令集 </a></h3><p>我设计的CPU支持所有RV32I Base Integer Instruction（除<code>ecall</code>、<code>ebreak</code>外）。</p>
<p><img src="/2024/03/06/RV64%E5%8D%95%E5%91%A8%E6%9C%9FCPU/ISA.png" alt="指令集"></p>
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><h4 id="PC"><a href="#PC" class="headerlink" title="PC"></a>PC</h4><blockquote>
<p>在时钟上升沿更新PC值。</p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> PC(</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> clk,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] PCnext,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] PCaddress</span><br><span class="line">);</span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk) <span class="keyword">begin</span></span><br><span class="line">        PCaddress &lt;= PCnext;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>



<h4 id="PCincrement"><a href="#PCincrement" class="headerlink" title="PCincrement"></a>PCincrement</h4><blockquote>
<p>计算PC累加值，作为<code>PCNext</code>的可能值。</p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> PCincrement(</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] PCaddress,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] PCincrement</span><br><span class="line">);</span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        PCincrement = PCaddress + <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="PCNext"><a href="#PCNext" class="headerlink" title="PCNext"></a>PCNext</h4><blockquote>
<p>根据<code>Conditional Code</code>、<code>Jump</code>、<code>JumpReg</code>信号，计算<code>PCNext</code>值。</p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> PCNext(</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] PCaddress,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] PCincrement,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] Imm,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] Rs1,         <span class="comment">// jalr会用到rs1</span></span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> Jump,               <span class="comment">// jal</span></span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> JumpReg,            <span class="comment">// jalr</span></span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> CndCode,            <span class="comment">// branch</span></span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> Halt,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] PCnext</span><br><span class="line">);</span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span>(CndCode) PCnext = PCaddress + Imm;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(Jump) PCnext = PCaddress + Imm;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(JumpReg) PCnext = Rs1 + Imm;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(Halt) PCnext = PCaddress;</span><br><span class="line">        <span class="keyword">else</span> PCnext = PCincrement;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>



<h4 id="Control"><a href="#Control" class="headerlink" title="Control"></a>Control</h4><blockquote>
<p>根据<code>OpCode</code>判断指令类型，并产生控制信号，指导：ALU运算、寄存器读写、内存读写、PC更新。</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">ALUop</th>
<th align="center">指令类型</th>
</tr>
</thead>
<tbody><tr>
<td align="center">000</td>
<td align="center">R-type</td>
</tr>
<tr>
<td align="center">001</td>
<td align="center">I1-type</td>
</tr>
<tr>
<td align="center">010</td>
<td align="center">I2-type（Load类指令）</td>
</tr>
<tr>
<td align="center">011</td>
<td align="center">S-tpye</td>
</tr>
<tr>
<td align="center">100</td>
<td align="center">B-type</td>
</tr>
<tr>
<td align="center">101</td>
<td align="center">J-type</td>
</tr>
<tr>
<td align="center">110</td>
<td align="center">U-type</td>
</tr>
</tbody></table>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> Control(</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">6</span>:<span class="number">0</span>] OpCode,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> Branch,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> Jump,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> JumpReg,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> MemRead,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> MemWrite,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">2</span>:<span class="number">0</span>] ALUop,       <span class="comment">// 指令类型</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> ALUSrc,            <span class="comment">// 0:Rs2 1:imm</span></span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> RegWrite,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> Halt               <span class="comment">// 1:停机 0:正常运行</span></span><br><span class="line">);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    *ALUop:</span></span><br><span class="line"><span class="comment">    *000:R-type 001:I1-type 010:I2-type 011:S-type</span></span><br><span class="line"><span class="comment">    *100:B-type 101:J-type 	110:U-type</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">case</span>(OpCode)</span><br><span class="line">            <span class="number">7&#x27;b0110011</span>: <span class="keyword">begin</span>       <span class="comment">// R-type</span></span><br><span class="line">                Branch = <span class="number">0</span>; Jump = <span class="number">0</span>; JumpReg = <span class="number">0</span>;</span><br><span class="line">                MemRead = <span class="number">0</span>; MemWrite = <span class="number">0</span>;</span><br><span class="line">                ALUop = <span class="number">3&#x27;b000</span>; ALUSrc = <span class="number">0</span>;</span><br><span class="line">                RegWrite = <span class="number">1</span>;</span><br><span class="line">                Halt = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="number">7&#x27;b0010011</span>: <span class="keyword">begin</span>       <span class="comment">// I1-type</span></span><br><span class="line">                Branch = <span class="number">0</span>; Jump = <span class="number">0</span>; JumpReg = <span class="number">0</span>;</span><br><span class="line">                MemRead = <span class="number">0</span>; MemWrite = <span class="number">0</span>;</span><br><span class="line">                ALUop = <span class="number">3&#x27;b001</span>; ALUSrc = <span class="number">1</span>;</span><br><span class="line">                RegWrite = <span class="number">1</span>;</span><br><span class="line">                Halt = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="number">7&#x27;b0000011</span>: <span class="keyword">begin</span>       <span class="comment">// I2-type</span></span><br><span class="line">                Branch = <span class="number">0</span>; Jump = <span class="number">0</span>; JumpReg = <span class="number">0</span>;</span><br><span class="line">                MemRead = <span class="number">1</span>; MemWrite = <span class="number">0</span>;</span><br><span class="line">                ALUop = <span class="number">3&#x27;b010</span>; ALUSrc = <span class="number">1</span>;</span><br><span class="line">                RegWrite = <span class="number">1</span>;</span><br><span class="line">                Halt = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="number">7&#x27;b0100011</span>: <span class="keyword">begin</span>       <span class="comment">// S-type</span></span><br><span class="line">                Branch = <span class="number">0</span>; Jump = <span class="number">0</span>; JumpReg = <span class="number">0</span>;</span><br><span class="line">                MemRead = <span class="number">0</span>; MemWrite = <span class="number">1</span>;</span><br><span class="line">                ALUop = <span class="number">3&#x27;b011</span>; ALUSrc = <span class="number">1</span>;</span><br><span class="line">                RegWrite = <span class="number">0</span>;</span><br><span class="line">                Halt = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="number">7&#x27;b1100011</span>: <span class="keyword">begin</span>       <span class="comment">// B-type</span></span><br><span class="line">                Branch = <span class="number">1</span>; Jump = <span class="number">0</span>; JumpReg = <span class="number">0</span>;</span><br><span class="line">                MemRead = <span class="number">0</span>; MemWrite = <span class="number">0</span>;</span><br><span class="line">                ALUop = <span class="number">3&#x27;b100</span>; ALUSrc = <span class="number">0</span>;</span><br><span class="line">                RegWrite = <span class="number">0</span>;</span><br><span class="line">                Halt = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="number">7&#x27;b1101111</span>: <span class="keyword">begin</span>       <span class="comment">// J-type (jal)</span></span><br><span class="line">                Branch = <span class="number">0</span>; Jump = <span class="number">1</span>; JumpReg = <span class="number">0</span>;</span><br><span class="line">                MemRead = <span class="number">0</span>; MemWrite = <span class="number">0</span>;</span><br><span class="line">                ALUop = <span class="number">3&#x27;b101</span>; ALUSrc = <span class="number">0</span>;</span><br><span class="line">                RegWrite = <span class="number">0</span>;</span><br><span class="line">                Halt = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="number">7&#x27;b1100111</span>: <span class="keyword">begin</span>       <span class="comment">// jarl</span></span><br><span class="line">                Branch = <span class="number">0</span>; Jump = <span class="number">0</span>; JumpReg = <span class="number">1</span>;</span><br><span class="line">                MemRead = <span class="number">0</span>; MemWrite = <span class="number">0</span>;</span><br><span class="line">                ALUop = <span class="number">3&#x27;b101</span>; ALUSrc = <span class="number">1</span>;</span><br><span class="line">                RegWrite = <span class="number">1</span>;</span><br><span class="line">                Halt = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="number">7&#x27;b0110111</span>: <span class="keyword">begin</span>       <span class="comment">// U-type(lui)</span></span><br><span class="line">                Branch = <span class="number">0</span>; Jump = <span class="number">0</span>; JumpReg = <span class="number">0</span>;</span><br><span class="line">                MemRead = <span class="number">0</span>; MemWrite = <span class="number">0</span>;</span><br><span class="line">                ALUop = <span class="number">3&#x27;b110</span>; ALUSrc = <span class="number">1</span>;</span><br><span class="line">                RegWrite = <span class="number">1</span>;</span><br><span class="line">                Halt = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="number">7&#x27;b0010111</span>: <span class="keyword">begin</span>       <span class="comment">// U-type(auipc)</span></span><br><span class="line">                Branch = <span class="number">0</span>; Jump = <span class="number">0</span>; JumpReg = <span class="number">0</span>;</span><br><span class="line">                MemRead = <span class="number">0</span>; MemWrite = <span class="number">0</span>;</span><br><span class="line">                ALUop = <span class="number">3&#x27;b110</span>; ALUSrc = <span class="number">1</span>;</span><br><span class="line">                RegWrite = <span class="number">1</span>;</span><br><span class="line">                Halt = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">default</span>: <span class="keyword">begin</span></span><br><span class="line">                Branch = <span class="number">0</span>; Jump = <span class="number">0</span>; JumpReg = <span class="number">0</span>;</span><br><span class="line">                MemRead = <span class="number">0</span>; MemWrite = <span class="number">0</span>;</span><br><span class="line">                ALUop = <span class="number">3&#x27;b000</span>; ALUSrc = <span class="number">0</span>;</span><br><span class="line">                RegWrite = <span class="number">0</span>;</span><br><span class="line">                Halt = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="InstMem"><a href="#InstMem" class="headerlink" title="InstMem"></a>InstMem</h4><blockquote>
<p>根据<code>PCaddress</code>读取指令，并拆解为<code>OpCode</code>、<code>Rs1</code>、<code>Rs2</code>、<code>Rd</code>。<code>Inst</code>是完整指令，用于生成立即数。</p>
</blockquote>
<blockquote>
<p>为了后续便于验证正确性，这里预先写入两条指令。</p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> InstMem(</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] PCaddress,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">6</span>:<span class="number">0</span>] OpCode,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>] Rs1,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>] Rs2,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>] Rd,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] Inst</span><br><span class="line">);</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">7</span>:<span class="number">0</span>] mem[<span class="number">0</span>:<span class="number">1023</span>];</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] instruction;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">        mem[<span class="number">0</span>] = <span class="number">8&#x27;b10110111</span>;        <span class="comment">// b7  ( lui x5, 0x12345)</span></span><br><span class="line">        mem[<span class="number">1</span>] = <span class="number">8&#x27;b00000010</span>;       <span class="comment">//  02</span></span><br><span class="line">        mem[<span class="number">2</span>] = <span class="number">8&#x27;b01101000</span>;       <span class="comment">//  68</span></span><br><span class="line">        mem[<span class="number">3</span>] = <span class="number">8&#x27;b00010010</span>;       <span class="comment">//  12</span></span><br><span class="line">        mem[<span class="number">4</span>] = <span class="number">8&#x27;b10110011</span>;       <span class="comment">//  b3  ( add x7, x5, x6)</span></span><br><span class="line">        mem[<span class="number">5</span>] = <span class="number">8&#x27;b00000011</span>;       <span class="comment">//  03</span></span><br><span class="line">        mem[<span class="number">6</span>] = <span class="number">8&#x27;b01010011</span>;       <span class="comment">//  53</span></span><br><span class="line">        mem[<span class="number">7</span>] = <span class="number">8&#x27;b00000000</span>;       <span class="comment">//  00</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        instruction = &#123;mem[PCaddress+<span class="number">3</span>], mem[PCaddress+<span class="number">2</span>], mem[PCaddress+<span class="number">1</span>], mem[PCaddress]&#125;;</span><br><span class="line">        OpCode = instruction[<span class="number">6</span>:<span class="number">0</span>];</span><br><span class="line">        Rs1 = instruction[<span class="number">19</span>:<span class="number">15</span>];</span><br><span class="line">        Rs2 = instruction[<span class="number">24</span>:<span class="number">20</span>];</span><br><span class="line">        Rd = instruction[<span class="number">11</span>:<span class="number">7</span>];</span><br><span class="line">        Inst = instruction;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>



<h4 id="RegFile"><a href="#RegFile" class="headerlink" title="RegFile"></a>RegFile</h4><blockquote>
<p>对寄存器文件进行读写操作。</p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> RegFile(</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> clk,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>] ReadReg1,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>] ReadReg2,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>] WriteReg,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> RegWrite,   <span class="comment">// 是否写入寄存器</span></span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] WriteData,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] ReadData1,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] ReadData2</span><br><span class="line">);</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] regs[<span class="number">0</span>:<span class="number">31</span>];     <span class="comment">// 32个64-bit寄存器</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_ff</span> @(<span class="keyword">posedge</span> clk) <span class="keyword">begin</span>      <span class="comment">// write是时序的</span></span><br><span class="line">        <span class="keyword">if</span>(RegWrite) <span class="keyword">begin</span></span><br><span class="line">            regs[WriteReg] &lt;= WriteData;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span>		<span class="comment">// read是组合的</span></span><br><span class="line">        ReadData1 = regs[ReadReg1];</span><br><span class="line">        ReadData2 = regs[ReadReg2];</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>



<h4 id="ImmGen"><a href="#ImmGen" class="headerlink" title="ImmGen"></a>ImmGen</h4><blockquote>
<p>根据<code>Inst</code>判断指令类型，根据不同指令，采取不同方式补位立即数。</p>
</blockquote>
<blockquote>
<p><code>funct7_30</code>是 funct7 的1个 bit ，指令中的第30个 bit 。funct7 中其余部分都是0，真正有区分作用的仅<code>funct7_30</code>一位。（区分<code>srai</code>和<code>srli</code>时）</p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> ImmGen(</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] Inst,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] Imm</span><br><span class="line">);</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">6</span>:<span class="number">0</span>] opcode;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">2</span>:<span class="number">0</span>] funct3;</span><br><span class="line">    <span class="keyword">logic</span> funct7_30;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assign</span> opcode = Inst[<span class="number">6</span>:<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">assign</span> funct3 = Inst[<span class="number">14</span>:<span class="number">12</span>];</span><br><span class="line">    <span class="keyword">assign</span> funct7_30 = Inst[<span class="number">30</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">case</span>(opcode)</span><br><span class="line">            <span class="number">7&#x27;b0010011</span>: <span class="keyword">begin</span>                                   <span class="comment">// I-type</span></span><br><span class="line">                <span class="keyword">if</span>(funct3 == <span class="number">3&#x27;b101</span> &amp;&amp; funct7_30 == <span class="number">1</span>) <span class="keyword">begin</span></span><br><span class="line">                    Imm =&#123;&#123;(<span class="number">64</span> - <span class="number">5</span>)&#123;Inst[<span class="number">24</span>]&#125;&#125;,Inst[<span class="number">24</span>:<span class="number">20</span>]&#125;;</span><br><span class="line">                <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">                    Imm = &#123;&#123;(<span class="number">64</span> - <span class="number">12</span>)&#123;Inst[<span class="number">31</span>]&#125;&#125;, Inst[<span class="number">31</span>:<span class="number">20</span>]&#125;;</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="number">7&#x27;b0000011</span>: Imm = &#123;&#123;(<span class="number">64</span> - <span class="number">12</span>)&#123;Inst[<span class="number">31</span>]&#125;&#125;, Inst[<span class="number">31</span>:<span class="number">20</span>]&#125;;    <span class="comment">// I-type(load)</span></span><br><span class="line">            <span class="number">7&#x27;b0100011</span>: Imm = &#123;&#123;(<span class="number">64</span> - <span class="number">12</span>)&#123;Inst[<span class="number">31</span>]&#125;&#125;, Inst[<span class="number">31</span>:<span class="number">25</span>], Inst[<span class="number">11</span>:<span class="number">7</span>]&#125;;    <span class="comment">// S-type</span></span><br><span class="line">            <span class="number">7&#x27;b1100011</span>: Imm = &#123;&#123;(<span class="number">64</span> - <span class="number">13</span>)&#123;Inst[<span class="number">31</span>]&#125;&#125;, Inst[<span class="number">31</span>], Inst[<span class="number">7</span>], Inst[<span class="number">30</span>:<span class="number">25</span>], Inst[<span class="number">11</span>:<span class="number">8</span>], <span class="number">1&#x27;b0</span>&#125;;    <span class="comment">// B-type</span></span><br><span class="line">            <span class="number">7&#x27;b1101111</span>: Imm = &#123;&#123;(<span class="number">64</span> - <span class="number">21</span>)&#123;Inst[<span class="number">31</span>]&#125;&#125;, Inst[<span class="number">31</span>], Inst[<span class="number">19</span>:<span class="number">12</span>], Inst[<span class="number">20</span>], Inst[<span class="number">30</span>:<span class="number">21</span>], <span class="number">1&#x27;b0</span>&#125;;    <span class="comment">// J-type(jal)</span></span><br><span class="line">            <span class="number">7&#x27;b1100111</span>: Imm = &#123;&#123;(<span class="number">64</span> - <span class="number">12</span>)&#123;Inst[<span class="number">31</span>]&#125;&#125;, Inst[<span class="number">31</span>:<span class="number">20</span>]&#125;;    <span class="comment">// jalr</span></span><br><span class="line">            <span class="number">7&#x27;b0110111</span>: Imm = &#123;&#123;(<span class="number">64</span> - <span class="number">32</span>)&#123;Inst[<span class="number">31</span>]&#125;&#125;, Inst[<span class="number">31</span>:<span class="number">12</span>], <span class="number">12&#x27;b0</span>&#125;;    <span class="comment">// U-type(lui)</span></span><br><span class="line">            <span class="number">7&#x27;b0010111</span>: Imm = &#123;&#123;(<span class="number">64</span> - <span class="number">32</span>)&#123;Inst[<span class="number">31</span>]&#125;&#125;, Inst[<span class="number">31</span>:<span class="number">12</span>], <span class="number">12&#x27;b0</span>&#125;;    <span class="comment">// U-type(auipc)</span></span><br><span class="line">            <span class="keyword">default</span>: Imm = <span class="number">64&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>



<h4 id="ALU-control"><a href="#ALU-control" class="headerlink" title="ALU_control"></a>ALU_control</h4><blockquote>
<p>根据指令类型，选择ALU具体功能<code>ALUfunc</code>。</p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> ALU_control(</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">2</span>:<span class="number">0</span>] ALUop,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">2</span>:<span class="number">0</span>] funct3,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> funct7_30,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">2</span>:<span class="number">0</span>] ALUfunc</span><br><span class="line">);</span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">case</span>(ALUop)</span><br><span class="line">            <span class="number">3&#x27;b000</span>: <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">case</span>(funct3)</span><br><span class="line">                    <span class="number">3&#x27;b000</span>: <span class="keyword">begin</span></span><br><span class="line">                        <span class="keyword">case</span>(funct7_30)</span><br><span class="line">                            <span class="number">1&#x27;b0</span>: ALUfunc = <span class="number">3&#x27;b000</span>;     <span class="comment">// add</span></span><br><span class="line">                            <span class="number">1&#x27;b1</span>: ALUfunc = <span class="number">3&#x27;b001</span>;     <span class="comment">// sub</span></span><br><span class="line">                        <span class="keyword">endcase</span></span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                    <span class="number">3&#x27;b001</span>: ALUfunc = <span class="number">3&#x27;b101</span>;           <span class="comment">// sll(&lt;&lt;)</span></span><br><span class="line">                    <span class="number">3&#x27;b010</span>: ALUfunc = <span class="number">3&#x27;b001</span>;           <span class="comment">// slt(做减法运算)</span></span><br><span class="line">                    <span class="number">3&#x27;b011</span>: ALUfunc = <span class="number">3&#x27;b001</span>;           <span class="comment">// sltu(做减法运算)</span></span><br><span class="line">                    <span class="number">3&#x27;b100</span>: ALUfunc = <span class="number">3&#x27;b100</span>;           <span class="comment">// xor</span></span><br><span class="line">                    <span class="number">3&#x27;b101</span>: <span class="keyword">begin</span></span><br><span class="line">                        <span class="keyword">case</span>(funct7_30)</span><br><span class="line">                            <span class="number">1&#x27;b0</span>: ALUfunc = <span class="number">3&#x27;b111</span>;     <span class="comment">// srl(&gt;&gt;&gt;)</span></span><br><span class="line">                            <span class="number">1&#x27;b1</span>: ALUfunc = <span class="number">3&#x27;b110</span>;     <span class="comment">// sra(&gt;&gt;)</span></span><br><span class="line">                        <span class="keyword">endcase</span></span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                    <span class="number">3&#x27;b110</span>: ALUfunc = <span class="number">3&#x27;b011</span>;           <span class="comment">// or</span></span><br><span class="line">                    <span class="number">3&#x27;b111</span>: ALUfunc = <span class="number">3&#x27;b010</span>;           <span class="comment">// and</span></span><br><span class="line">                <span class="keyword">endcase</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="number">3&#x27;b001</span>: <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">case</span>(funct3)</span><br><span class="line">                    <span class="number">3&#x27;b000</span>: ALUfunc = <span class="number">3&#x27;b000</span>;           <span class="comment">// add</span></span><br><span class="line">                    <span class="number">3&#x27;b001</span>: ALUfunc = <span class="number">3&#x27;b101</span>;           <span class="comment">// sll(&lt;&lt;)</span></span><br><span class="line">                    <span class="number">3&#x27;b010</span>: ALUfunc = <span class="number">3&#x27;b001</span>;           <span class="comment">// slt(做减法运算)</span></span><br><span class="line">                    <span class="number">3&#x27;b011</span>: ALUfunc = <span class="number">3&#x27;b001</span>;           <span class="comment">// sltu(做减法运算)</span></span><br><span class="line">                    <span class="number">3&#x27;b100</span>: ALUfunc = <span class="number">3&#x27;b100</span>;           <span class="comment">// xor</span></span><br><span class="line">                    <span class="number">3&#x27;b101</span>: <span class="keyword">begin</span></span><br><span class="line">                        <span class="keyword">case</span>(funct7_30)</span><br><span class="line">                            <span class="number">1&#x27;b0</span>: ALUfunc = <span class="number">3&#x27;b111</span>;     <span class="comment">// srl(&gt;&gt;&gt;)</span></span><br><span class="line">                            <span class="number">1&#x27;b1</span>: ALUfunc = <span class="number">3&#x27;b110</span>;     <span class="comment">// sra(&gt;&gt;)</span></span><br><span class="line">                        <span class="keyword">endcase</span></span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                    <span class="number">3&#x27;b110</span>: ALUfunc = <span class="number">3&#x27;b011</span>;           <span class="comment">// or</span></span><br><span class="line">                    <span class="number">3&#x27;b111</span>: ALUfunc = <span class="number">3&#x27;b010</span>;           <span class="comment">// and</span></span><br><span class="line">                <span class="keyword">endcase</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="number">3&#x27;b010</span>: ALUfunc = <span class="number">3&#x27;b000</span>;                   <span class="comment">// load类指令 add</span></span><br><span class="line">            <span class="number">3&#x27;b011</span>: ALUfunc = <span class="number">3&#x27;b000</span>;                   <span class="comment">// store类指令 add</span></span><br><span class="line">            <span class="number">3&#x27;b100</span>: ALUfunc = <span class="number">3&#x27;b001</span>;                   <span class="comment">// branch类指令 sub</span></span><br><span class="line">            <span class="number">3&#x27;b101</span>: ALUfunc = <span class="number">3&#x27;b000</span>;                   <span class="comment">// jump类指令 add</span></span><br><span class="line">            <span class="number">3&#x27;b110</span>: ALUfunc = <span class="number">3&#x27;b000</span>;                   <span class="comment">// U-type指令 add</span></span><br><span class="line">            <span class="keyword">default</span>: ALUfunc = <span class="number">3&#x27;b000</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>



<h4 id="ALU-A"><a href="#ALU-A" class="headerlink" title="ALU_A"></a>ALU_A</h4><blockquote>
<p>选择<code>AluA</code>的数据来源。</p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> ALU_A(</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">3</span>:<span class="number">0</span>] ALUop,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">6</span>:<span class="number">0</span>] OpCode,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] ReadData1,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] PCaddress,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] AluA</span><br><span class="line">);</span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">case</span>(ALUop)</span><br><span class="line">            <span class="number">3&#x27;b000</span>: AluA = ReadData1;   <span class="comment">// R-type</span></span><br><span class="line">            <span class="number">3&#x27;b001</span>: AluA = ReadData1;   <span class="comment">// I1-type</span></span><br><span class="line">            <span class="number">3&#x27;b010</span>: AluA = ReadData1;   <span class="comment">// I2-type</span></span><br><span class="line">            <span class="number">3&#x27;b011</span>: AluA = ReadData1;   <span class="comment">// S-type</span></span><br><span class="line">            <span class="number">3&#x27;b100</span>: AluA = ReadData1;   <span class="comment">// B-type</span></span><br><span class="line">            <span class="number">3&#x27;b101</span>: AluA = PCaddress;   <span class="comment">// J-type</span></span><br><span class="line">            <span class="number">3&#x27;b110</span>: <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">if</span>(OpCode == <span class="number">7&#x27;b0110111</span>) <span class="keyword">begin</span></span><br><span class="line">                    AluA = <span class="number">64&#x27;b0</span>;                       <span class="comment">// U-type(lui)</span></span><br><span class="line">                <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span>(OpCode == <span class="number">7&#x27;b0010111</span>)<span class="keyword">begin</span></span><br><span class="line">                    AluA = PCaddress;                   <span class="comment">// U-type(auipc)</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">default</span>: AluA = <span class="number">64&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>



<h4 id="ALU-B"><a href="#ALU-B" class="headerlink" title="ALU_B"></a>ALU_B</h4><blockquote>
<p>选择<code>AluB</code>的数据来源。</p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> ALU_B(</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">6</span>:<span class="number">0</span>] OpCode,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> ALUSrc,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] ReadData2,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] Imm,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] AluB</span><br><span class="line">);</span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span>(ALUSrc) <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">if</span>(OpCode == <span class="number">7&#x27;b1101111</span> || OpCode == <span class="number">7&#x27;b1100111</span>) <span class="keyword">begin</span>      <span class="comment">// J-type(jal, jalr)</span></span><br><span class="line">                AluB = <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">                AluB = Imm;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            AluB = ReadData2;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="ALU"><a href="#ALU" class="headerlink" title="ALU"></a>ALU</h4><blockquote>
<p>执行算术逻辑运算。</p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> ALU(</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] A,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] B,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">2</span>:<span class="number">0</span>] ALUfunc,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] result,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> Zero,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> SignedLess,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> UnsignedLess</span><br><span class="line">);</span><br><span class="line">    <span class="keyword">assign</span> Zero = (result == <span class="number">64&#x27;b0</span>);</span><br><span class="line">    <span class="keyword">assign</span> SignedLess = (<span class="built_in">$signed</span>(A) &lt; <span class="built_in">$signed</span>(B));</span><br><span class="line">    <span class="keyword">assign</span> UnsignedLess = (A &lt; B);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">case</span>(ALUfunc)</span><br><span class="line">            <span class="number">3&#x27;b000</span>: result = A + B;</span><br><span class="line">            <span class="number">3&#x27;b001</span>: result = A - B;</span><br><span class="line">            <span class="number">3&#x27;b010</span>: result = A &amp; B;</span><br><span class="line">            <span class="number">3&#x27;b011</span>: result = A | B;</span><br><span class="line">            <span class="number">3&#x27;b100</span>: result = A ^ B;</span><br><span class="line">            <span class="number">3&#x27;b101</span>: result = A &lt;&lt; B;</span><br><span class="line">            <span class="number">3&#x27;b110</span>: result = A &gt;&gt; B;</span><br><span class="line">            <span class="number">3&#x27;b111</span>: result = A &gt;&gt;&gt; B;</span><br><span class="line">        <span class="keyword">endcase</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>



<h4 id="DataMem"><a href="#DataMem" class="headerlink" title="DataMem"></a>DataMem</h4><blockquote>
<p>执行对数据内存的读写操作。</p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> DataMem(</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] Address,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] WriteData,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> MemWrite,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> MemRead,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">2</span>:<span class="number">0</span>] funct3,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] ReadData</span><br><span class="line">);</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">7</span>:<span class="number">0</span>] mem[<span class="number">0</span>:<span class="number">1023</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span>(MemWrite) <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">case</span>(funct3)</span><br><span class="line">                <span class="number">3&#x27;h0</span>: mem[Address] = WriteData[<span class="number">7</span>:<span class="number">0</span>];</span><br><span class="line">                <span class="number">3&#x27;h1</span>: &#123;mem[Address], mem[Address+<span class="number">1</span>]&#125; = WriteData[<span class="number">15</span>:<span class="number">0</span>];</span><br><span class="line">                <span class="number">3&#x27;h2</span>: &#123;mem[Address], mem[Address+<span class="number">1</span>], mem[Address+<span class="number">2</span>], mem[Address+<span class="number">3</span>]&#125; = WriteData[<span class="number">31</span>:<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">endcase</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span>(MemRead) <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">case</span>(funct3)</span><br><span class="line">                <span class="number">3&#x27;h0</span>: ReadData = &#123;&#123;(<span class="number">64</span> - <span class="number">8</span>)&#123;mem[Address][<span class="number">7</span>]&#125;&#125;, mem[Address]&#125;;</span><br><span class="line">                <span class="number">3&#x27;h1</span>: ReadData = &#123;&#123;(<span class="number">64</span> - <span class="number">16</span>)&#123;mem[Address][<span class="number">7</span>]&#125;&#125;, mem[Address], mem[Address+<span class="number">1</span>]&#125;;</span><br><span class="line">                <span class="number">3&#x27;h2</span>: ReadData = &#123;&#123;(<span class="number">64</span> - <span class="number">32</span>)&#123;mem[Address][<span class="number">7</span>]&#125;&#125;, mem[Address], mem[Address+<span class="number">1</span>], mem[Address+<span class="number">2</span>], mem[Address+<span class="number">3</span>]&#125;;</span><br><span class="line">                <span class="number">3&#x27;h4</span>: ReadData = &#123;&#123;(<span class="number">64</span> - <span class="number">8</span>)&#123;<span class="number">1&#x27;b0</span>&#125;&#125;, mem[Address]&#125;;</span><br><span class="line">                <span class="number">3&#x27;h5</span>: ReadData = &#123;&#123;(<span class="number">64</span> - <span class="number">16</span>)&#123;<span class="number">1&#x27;b0</span>&#125;&#125;, mem[Address], mem[Address+<span class="number">1</span>]&#125;;</span><br><span class="line">            <span class="keyword">endcase</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>



<h4 id="Conditional"><a href="#Conditional" class="headerlink" title="Conditional"></a>Conditional</h4><blockquote>
<p>根据ALU计算得到的符号位<code>Zere</code>、<code>SignedLess</code>、<code>UnsignedLess</code>，判断是否跳转，得到<code>CndCode</code>。</p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> Conditional(</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> Branch,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> Zero,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> SignedLess,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> UnsignedLess,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">2</span>:<span class="number">0</span>] funct3,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> CndCode        <span class="comment">// 是否满足条件跳转</span></span><br><span class="line">);</span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span>(Branch) <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">case</span>(funct3)</span><br><span class="line">                <span class="number">3&#x27;h0</span>: <span class="keyword">if</span>(Zero) CndCode = <span class="number">1&#x27;b1</span>;  <span class="comment">// beq</span></span><br><span class="line">                <span class="number">3&#x27;h1</span>: <span class="keyword">if</span>(!Zero) CndCode = <span class="number">1&#x27;b1</span>;   <span class="comment">// bne</span></span><br><span class="line">                <span class="number">3&#x27;h4</span>: <span class="keyword">if</span>(SignedLess) CndCode = <span class="number">1&#x27;b1</span>;   <span class="comment">// blt</span></span><br><span class="line">                <span class="number">3&#x27;h5</span>: <span class="keyword">if</span>(!SignedLess) CndCode = <span class="number">1&#x27;b0</span>;   <span class="comment">// bge</span></span><br><span class="line">                <span class="number">3&#x27;h6</span>: <span class="keyword">if</span>(UnsignedLess) CndCode = <span class="number">1&#x27;b1</span>;   <span class="comment">// bltu</span></span><br><span class="line">                <span class="number">3&#x27;h7</span>: <span class="keyword">if</span>(!UnsignedLess) CndCode = <span class="number">1&#x27;b1</span>;   <span class="comment">// bgeu</span></span><br><span class="line">                <span class="keyword">default</span>: CndCode = <span class="number">1&#x27;b0</span>;</span><br><span class="line">            <span class="keyword">endcase</span></span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            CndCode = <span class="number">1&#x27;b0</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>



<h4 id="RegBack"><a href="#RegBack" class="headerlink" title="RegBack"></a>RegBack</h4><blockquote>
<p>选择写回寄存器的数据来源。</p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> RegBack(</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> MemRead,</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] ReadData,    <span class="comment">// 从内存中读出的数据</span></span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] ALUresult,</span><br><span class="line">    <span class="keyword">output</span> <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] WriteData</span><br><span class="line">);</span><br><span class="line">    <span class="keyword">always_comb</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span>(MemRead)<span class="keyword">begin</span></span><br><span class="line">            WriteData = ReadData;</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></span><br><span class="line">            WriteData = ALUresult;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>



<h4 id="arch"><a href="#arch" class="headerlink" title="arch"></a>arch</h4><blockquote>
<p>在顶层模块，完成连线。</p>
</blockquote>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> arch(</span><br><span class="line">    <span class="keyword">input</span> <span class="keyword">logic</span> CLK</span><br><span class="line">);</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] PCaddress;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] PCnext;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] PCincrement;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">        PCaddress = <span class="number">64&#x27;b0</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    PC pc(</span><br><span class="line">        <span class="variable">.clk</span>(CLK),</span><br><span class="line">        <span class="variable">.PCnext</span>(PCnext),</span><br><span class="line">        <span class="variable">.PCaddress</span>(PCaddress)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    PCincrement pcincrement(</span><br><span class="line">        <span class="variable">.PCaddress</span>(PCaddress),</span><br><span class="line">        <span class="variable">.PCincrement</span>(PCincrement)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">6</span>:<span class="number">0</span>] OpCode;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>] Rs1;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>] Rs2;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">4</span>:<span class="number">0</span>] Rd;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">31</span>:<span class="number">0</span>] Inst;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] Imm;</span><br><span class="line"></span><br><span class="line">    InstMem instmem(</span><br><span class="line">        <span class="variable">.PCaddress</span>(PCaddress),</span><br><span class="line">        <span class="variable">.OpCode</span>(OpCode),</span><br><span class="line">        <span class="variable">.Rs1</span>(Rs1),</span><br><span class="line">        <span class="variable">.Rs2</span>(Rs2),</span><br><span class="line">        <span class="variable">.Rd</span>(Rd),</span><br><span class="line">        <span class="variable">.Inst</span>(Inst)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">logic</span> RegWrite;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] WriteData;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] ReadData1;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] ReadData2;</span><br><span class="line"></span><br><span class="line">    RegFile regfile(</span><br><span class="line">        <span class="variable">.clk</span>(CLK),</span><br><span class="line">        <span class="variable">.ReadReg1</span>(Rs1),</span><br><span class="line">        <span class="variable">.ReadReg2</span>(Rs2),</span><br><span class="line">        <span class="variable">.WriteReg</span>(Rd),</span><br><span class="line">        <span class="variable">.RegWrite</span>(RegWrite),</span><br><span class="line">        <span class="variable">.WriteData</span>(WriteData),</span><br><span class="line">        <span class="variable">.ReadData1</span>(ReadData1),</span><br><span class="line">        <span class="variable">.ReadData2</span>(ReadData2)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    ImmGen immgen(</span><br><span class="line">        <span class="variable">.Inst</span>(Inst),</span><br><span class="line">        <span class="variable">.Imm</span>(Imm)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">logic</span> Branch;</span><br><span class="line">    <span class="keyword">logic</span> Jump;</span><br><span class="line">    <span class="keyword">logic</span> JumpReg;</span><br><span class="line">    <span class="keyword">logic</span> MemRead;</span><br><span class="line">    <span class="keyword">logic</span> MemWrite;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">2</span>:<span class="number">0</span>] ALUop;</span><br><span class="line">    <span class="keyword">logic</span> ALUSrc;</span><br><span class="line">    <span class="keyword">logic</span> Halt;</span><br><span class="line"></span><br><span class="line">    Control control(</span><br><span class="line">        <span class="variable">.OpCode</span>(OpCode),</span><br><span class="line">        <span class="variable">.Branch</span>(Branch),</span><br><span class="line">        <span class="variable">.Jump</span>(Jump),</span><br><span class="line">        <span class="variable">.JumpReg</span>(JumpReg),</span><br><span class="line">        <span class="variable">.MemRead</span>(MemRead),</span><br><span class="line">        <span class="variable">.MemWrite</span>(MemWrite),</span><br><span class="line">        <span class="variable">.ALUop</span>(ALUop),</span><br><span class="line">        <span class="variable">.ALUSrc</span>(ALUSrc),</span><br><span class="line">        <span class="variable">.RegWrite</span>(RegWrite),</span><br><span class="line">        <span class="variable">.Halt</span>(Halt)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">2</span>:<span class="number">0</span>] ALUfunc;</span><br><span class="line"></span><br><span class="line">    ALU_control alu_control(</span><br><span class="line">        <span class="variable">.ALUop</span>(ALUop),</span><br><span class="line">        <span class="variable">.funct3</span>(Inst[<span class="number">14</span>:<span class="number">12</span>]),</span><br><span class="line">        <span class="variable">.funct7_30</span>(Inst[<span class="number">30</span>]),</span><br><span class="line">        <span class="variable">.ALUfunc</span>(ALUfunc)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] AluA;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] AluB;</span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] ALUresult;</span><br><span class="line">    <span class="keyword">logic</span> Zero;</span><br><span class="line">    <span class="keyword">logic</span> SignedLess;</span><br><span class="line">    <span class="keyword">logic</span> UnsignedLess;</span><br><span class="line"></span><br><span class="line">    ALU_A alu_a(</span><br><span class="line">        <span class="variable">.ALUop</span>(ALUop),</span><br><span class="line">        <span class="variable">.OpCode</span>(OpCode),</span><br><span class="line">        <span class="variable">.ReadData1</span>(ReadData1),</span><br><span class="line">        <span class="variable">.PCaddress</span>(PCaddress),</span><br><span class="line">        <span class="variable">.AluA</span>(AluA)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    ALU_B alu_b(</span><br><span class="line">        <span class="variable">.OpCode</span>(OpCode),</span><br><span class="line">        <span class="variable">.ALUSrc</span>(ALUSrc),</span><br><span class="line">        <span class="variable">.ReadData2</span>(ReadData2),</span><br><span class="line">        <span class="variable">.Imm</span>(Imm),</span><br><span class="line">        <span class="variable">.AluB</span>(AluB)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    ALU alu(</span><br><span class="line">        <span class="variable">.A</span>(AluA),</span><br><span class="line">        <span class="variable">.B</span>(AluB),</span><br><span class="line">        <span class="variable">.ALUfunc</span>(ALUfunc),</span><br><span class="line">        <span class="variable">.result</span>(ALUresult),</span><br><span class="line">        <span class="variable">.Zero</span>(Zero),</span><br><span class="line">        <span class="variable">.SignedLess</span>(SignedLess),</span><br><span class="line">        <span class="variable">.UnsignedLess</span>(UnsignedLess)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">logic</span> [<span class="number">63</span>:<span class="number">0</span>] ReadData;      <span class="comment">// 从内存中读出的数据</span></span><br><span class="line"></span><br><span class="line">    DataMem datamem(</span><br><span class="line">        <span class="variable">.Address</span>(ALUresult),</span><br><span class="line">        <span class="variable">.WriteData</span>(ReadData2),</span><br><span class="line">        <span class="variable">.MemWrite</span>(MemWrite),</span><br><span class="line">        <span class="variable">.MemRead</span>(MemRead),</span><br><span class="line">        <span class="variable">.funct3</span>(Inst[<span class="number">14</span>:<span class="number">12</span>]),</span><br><span class="line">        <span class="variable">.ReadData</span>(ReadData)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    RegBack regback(</span><br><span class="line">        <span class="variable">.MemRead</span>(MemRead),</span><br><span class="line">        <span class="variable">.ReadData</span>(ReadData),</span><br><span class="line">        <span class="variable">.ALUresult</span>(ALUresult),</span><br><span class="line">        <span class="variable">.WriteData</span>(WriteData)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">logic</span> CndCode;</span><br><span class="line"></span><br><span class="line">    Conditional conditional(</span><br><span class="line">        <span class="variable">.Branch</span>(Branch),</span><br><span class="line">        <span class="variable">.Zero</span>(Zero),</span><br><span class="line">        <span class="variable">.SignedLess</span>(SignedLess),</span><br><span class="line">        <span class="variable">.UnsignedLess</span>(UnsignedLess),</span><br><span class="line">        <span class="variable">.funct3</span>(Inst[<span class="number">14</span>:<span class="number">12</span>]),</span><br><span class="line">        <span class="variable">.CndCode</span>(CndCode)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    PCNext pcnext(</span><br><span class="line">        <span class="variable">.PCaddress</span>(PCaddress),</span><br><span class="line">        <span class="variable">.PCincrement</span>(PCincrement),</span><br><span class="line">        <span class="variable">.Imm</span>(Imm),</span><br><span class="line">        <span class="variable">.Rs1</span>(ReadData1),</span><br><span class="line">        <span class="variable">.Jump</span>(Jump),</span><br><span class="line">        <span class="variable">.JumpReg</span>(JumpReg),</span><br><span class="line">        <span class="variable">.CndCode</span>(CndCode),</span><br><span class="line">        <span class="variable">.Halt</span>(Halt),</span><br><span class="line">        <span class="variable">.PCnext</span>(PCnext)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>



<h3 id="正确性验证"><a href="#正确性验证" class="headerlink" title="正确性验证"></a>正确性验证</h3><p>为检验正确性，我向 InstMem 中写入了两条指令：</p>
<ul>
<li><p><code>lui x5, 0x12345	</code>：0x126802b7</p>
</li>
<li><p><code>add x7, x5, x6</code>：0x005303b3</p>
</li>
</ul>
<p>	</p>
<p>然后我们在 Vivado 中进行 synthesis 和 stimulation 。</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> sim();</span><br><span class="line">    <span class="keyword">logic</span> clk;</span><br><span class="line">    arch test(<span class="variable">.CLK</span>(clk));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">repeat</span> (<span class="number">20</span>) <span class="keyword">begin</span></span><br><span class="line">            clk = <span class="number">0</span>;</span><br><span class="line">            #<span class="number">5</span>;</span><br><span class="line">            clk = <span class="number">1</span>;</span><br><span class="line">            #<span class="number">5</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="built_in">$finish</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">initial</span> <span class="keyword">begin</span></span><br><span class="line">        <span class="built_in">$dumpfile</span>(<span class="string">&quot;test.vcd&quot;</span>);</span><br><span class="line">        <span class="built_in">$dumpvars</span>;</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到：指令都被正确解析。</p>
<p><img src="/2024/03/06/RV64%E5%8D%95%E5%91%A8%E6%9C%9FCPU/wave1.png" alt="波形图"></p>
<p>我们查看Regfile中的5号、7号寄存器。它们都被正确地写入和读取。</p>
<p><img src="/2024/03/06/RV64%E5%8D%95%E5%91%A8%E6%9C%9FCPU/wave2.png" alt="波形图2"></p>
<h3 id="注记"><a href="#注记" class="headerlink" title="注记"></a>注记</h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://xht03.github.io/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xht03">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="延绪的水上书">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/" class="post-title-link" itemprop="url">计算机网络·摘要</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-02-07 14:41:06" itemprop="dateCreated datePublished" datetime="2024-02-07T14:41:06+08:00">2024-02-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-02-17 20:52:38" itemprop="dateModified" datetime="2024-02-17T20:52:38+08:00">2024-02-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Computer-Network/" itemprop="url" rel="index"><span itemprop="name">Computer Network</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2024/02/07/计算机网络摘要/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="何为计算机网络"><a href="#何为计算机网络" class="headerlink" title="何为计算机网络"></a>何为计算机网络</h3><h4 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h4><p>目前还没有一个严格的定义，这里可以作如下理解：把分布在不同地理位置上的具有独立功能的多台计算机、终端及其附属设备在物理上互连，按照网络协议相互通信，以共享硬件、软件和数据资源为目的的系统称作计算机网络。</p>
<hr>
<h4 id="数据交换"><a href="#数据交换" class="headerlink" title="数据交换"></a>数据交换</h4><p>数据交换技术一般分为一下三种：</p>
<ul>
<li><strong>线路交换</strong>：通过网络中的结点在两个站之间建立一条专用的通信线路。（比如电话系统。在通话之前，通过用户的呼叫，如果呼叫成功，则从主叫端到被叫端就建立了一条物理通路，这样双方就能进行通话，当通话结束后双方挂机，这时为进行通话所建立起来的物理通路就自动拆除。）</li>
<li><strong>报文交换</strong>：对一些实时性要求不高的信息，可以采用报文交换。报文交换方式传输的单位是报文，在报文中包括要发送的正文信息和指明收发站的地址及其它控制信息。在报文交换中， 不需要在两个站之间建立一条专用通路。相反，发送站只要把一个目的地址附加在报文上，然后发送整个报文即可。报文从发送站到接收站，中间要经过多个结点，在这每个中间结点中，都要接收整个报文，暂存这个报文，然后转发到下一个结点。</li>
<li><strong>报文分组交换</strong>：是国际上计算机网络普遍采用的数据交换方式。发送站把一个要传送的报文分成若干段，每一段都作为报文分组的数据部分。由于报文分组交换允许每个报文分组走不同的路径，所以一个完整的报文分组还必须包括地址、分组编号、校验码等传输控制信息。</li>
</ul>
<p>线路交换安全性很高，不易监听和截获数据包；但是相对的成本高。报文交换成本虽低，但是中转站点都接收到完整的数据包，安全性低。报文分组交换则综合前两者的优点，成本低，且每个中转站点都只接受到部分数据包内容，安全性较高。</p>
<hr>
<h4 id="网络拓扑结构"><a href="#网络拓扑结构" class="headerlink" title="网络拓扑结构"></a>网络拓扑结构</h4><p>计算机网络拓扑结构一般有以下六种：</p>
<ul>
<li>星型拓扑结构</li>
<li>总线型拓扑结构</li>
<li>环形拓扑结构</li>
<li>树型拓扑结构</li>
<li>全互连型拓扑结构</li>
<li>混合型拓扑结构：比较常见的有 <em>星型总线</em> 拓扑和 <em>星型环</em> 拓扑。</li>
</ul>
<table>
<thead>
<tr>
<th align="center">拓扑结构</th>
<th align="center">图示</th>
</tr>
</thead>
<tbody><tr>
<td align="center">星型拓扑结构</td>
<td align="center"><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/stars.png" style="zoom:25%;"></td>
</tr>
<tr>
<td align="center">总线型拓扑结构</td>
<td align="center"><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/buses.png" style="zoom:25%;"></td>
</tr>
<tr>
<td align="center">环形拓扑结构</td>
<td align="center"><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/circles.png" style="zoom:25%;"></td>
</tr>
<tr>
<td align="center">树型拓扑结构</td>
<td align="center"><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/trees.png" style="zoom:25%;"></td>
</tr>
<tr>
<td align="center">全互连型拓扑结构</td>
<td align="center"><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/alls.png" style="zoom:25%;"></td>
</tr>
<tr>
<td align="center">混合型拓扑结构</td>
<td align="center"><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/congreted1.png" style="zoom:25%;"></td>
</tr>
</tbody></table>
<hr>
<h4 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h4><p>计算机网络一般分为一下两类：</p>
<ul>
<li>局域网LAN（local area network）</li>
<li>广域网WAN（wide area network）</li>
</ul>
<h3 id="网络的体系结构"><a href="#网络的体系结构" class="headerlink" title="网络的体系结构"></a>网络的体系结构</h3><h4 id="层次"><a href="#层次" class="headerlink" title="层次"></a>层次</h4><p>层次是人们对复杂问题处理的基本方法。将总体要实现的很多功能分配在不同层次中，对每个层次要完成的服务及服务要求都有明确规定。基本地：</p>
<ul>
<li>不同的系统分成相同的层次</li>
<li>不同系统的最低层之间存在着“物理” 通信</li>
<li>不同系统的对等层次之间存在着“虚拟” 通信</li>
<li>对不同系统的对等层之间的通信有明确的通信规定</li>
<li>高层使用低层提供的服务时，并不需要知道低层服务的具体实现方法</li>
</ul>
<p>最重要的是 <strong>OSI参考模型</strong>：它将计算机网络通信划分成了七个层次。（<em>有时为了简化：应用层+表示层+会话层，合称应用层</em> ）</p>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/OSI.png" alt="OSI"></p>
<hr>
<h4 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h4><p>接口是同一结点内相邻层之间交换信息的连接点。同一个结点的相邻层之间存在着明确规定的接口，低层向高层通过接口提供服务。（<em>只要接口条件不变、低层功能不变，低层功能的具体实现方法与技术的变化不会影响整个系统的工作</em> ）</p>
<hr>
<h4 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h4><p>网络协议是为网络数据交换而制定的规则、约定与标准。  </p>
<h3 id="计算机如何通信"><a href="#计算机如何通信" class="headerlink" title="计算机如何通信"></a>计算机如何通信</h3><h4 id="通俗理解"><a href="#通俗理解" class="headerlink" title="通俗理解"></a>通俗理解</h4><ul>
<li>在现实中，我们如果要给对方写信，除了信件内容以外，我们还需要填写信封。信封有两个重要信息，一个是收件地址，另一个是收件人。收件地址表示这封信要寄到哪里，收件人表示信要寄给谁。同理，在网络世界中，我们如果要发信息给别人，同样需要收件地址和收件人，而这里就是MAC地址和IP地址。<strong>MAC地址就是收件地址，IP地址就是收件人</strong>。</li>
</ul>
<img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/mac.png">

<ul>
<li><p>如果把网络比作我们生活的城市，<strong>网卡就是我们居住的一栋栋建筑，MAC地址就是这栋建筑的物理地址，而IP地址就是住在这些建筑里的人</strong>。不同于写信，在计算机网络中发送信息，我们只需要填写内容和对方的IP地址。操作系统会通过查询ARP表自动获取对方的mac地址，补齐这封信，并从网卡发送出去。</p>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/ip.png"></p>
</li>
</ul>
<hr>
<h4 id="MAC地址"><a href="#MAC地址" class="headerlink" title="MAC地址"></a>MAC地址</h4><p>虽然计算机、手机、电视机等是不同类型的电子设备，但它们的通讯都是通过内部的网卡设备来进行。<strong>每张网卡在出厂使都被写入一个MAC地址</strong>。该地址由6个字节构成：前3个字节是网络硬件厂商编号，后3个字节是该厂商所制造的网卡的序列号。所以每个mac地址都是全球唯一的。</p>
<hr>
<h4 id="IP地址"><a href="#IP地址" class="headerlink" title="IP地址"></a>IP地址</h4><p>IP地址有两种：</p>
<ul>
<li>IPV4地址：由4个0~255的数字构成，用小数点间隔开。ipv4地址理论上有42亿个，但由于早期编码和分配的问题，很多区间的编码实际上被空出或不能使用。ipv4地址也在2011年被全部使用。</li>
<li>IPV6地址：128位。</li>
</ul>
<hr>
<h4 id="DHCP协议"><a href="#DHCP协议" class="headerlink" title="DHCP协议"></a>DHCP协议</h4><p>你可能会困惑：我的电脑接上网线，或是手机接上路由器之后，并没有要求我配置IP地址也能正常使用？这是因为<strong>DHCP协议</strong>自动帮我们配置了IP地址。</p>
<p>我们有两种方式配置IP地址：</p>
<ul>
<li>手动配置：自己设置IP地址、子网掩码、默认网关等信息。这种方式的好处在于可以根据自己的规划，设置每台设备的固定IP，有利于网络的统一管理。</li>
<li>动态获取：根据DHCP协议，我们根本不需要关心设备的IP是多少，自动分配一个IP就好了。</li>
</ul>
<p>粗略地讲。当电脑插上网线或是手机连上wifi，操作系统网络协议栈会自动向外发送一包DHCP请求，请求为其分配IP地址。路由器获取到DHCP请求后，会为其分配一个IP地址，并通过DHCP回复报文发送回去。操作系统收到DHCP回包后，将其分配的IP地址配置到网卡上。注意，<strong>在一个 <em>局域网</em> 中，IP地址是唯一的</strong>。路由器不会分配重复的IP地址给不同的设备。</p>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/dhcp.png"></p>
<p>完整流程略有不同。计算机通过网线连接到路由器上，当电脑开机进入操作系统后，此时其还没有IP地址。操作系统会使用UDP协议向外广播 <em>DHCP Discover数据包</em> ，寻找DHCP服务器。网络中的所有设备都能会收到这一数据包，但只有DHCP服务器会做出响应。在家庭网络中，路由器就是DHCP服务器。路由器在自己的IP地址池中选出空余的IP，并决定分配给计算机。路由器会把此IP封装成 <em>DHCP offer包</em> ，回复给计算机。计算机收到DHCP offer包，需要考虑是否使用该IP。这是因为网络中可能有多个DHCP服务器，它们都收到了计算机的DHCP请求，都为其分配了IP。一般情况下，计算机会使用第一个收到的DHCP offer包。之后，计算机会广播自己的决定，这个数据包称为 <em>DHCP Request包</em> 。路由器接收到request包之后，会回复一个 <em>ACK包</em> ，表示已接受计算机的选择，并确认此IP可用。</p>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/dhcp2.png"></p>
<p>前两步并不是必须的。当计算机申请过IP，计算机重启后，计算机无需重新获取IP地址，只需要再次确认就可以了，也就是从第三步开始。</p>
<p>注意，<strong>DHCP协议是应用层协议</strong>。</p>
<hr>
<h4 id="ARP协议"><a href="#ARP协议" class="headerlink" title="ARP协议"></a>ARP协议</h4><p>我们提到MAC地址是由操作系统来补齐的，那操作系统是怎么知道对方的MAC地址的呢？</p>
<p>在现实中写信，有两个关键的字段需要填写：收件人、收件地址。假设我想给好朋友ter写一封信，但是我不知道收件地址。此时信是寄不到的，怎么办呢？我应该先打电话给ter，询问他的收件地址，再填写到我的信件上。在计算机网络中的通信亦是如此。ARP协议就是帮我们打电话给目标IP并查询它的MAC地址。<strong>ARP协议（地址解析协议）就是通过IP地址来查询MAC地址的协议</strong>。</p>
<p>当计算机A想向计算机B发送信息时：A并不会立即发出，而是先广播一包ARP请求报文，来问一下计算机B的MAC地址是多少。此时网络中的所有设备都收到了这一包请求报文。除了计算机B以外的所有设备都会丢弃这包报文，只有计算机B会回复自己的MAC地址是多少。计算机A收到复后，首先会把计算机B的MAC地址缓存起来，以便下次使用。然后计算机A再将MAC地址添加进报文头部，通过网卡发送出去。</p>
<p>并不是每次发送信息都需查询这个步骤。每次查询到的MAC地址会存入<strong>ARP表</strong>，以便下次使用。只有ARP表中查无此人人时，才会进行查询。</p>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/arp2.png"></p>
<p><strong>ARP协议是数据链路层协议</strong>。在被广播的ARP请求报文中，网络层的ARP协议中的目标MAC地址会全填0，表示请求。但数据链路层的目标MAC地址则全是1，表示进行广播。</p>
<p>你可能困惑：现实生活中，我的好朋友ter可能搬家，那搬家之后，我照着之前的地址写信不就寄错了吗？计算机网络中也是同理，尽管MAC地址时固定的，但是IP地址是可以修改的。对此，解决方案也很简单：ter主动向所有人广播自己的新地址。</p>
<p>实际上，<strong>当计算机修改IP地址后，操作系统会主动向网络中广播一包ARP数据包</strong>。此数据包不需要回复，目的是告诉网络中的所有其他主机：当前IP地址和MAC地址的绑定关系。每一台收到ARP数据包的主机，会更新自己的ARP表。</p>
<hr>
<h4 id="ARP攻击"><a href="#ARP攻击" class="headerlink" title="ARP攻击"></a>ARP攻击</h4><p>假设我们有如下网络。无论是TCP协议还是UDP协议，主机A若想与互联网通信，都要通过路由器。亦即：主机A上的所有数据包的数据链路层的目标MAC地址都是路由器的MAC地址。当然，这个MAC地址也是通过ARP协议查询网关IP得到的。</p>
<p>假设此时网络中的另一台主机C，向网络中广播一包ARP报文。它在报文中伪造其IP地址是网关地址，MAC地址是主机C的MAC地址。这相当于告诉网络中的其他主机：“网关IP在我这里！”于是其他所有主机会更新各自的ARP表，并认为主机C是网关，把数据包发送到主机C。于是，整个网络中的主机都无法连接互联网。这就是<strong>ARP攻击</strong>。</p>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/attack.png"></p>
<h3 id="网络间如何通信"><a href="#网络间如何通信" class="headerlink" title="网络间如何通信"></a>网络间如何通信</h3><h4 id="子网划分"><a href="#子网划分" class="headerlink" title="子网划分"></a>子网划分</h4><p>我们将<strong>IP地址与子网掩码按位相与</strong>。如果两个IP地址 <em>与子网掩码相与的结果</em> 相同，就认为它们在同一子网中。</p>
<p>由于子网掩码都是由连续的1和连续的0组成，我们常用1的数量来表示子网掩码。因此，我们用<strong>IP&#x2F;子网掩码</strong>来表示一个网络。（常用的子网掩码如255.255.255.0）</p>
<p>如果想扩大网络中IP地址数量，只需调小子网掩码，亦即减少子网掩码中1的个数。反之，如果想缩小网络中IP地址数量，只需调大子网掩码，亦即增加子网掩码中1的个数。（比如：192.168.1.0&#x2F;24这个网络中有255个IP地址）</p>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/subnet.png"></p>
<hr>
<h4 id="网关"><a href="#网关" class="headerlink" title="网关"></a>网关</h4><p>根据TCP&#x2F;IP协议，不同子网之间是不能直接通信的。如果要通信，则需要通过网关来进行转发。</p>
<p>网关上有两张网卡，分别配置了属于两个不同子网的IP地址，从而可以在两个网络间转发数据包。</p>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/customs.png"></p>
<p> 举一个简单的例子。子网1中的计算机a发送数据包时，首先会根据目标IP地址，判断其是否与自己处于同一子网。如果属于同一子网，则直接从计算机a的网卡发出。若不是同一子网，则需要把数据包的目标MAC地址改为网关MAC地址，然后发送给网关。网关拿到数据包后，查询 <em>路由表</em> ，知道这包数据属于子网2。网关把目标MAC地址修改计算机b的MAC地址，把源MAC地址修改成自己的MAC地址。然后网卡把数据包从子网2的网卡发出。以上<strong>根据目标IP判断如何发送</strong>的行为，我们称之为“<strong>路由</strong>”。</p>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/road.png"></p>
<hr>
<h4 id="交换机"><a href="#交换机" class="headerlink" title="交换机"></a>交换机</h4><p><strong>交换机负责把数据包发送到正确的位置</strong>。在写信的例子中，<strong>交换机相当于邮递员</strong>。交换机根据数据包中的目标MAC地址，找到它对应的物理端口。一台交换机有很多个端口，它们有自己的编号。计算机的网卡通过网线连接到交换机的网口上，这样每个端口都是一个确定的物理位置。我们只需要知道某个MAC地址在哪个端口上，就能正确地把数据包发给目标MAC地址。所以在交换机中，有一张端口与MAC地址地映射关系表，交换机维护这个映射关系。</p>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/postman.png"></p>
<p>每一包数据都有两个MAC地址：源MAC地址（发送方）、目标MAC地址（接收方）。交换机收到一包数据后，首先把这包数据的源MAC与接受端口进行绑定，填入MAC地址表。然后交换机查找目标MAC地址，确定从哪个端口发送出去（发出端口）。如果MAC地址表中查询到了关联端口，则直接从关联端口发出。若没有查找到关联端口，则向除了接受端口外的所有端口群发。这种行为称之为“<strong>泛洪</strong>”。如果目标MAC地址在这个网络中，则它一定能收到群发的数据包。如此运行一段时间后，交换机的MAC地址表就涵盖网络中的所有网卡设备。由此可见，<strong>交换机只关心MAC地址，不关心IP地址</strong>。</p>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/switch.png"></p>
<p><strong>MAC地址在TCP&#x2F;IP协议中处于第二层（数据链路层）</strong>，因此交换机通常也称为二层设备。</p>
<hr>
<h4 id="路由器"><a href="#路由器" class="headerlink" title="路由器"></a>路由器</h4><p><strong>如果忽略路由器的WAN口，那么路由器其实就是一台交换机</strong>。</p>
<p> 路由器有两种接口：</p>
<ul>
<li>LAN口：可以多个，用于连接家庭网络设备（比如台式机、手机、笔记本，其中手机、笔记本是通过wifi连接到路由器的）。</li>
<li>WAN口：只有一个，连接到运营商网络，从而连接到互联网中。</li>
</ul>
<p>路由器通过LAN口接入内网，通过WAN口接入互联网。它们属于两个不同的子网。所以，从内网访问互联网就是跨网络的行为，这就需要<strong>路由器担任网关的角色</strong>。</p>
<hr>
<h4 id="SNAT技术"><a href="#SNAT技术" class="headerlink" title="SNAT技术"></a>SNAT技术</h4><p>尽管同一子网中的IP地址互不相同，但是不同子网中的IP地址可能相同。那么当不同家庭内网中的两台计算机拥有相同的IP时，如果它们同时访问互联网，就会造成IP冲突，使得ARP表混乱，使得通信目标变得不确定。为了解决这一问题，我们采用了<strong>源地址转换技术（SNAT）</strong>。</p>
<p>首先计算机发送一包数据，到达路由器。在这包数据的网络层，有两个重要信息：源IP、目标IP。<strong>路由器执行SNAT，将源IP修改成路由器WAN口的公网IP，再将数据包发送到服务器</strong>。服务器收到数据包后进行处理，在发送数据包到路由器，以进行回复。路由器再进行反向SNAT操作，把目标IP修改成计算机a的IP。</p>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/simpled.png"></p>
<p>这是简化的网络通信模型，真实情况会更复杂一些。</p>
<p>假设同一子网中两台计算机同时访问同一个服务器，服务器会回复两个数据包分别给两台计算机。但两个数据包的源IP都是服务器IP，目标IP都是路由器的公网IP。那么，路由器如何判断两个数据包分别该给谁呢？</p>
<p>所以，只关注IP地址（网络层）是不够的，还需要其他确定性标记。这是就需要把关联的属性扩展到下一层（传输层）。</p>
<p>我们以最常见的 <em>传输层协议TCP协议</em> 为例。TCP协议有两个关键的属性：源端口、目标端口。这时我们的SNAT技术就变成：<strong>修改源IP地址和源端口</strong>，并将 <em>修改后的端口号</em> 和 <em>源IP+源端口</em> 形成映射关系。</p>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/completed.png"></p>
<p>除了TCP协议以外， <em>UDP协议</em> 也是同理：IP地址+端口号。但是ping命令（常用来检查目标联通性）采用的是 <em>ICMP协议</em> 。它没有端口信息，则需要使用协议中的type+code，来代替端口进行关联。</p>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/protocol.png"></p>
<hr>
<h4 id="DNAT技术"><a href="#DNAT技术" class="headerlink" title="DNAT技术"></a>DNAT技术</h4><p>DNAT名为目标地址转换。顾名思义，DNAT是修改目标地址。</p>
<p>如果我们的内网计算机对外提供服务，公网上发送来的请求不能直接到达内网计算机。我们就需要用DNAT技术向内网转发请求。</p>
<p>假设我们内网的一台主机上有一个web服务，正在监听某个端口。我们需要在路由器上配置一个DNAT，作用为：访问 <em>公网IP的某个端口</em> 就转接到 <em>主机IP的对应端口</em> 。则当返回问数据包从WAN口进入后，路由器执行DNAT：<strong>修改目标IP、目标端口</strong>。</p>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/DNAT.png"></p>
<p>DNAT技术和SNAT技术统称为<strong>NAT技术</strong>，将网络一层层分隔开，同时实现不同网络间的通信。</p>
<hr>
<h4 id="ICMP协议"><a href="#ICMP协议" class="headerlink" title="ICMP协议"></a>ICMP协议</h4><p>ping命令使用ICMP协议，全称：<strong>互联网控制消息协议</strong>。其作用：检测网络中的各种问题，然后做出诊断和解决。它有两大功能：</p>
<ul>
<li>询问报告：询问目标主机是否可以连通，例如<code>ping</code>命令。</li>
<li>差错报告：当目标网络、或目标端口不可达时，向主机报告错误，例如<code>traceroute</code>命令。</li>
</ul>
<p><code>ping</code>命令执行流程：</p>
<ul>
<li><p>记录当前时间，并构建ICMP报文。ICMP报文关键字段如下图。其中请求报文的ICMP类型是8。</p>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/icmp.png"></p>
</li>
<li><p>操作系统会发送ICMP查询报文。如果目标存在，目标主机会构造一包回复报文，并发送会源主机。回复报文的ICMP类型为0。</p>
</li>
<li><p>源主机接收ICMP回复报文。（也可能没有收到回复）</p>
</li>
<li><p>再次记录当前时间，并与之前记录的时间做差，计算得到延迟时间。</p>
</li>
</ul>
<p>注意：如果目标主机不存在、或回复报文丢失：源主机则会等待一段时间后超时，报告目标主机无法连通。</p>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/ping.png"></p>
<p><code>ping</code>命令只能检测两台主机是否连通。而<code>traceroute</code>命令可以知道从源主机到目标主机之间经历了哪几个网关的转发、以及这些网关的IP地址。因此，<code>traceroute</code>指令可以帮助我们了解复杂网络的拓扑结构。</p>
<p><code>traceroute</code>如何做到的呢？</p>
<p>在网络层的IP数据包头中，有一个<strong>TTL字段：表示此帧数据可经过的最大节点数</strong>。假设发送一帧 TTL &#x3D; 2 的数据包，则其每经过一个网关，TTL减少1。它到达第二个网关时，TTL &#x3D; 0。此时网关不能再向前发送数据包，只能丢弃数据包，并通过ICMP协议向源主机报告错误。这即是ICMP的差错报告功能之一。</p>
<p><code>traceout</code>依次发送TTL &#x3D; 1、2、3……的 <em>UDP报文</em> ，源主机通过回复报文依次知道第1、2、3……个网关的IP地址，并计算出其延时。直到TTL为某个值时，UDP报文发送到目标主机。</p>
<p>这时，目标主机既不需要再向前转发，也因TTL &#x3D; 0而不需要回复ICMP差错报文。那么源主机怎么知道UDP报文已经抵达目标主机呢？</p>
<p>这是由于源主机构造UDP报文时将目标端口设置为一个很大的值，即：一个不存在的目标端口。所以目标主机同样会回复 <em>因目标端口不可达而产生</em> 的ICMP差错报文。源主机收到报文后，即可知道目标主机已到达。</p>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/traceroute.png"></p>
<h3 id="传输层协议"><a href="#传输层协议" class="headerlink" title="传输层协议"></a>传输层协议</h3><h4 id="通俗理解-1"><a href="#通俗理解-1" class="headerlink" title="通俗理解"></a>通俗理解</h4><p><strong>TCP协议</strong>和<strong>UDP协议</strong>都工作在传输层，作用都是<strong>在程序之间传输数据</strong>。数据可以是文本文件、视频、图片。对TCP和UDP来说，数据都是一堆二进制数，并无区别。TCP和UDP之间最大的区别在于：<strong>TCP基于连接，UDP基于非连接</strong>。</p>
<p>做一个简单的比喻。如果把人与人之间的通信比喻为进程与进程之间的通信，我们基本有两种方式：写信、打电话。<strong>TCP是打电话，UDP则是写信</strong>。写信时，我们关心：对方是否收到、内容是否完整、顺序是否正确（当我们寄出多封信时）。但这些都是无法确定的，甚至我们都无法确认收信人、收信地址是真实存在的。与此不同，打电话的整个流程（电话接通、相互通话、通话挂断）都能得到及时的反馈，并且能确认对方准确的接收到。</p>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/phone.png"></p>
<hr>
<h4 id="TCP-协议"><a href="#TCP-协议" class="headerlink" title="TCP 协议"></a>TCP 协议</h4><p>TCP有三个关键步骤：<strong>三次握手</strong>、<strong>传输确认</strong>、<strong>四次挥手</strong>。</p>
<p><strong>三次握手是建立连接的过程</strong>。当客户端向服务端发起连接时，客户端会先发一包数据请求连接，询问能否与服务端建立连接。这包数据称为 <em>SYN包</em> 。如果对端同意连接，则回复一包 <em>SYN+ACK包</em> 。客户端收到回复后，再发送 <em>ACK包</em> ，就能建立连接。因为该过程中相互发送了三包数据，所以称作“三次握手”。</p>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/handshakes.png"></p>
<p>你可能会困惑：为什么要三次握手而不是两次握手呢？这是为了防止已失效的请求报文突然又传到服务器而引起错误。<strong>三次握手本质上是为了在不可靠的网络信道上建立起可靠的连接</strong>。</p>
<p>举一个简单的例子。假设采用两次握手。假设客户端向服务器发送了SYN1包请求建立连接，但由于某种原因（比如在中间的某个网络结点发生了滞留），SYN1包没有发送到服务器。于是客户端会重新发送SYN2包请求建立连接，这次服务器收到并成功地与客户端建立了连接。之后SYN1包又到达了服务端，服务器会以为是客户端希望建立新的连接，于是发送SYN+ACK包，从而服务端在以上两次握手之后进入等待数据状态。服务端认为是2个连接，而客户端认为是1个连接，造成状态不一致。如果是三次握手，服务端最后收不到客户端发送的ACK包，便不会认为连接建立成功。</p>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/connect.png"></p>
<p>经历三次握手之后，客户端和服务端都进入数据传输状态。现在有两个问题需要解决：丢包问题（一包数据可能拆成多包数据进行传输）、乱序问题（这些数据包到达的顺序可能不同）。“<strong>传输确认</strong>”就是为解决这些问题。</p>
<p>以下过程不区分客户端、服务端，两端均采用下述机制。</p>
<p>TCP协议为每一个连接建立一个发送缓冲区。从建立连接后的第一个字节的序列号为0，往后每个字节的序列号就会增加1。发送数据时，取一部分数据组成发送报文，在其TCP协议头中会附带：序列号、数据长度。接收端在收到数据后需要回复确认报文，确认报文中的 <em>ACK &#x3D; 序列号 + 长度 &#x3D; 下一包数据的起始序列号</em> 。如此一问一答的发送方式能让发送端确认数据已经被对方接受。发送端也可以一次发送连续的多包数据，接收端只需要回复一次ACK即可。这样发送端可以把数据切割成一系列待发送的碎片，依次发送到对端。根据序列号和长度，对端能重组出完整的数据。即使其中丢失了某些数据包，接收端也可以要求发送端重传，发送 <em>ACK &#x3D; 丢失序列包其实序列号</em> 。</p>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/confirm.png"></p>
<p><strong>四次挥手是关闭连接的过程</strong>。客户端和服务端都可以发起关闭连接请求。</p>
<p>假设客户端想关闭连接，它需要向服务端发送一包数据，称为 <em>FIN包</em> ，表示要终止连接，然后客户端进入 <em>终止等待1状态</em> 。这是第一次挥手。</p>
<p>服务端收到FIN包，回复一包 <em>ACK包</em> ，表示自己进入了 <em>关闭等待状态</em> 。客户端收到ACK包，进入 <em>关闭等待2状态</em> 。这是第二次挥手。此时服务端还可以发送未发送的数据，客户端也还可以接受数据。</p>
<p>当服务端发送完数据后，服务端发送一包FIN包，进入 <em>最后确认状态</em> 。这是第三次挥手。</p>
<p>客户端收到FIN包后，回复一包ACK包，进入 <em>超时等待状态</em> 。经过超时时间后，客户端关闭连接。而服务端在收到ACK包时，立即关闭连接。</p>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/wave.png"></p>
<p>你可能会困惑：为什么客户端需要超时时间等待？这是为了确保对方已收到ACK包。<strong>四次挥手也是为了在不可靠的网络链路中实现可靠的连接断开确认</strong>。</p>
<p>举一个简短的例子。假设客户端发送完最后一包ACK包后就释放了连接。一旦ACK包在网络中丢失，服务端将一直停留在最后确认状态。相反，如果客户端在发送完ACK包之后等待一段时间，这时服务端因为没有收到ACK包而重发FIN包。客户端会重发ACK包并刷新超时时间。</p>
<hr>
<h4 id="UDP协议"><a href="#UDP协议" class="headerlink" title="UDP协议"></a>UDP协议</h4><p>UDP协议发送数据就是<strong>简单地把数据包封装一下，然后从网卡发出去</strong>。数据包之间并没有状态上的联系。</p>
<p>正因为UDP这种简单的处理方式，UDP的性能损耗少，占用CPU资源也少。但对于丢包问题，UDP协议并不能保证。因此，UDP在传输稳定性上不如TCP。综上，<strong>TCP常适用于对网络通讯质量要求较高的场景</strong>：传输文件、发送邮件、浏览网页等；<strong>UDP则适用于对实时性要求较高，但是少量丢包并无大影响的场景</strong>：域名查询、语音通话、视频直播等。</p>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/contrast.png"></p>
<h3 id="应用层协议"><a href="#应用层协议" class="headerlink" title="应用层协议"></a>应用层协议</h3><h4 id="万维网"><a href="#万维网" class="headerlink" title="万维网"></a>万维网</h4><p><strong>万维网WWW（World Wide Web）</strong>，是一个遍布 Internet 的信息储藏所，是一种特殊的应用网络。它通过超级链接，将所有的硬件、软件、数据资源连成一个网络，用户可从一个站点轻易地转到另一个站点，非常方便地获取丰富的信息。</p>
<p>WWW服务的基础是<strong>Web页面</strong>，每个服务站点都包括若干个相互关联的页面，每个Web页既可展示文本、图形图像和声音等多媒体信息，又可提供一种特殊的链接点。这种链接点指向一种资源，可以是另一个Web页面、文件、Web站点，这样可使全球范围的WWW服务连成一体。这就是所谓的<strong>超文本和超链接技术</strong>。</p>
<p>超文本实际上是一种解决菜单与信息分离的机制，把可选菜单项嵌入文本中的概念称为“ 超文本” 。超文本技术采用指针连结的网状交叉索引方式，对不同来源的信息加以链接。亦即：<strong>一个超文本文件，含有多个指针，而指针可以指向任何形式的文件</strong>。正是这些指针指向的“纵横交错”，使得分布在本地的和远程的服务器上的文本文件连接在一起。</p>
<p>你可能会混淆：因特网（Internet）和万维网（Web）。它们有何不同呢？Internet本质上是一种广域网，连接着全球计算机。Internet支持各种各样的服务，其中一项则是Web服务。<strong>Web使用URL来定位资源，并用HTML语言渲染出网页</strong>。</p>
<hr>
<h4 id="URL"><a href="#URL" class="headerlink" title="URL"></a>URL</h4><p>当我们进入一个网页，地址栏就会出现一连串英文字母。它是什么呢？很多人称其为 <em>网址</em> ，但这并不准确。这其实是 <em>URL</em> 。</p>
<p>URL指<strong>统一资源定位符（Uniform Resource Locator）</strong>，它是用于标识和定位互联网上的资源的地址。URL 包含了访问资源所需的信息，通常包括：</p>
<ul>
<li><strong>协议类型</strong>：以双斜杠为分隔符，常用的有：”http” 、”https”。协议部分可以省略，浏览器默认“https”。</li>
<li><strong>主机名</strong>：即网址。例如 ：”<a target="_blank" rel="noopener" href="http://www.google.com" 、“101.188.67.134” ">www.google.com&quot;、“101.188.67.134”</a></li>
<li><strong>端口号</strong>：<em>port</em> 是服务器在其主机所使用的端口号。一般情况下端口号不需要指定，因为通常这些端口号都有一个默认值。只有当服务器所使用的端口号不是默认的端口号时才需要指定。</li>
<li><strong>路径</strong></li>
<li><strong>查询参数等</strong></li>
</ul>
<p><img src="/2024/02/07/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E6%91%98%E8%A6%81/url.png"></p>
<hr>
<h4 id="HTTP协议"><a href="#HTTP协议" class="headerlink" title="HTTP协议"></a>HTTP协议</h4><p>HTTP（Hyper Text Transfer Protocol）<strong>超文本传输协议</strong>是万维网客户端进程与服务器端进程交互遵守的协议。它是一个应用层的协议，<strong>使用TCP连接</strong>进行可靠的传输。 HTTP是万维网上资源传送的规则，是万维网能正常运行的基础保障。</p>
<p>HTTP的思想非常简单：客户给服务器发送请求， 服务器向客户发送响应， 在客户和服务器之间的HTTP事务有两种类型：<strong>请求</strong>和<strong>响应</strong>。</p>
<hr>
<h4 id="DNS协议"><a href="#DNS协议" class="headerlink" title="DNS协议"></a>DNS协议</h4><p>我们知道，IP地址才是每台计算机或服务器的唯一标识，但日常中我们更多地通过<strong>域名</strong>来访问服务器。计算机是如何通过域名知道IP地址的呢？这就是DNS协议（<strong>Domain Name System</strong>）。</p>
<p>通俗地讲。我们每天都用手机进行通信，打电话或者发短信。我们的联系人列表中可能有成千上万个手机号，所以记忆全部手机号是很困难的。于是我们就给每个手机号取名或写备注，比如我的好朋友ter的手机号是54250，则我就给54250取名为ter。下次打电话时，我只需要输入ter，而不需要输入54250，就能通信。这其中，<strong>电话号码就相当于IP地址，联系人名称就相当于域名</strong>。</p>
<p>当我们在浏览器中输入“Google.com”时，浏览器会解析这段网址，从中取出域名，然后组建一包DNS查询报文，并发送到主机的上一级DNS服务器。在开启DHCP协议时，DNS服务器IP地址是会自动获取的。在收到报文后，DNS服务器会在缓存的DNS池中查找域名“Google.com”的记录。如果查无此名，则会再向其更上一级的DNS服务器发送查询报文。最后DNS服务器会返回查找到的IP地址，或者返回“查询失败”。</p>
<p><strong>浏览器并不是每次输入域名都需要查询其IP</strong>。它会缓存DNS记录，并在一定时间内直接使用这些记录（只有超过一定时间后，才会再次查询）。</p>
<p>DNS服务器有复杂的上下级关系、结构。这里就不展开。</p>
<hr>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://xht03.github.io/2024/02/04/Shell%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="xht03">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="延绪的水上书">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/02/04/Shell%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8B/" class="post-title-link" itemprop="url">Shell简明教程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-02-04 10:49:32 / 修改时间：20:28:07" itemprop="dateCreated datePublished" datetime="2024-02-04T10:49:32+08:00">2024-02-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/The-Missing-Semester/" itemprop="url" rel="index"><span itemprop="name">The Missing Semester</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2024/02/04/Shell%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8B/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2024/02/04/Shell简明教程/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="shell-使用"><a href="#shell-使用" class="headerlink" title="shell 使用"></a>shell 使用</h3><h4 id="什么是shell"><a href="#什么是shell" class="headerlink" title="什么是shell"></a>什么是shell</h4><p>如今的计算机有着多种多样的交互接口让我们可以进行指令的的输入，如：图像化的用户界面（GUI）、语音输入 、AR&#x2F;VR 。 这些交互接口可以覆盖 80% 的使用场景，但是它们也从根本上限制了你的操作方式——你不能点击一个不存在的按钮或者是用语音输入一个还没有被录入的指令。为了充分利用计算机的能力，我们不得不回到最根本的方式，使用文字接口：Shell。</p>
<p>shell 通常指的是操作系统提供给用户与内核进行交互的用户接口。<strong>Bourne Again Shell</strong>，简称 <strong>bash</strong>。 这是被最广泛使用的一种 shell，它的语法和其他的 shell 都是类似的。</p>
<hr>
<h4 id="shell-大致原理"><a href="#shell-大致原理" class="headerlink" title="shell 大致原理"></a>shell 大致原理</h4><p>shell 基于空格分割命令并进行解析，然后执行第一个单词代表的程序，并将后续的单词作为程序可以访问的参数。如果您希望传递的参数中包含空格（例如一个名为 My Photos 的文件夹），您要么用使用单引号，双引号将其包裹起来，要么使用转义符号 <code>\</code> 进行处理（<code>My\ Photos</code>）。</p>
<p>类似于 Python 或 Ruby，shell 是一个编程环境，所以它具备变量、条件、循环和函数。当你在 shell 中执行命令时，您实际上是在执行一段 shell 可以解释执行的简短代码。如果你要求 shell 执行某个指令，但是该指令并不是 shell 所了解的编程关键字，那么它会去咨询 <em>环境变量</em> <code>$PATH</code>，它会列出当 shell 接到某条指令时，进行程序搜索的路径。随后它便会在 <code>$PATH</code> 中搜索由 <code>:</code> 所分割的一系列目录，基于名字搜索该程序。当找到该程序时便执行。</p>
<hr>
<h4 id="基础指令"><a href="#基础指令" class="headerlink" title="基础指令"></a>基础指令</h4><ul>
<li><p>查看时间：<code>date</code></p>
</li>
<li><p>打印文本或变量：<code>echo</code></p>
</li>
<li><p>查看指定目录下所有文件：<code>ls</code></p>
</li>
<li><p>查看命令手册：<code>man</code></p>
<p><em>注意：</em></p>
<ol>
<li><em>通常，在执行程序时使用 <code>-h</code> 或 <code>--help</code> 标记可以打印帮助信息，以便了解有哪些可用的标记或选项。</em></li>
<li><em>如果您想要知道某个命令（程序）怎么用，请试试 <code>man</code> 这个程序。它会接受一个程序名作为参数，然后将它的文档（用户手册）展现给您。</em></li>
</ol>
</li>
</ul>
<hr>
<h4 id="在shell中导航"><a href="#在shell中导航" class="headerlink" title="在shell中导航"></a>在shell中导航</h4><ul>
<li><p>当前工作目录：<code>pwd</code></p>
</li>
<li><p>切换目录：<code>cd</code></p>
</li>
<li><p>查找命令（程序）的路径：<code>which</code></p>
<p><em>注意：</em></p>
<ol>
<li><em>在 Linux 和 macOS 上，路径使用 <code>/</code> 分割，而在Windows上是 <code>\</code>。路径 <code>/</code> 代表的是系统的根目录，所有的文件夹都包括在这个路径之下；在Windows上每个盘都有一个根目录（例如： <code>C:\</code>）。</em></li>
<li>*在 Linux 文件系统中，如果某个路径以 <code>/</code> 开头，那么它是一个 <strong>绝对路径</strong>，其他的都是 <strong>相对路径</strong>。相对路径是指相对于当前工作目录的路径。在路径中，<code>.</code> 表示的是当前目录，而 <code>..</code> 表示上级目录：*</li>
<li><em>如果命令在 <code>PATH</code> 中找不到，<code>which</code> 通常不会输出任何内容。</em></li>
</ol>
</li>
</ul>
<hr>
<h4 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h4><ul>
<li>创建空文件：<code>touch</code></li>
<li>移动文件 或 重命名：<code>mv</code></li>
<li>拷贝文件：<code>cp</code></li>
<li>新建文件夹：<code>mkdir</code></li>
<li>显示文件内容 或 连接文件：<code>cat</code></li>
<li>删除文件：<code>rm</code></li>
<li>查看文件末尾内容：<code>tail</code></li>
</ul>
<hr>
<h4 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h4><p>在 shell 中，程序有两个主要的“<strong>流</strong>”：它们的<strong>输入流</strong>和<strong>输出流</strong>。 当程序尝试读取信息时，它们会从输入流中进行读取，当程序打印信息时，它们会将信息输出到输出流中。 通常，一个程序的输入输出流都是你的终端。也就是，你的键盘作为输入，显示器作为输出。 但是，我们也可以重定向这些流！</p>
<p>最简单的重定向是 <code>&lt; file</code> 和 <code>&gt; file</code>。这两个命令可以将程序的输入输出流分别重定向到文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(Py) keats@OMEN-Yanxu:~/Avalon$ <span class="built_in">touch</span> hello.txt</span><br><span class="line">(Py) keats@OMEN-Yanxu:~/Avalon$ <span class="built_in">echo</span> <span class="string">&quot;hello world!&quot;</span> &gt; hello.txt</span><br><span class="line">(Py) keats@OMEN-Yanxu:~/Avalon$ <span class="built_in">cat</span> hello.txt</span><br><span class="line">hello world!</span><br></pre></td></tr></table></figure>

<p>你还可以使用 <code>&gt;&gt;</code> 来向一个文件追加内容（<em>将命令的输出追加到文件的末尾，而不是覆盖文件内容</em>）。</p>
<p>使用<strong>管道（ <em>pipes</em> ）</strong>，我们能够更好的利用文件重定向。 <code>|</code> 操作符允许我们将一个程序的输出和另外一个程序的输入连接起来：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(Py) keats@OMEN-Yanxu:~/Avalon$ <span class="built_in">ls</span></span><br><span class="line">ICS  IGEM  PJ  Research  vpn.yaml</span><br><span class="line">(Py) keats@OMEN-Yanxu:~/Avalon$ <span class="built_in">ls</span> -l | <span class="built_in">tail</span> -n1</span><br><span class="line">-rw-r--r-- 1 keats keats  504 Jan 26 12:35 vpn.yaml</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="根用户"><a href="#根用户" class="headerlink" title="根用户"></a>根用户</h4><p>对于大多数的类 Unix 系统，有一类用户是非常特殊的，那就是：<strong>根用户（root user）</strong>。 你应该已经注意到了，在上面的输出结果中，根用户几乎不受任何限制，他可以创建、读取、更新和删除系统中的任何文件。 通常在我们并不会以根用户的身份直接登录系统，因为这样可能会因为某些错误的操作而破坏系统。 取而代之的是我们会在需要的时候使用 <code>sudo</code> 命令。顾名思义，它的作用是让您可以以 su（super user 或 root 的简写）的身份执行一些操作。 当您遇到拒绝访问（permission denied）的错误时，通常是因为此时您必须是根用户才能操作。</p>
<h3 id="shell-脚本"><a href="#shell-脚本" class="headerlink" title="shell 脚本"></a>shell 脚本</h3><h4 id="什么是-shell-脚本"><a href="#什么是-shell-脚本" class="headerlink" title="什么是 shell 脚本"></a>什么是 shell 脚本</h4><p>shell 脚本是<strong>一系列用 shell 语言编写的命令</strong>，它们按照特定的顺序组织在一个文件中，以执行特定的任务或自动化操作。shell 脚本通常用于执行一系列的命令、条件判断、循环等操作，为用户提供一个方便的方式来批量处理任务。</p>
<hr>
<h4 id="变量赋值"><a href="#变量赋值" class="headerlink" title="变量赋值"></a>变量赋值</h4><ul>
<li><p>为变量赋值：<code>foo=bar</code></p>
</li>
<li><p>访问变量中存储的数值： <code>$foo</code></p>
<p><em>注意：</em></p>
<ol>
<li><em><code>foo = bar</code> （使用空格隔开）是不能正确工作的。因为解释器会调用程序<code>foo</code> 并将 <code>=</code> 和 <code>bar</code>作为参数。 总的来说，在shell脚本中使用空格会起到分割参数的作用，有时候可能会造成混淆，请务必多加检查。</em></li>
<li><em>Bash中的字符串通过<code>&#39;</code> 和 <code>&quot;</code>分隔符来定义，但是它们的含义并不相同。以<code>&#39;</code>定义的字符串为<strong>原义</strong>字符串，其中的变量不会被<strong>转义</strong>，而 <code>&quot;</code>定义的字符串会将变量值进行替换。</em></li>
</ol>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(Py) keats@OMEN-Yanxu:~/Avalon$ foo=bar</span><br><span class="line">(Py) keats@OMEN-Yanxu:~/Avalon$ <span class="built_in">echo</span> foo</span><br><span class="line">foo</span><br><span class="line">(Py) keats@OMEN-Yanxu:~/Avalon$ <span class="built_in">echo</span> <span class="variable">$foo</span></span><br><span class="line">bar</span><br><span class="line">(Py) keats@OMEN-Yanxu:~/Avalon$ <span class="built_in">echo</span> <span class="string">&#x27;$foo&#x27;</span></span><br><span class="line"><span class="variable">$foo</span></span><br><span class="line">(Py) keats@OMEN-Yanxu:~/Avalon$ <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$foo</span>&quot;</span></span><br><span class="line">bar</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="特殊变量"><a href="#特殊变量" class="headerlink" title="特殊变量"></a>特殊变量</h4><p>和其他大多数的编程语言一样，<code>bash</code>也支持**<code>if</code>, <code>case</code>, <code>while</code> 和 <code>for</code>** 这些控制流关键字。同样地， <code>bash</code> 也支持<strong>函数</strong>，它可以接受参数并基于参数进行操作。下面这个函数是一个例子，它会创建一个文件夹并使用<code>cd</code>进入该文件夹。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">mcd</span></span> () &#123;</span><br><span class="line">    <span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与其他脚本语言不同，bash使用了很多<strong>特殊的变量</strong>来表示参数、错误代码和相关变量。常见的有：</p>
<ul>
<li><code>$0</code> - 脚本名</li>
<li><code>$1</code> 到 <code>$9</code> - 脚本的参数。 <code>$1</code> 是第一个参数，依此类推。</li>
<li><code>$@</code> - 所有参数</li>
<li><code>$#</code> - 参数个数</li>
<li><code>$?</code> - 前一个命令的返回值</li>
<li><code>$$</code> - 当前脚本的进程识别码</li>
<li><code>!!</code> - 完整的上一条命令，包括参数。<em>常见应用：当你因为权限不足执行命令失败时，可以使用 <code>sudo !!</code>再尝试一次。</em></li>
<li><code>$_</code> - 上一条命令的最后一个参数。<em>如果你正在使用的是交互式 shell，你可以通过按下 <code>Esc</code> 之后键入 . 来获取这个值。</em></li>
</ul>
<hr>
<h4 id="输入输出"><a href="#输入输出" class="headerlink" title="输入输出"></a>输入输出</h4><p>一般情况下，每个 Unix&#x2F;Linux 命令运行时都会打开三个文件：</p>
<ul>
<li>**标准输入文件(stdin)**：stdin的文件描述符为0，Unix程序默认从stdin读取数据。</li>
<li>**标准输出文件(stdout)**：stdout 的文件描述符为1，Unix程序默认向stdout输出数据。</li>
<li>**标准错误文件(stderr)**：stderr的文件描述符为2，Unix程序会向stderr流中写入错误信息。</li>
</ul>
<p>默认情况下，<code>command &gt; file</code> 将 stdout 重定向到 file，<code>command &lt; file</code> 将 stdin 重定向到 file。</p>
<ul>
<li><p>如果希望 stderr 重定向到 file，可以这样写：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">command</span> 2&gt;file	<span class="comment"># 2表示标准错误文件(stderr)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>如果希望将 stdout 和 stderr 合并后重定向到 file，可以这样写：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">command</span> &gt; file 2&gt;&amp;1	<span class="comment"># 2&gt;&amp;1 表示将 标准错误2 重定向到与 标准输出1 相同的位置</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>如果希望对 stdin 和 stdout 都重定向，可以这样写：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">command</span> &lt; file1 &gt;file2	<span class="comment"># &lt;和&gt;后面是否空格不影响命令执行</span></span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h4 id="返回值（退出码）"><a href="#返回值（退出码）" class="headerlink" title="返回值（退出码）"></a>返回值（退出码）</h4><p>命令通常使用 <code>STDOUT</code>来返回输出值，使用<code>STDERR</code> 来返回错误及错误码，便于脚本以更加友好的方式报告错误。 <strong>返回码或退出状态</strong>是脚本&#x2F;命令之间交流执行状态的方式。返回值0表示正常执行，其他所有非0的返回值都表示有错误发生。</p>
<p>退出码可以搭配 <code>&amp;&amp;</code>（与操作符）和 <code>||</code>（或操作符）使用，用来进行条件判断，决定是否执行其他程序。它们都属于<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Short-circuit_evaluation">短路运算符</a>。同一行的多个命令可以用<code>;</code>分隔。程序 <code>true</code> 的返回码永远是<code>0</code>，<code>false</code> 的返回码永远是<code>1</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(Py) keats@OMEN-Yanxu:~/Avalon$ <span class="literal">false</span> || <span class="built_in">echo</span> <span class="string">&quot;Oops, fail&quot;</span></span><br><span class="line">Oops, fail</span><br><span class="line">(Py) keats@OMEN-Yanxu:~/Avalon$ <span class="literal">true</span> || <span class="built_in">echo</span> <span class="string">&quot;Will not be printed&quot;</span></span><br><span class="line">(Py) keats@OMEN-Yanxu:~/Avalon$ <span class="literal">true</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;Things went well&quot;</span></span><br><span class="line">Things went well</span><br><span class="line">(Py) keats@OMEN-Yanxu:~/Avalon$ <span class="literal">false</span> &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;Will not be printed&quot;</span></span><br><span class="line">(Py) keats@OMEN-Yanxu:~/Avalon$ <span class="literal">false</span> ; <span class="built_in">echo</span> <span class="string">&quot;This will always run&quot;</span></span><br><span class="line">This will always run</span><br></pre></td></tr></table></figure>

<p>另一个常见的模式是以变量的形式获取一个命令的输出，这可以通过 <strong>命令替换（command substitution）</strong>实现。下面是一个例子：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(Py) keats@OMEN-Yanxu:~/Avalon$ <span class="built_in">echo</span> <span class="string">&quot;Starting program at <span class="subst">$(date)</span>&quot;</span></span><br><span class="line">Starting program at Sun Feb  4 16:35:02 CST 2024</span><br></pre></td></tr></table></figure>

<ul>
<li><p>当你通过 <code>$( CMD )</code> 这样的方式来执行<code>CMD</code> 这个命令时，它的输出结果会替换掉 <code>$( CMD )</code> 。</p>
<p><em>例如，如果执行 <code>for file in $(ls)</code> ，shell首先将调用<code>ls</code> ，然后遍历得到的这些返回值。</em></p>
</li>
</ul>
<p>还有一个冷门的类似特性是 <strong>进程替换（process substitution）</strong>。这在我们希望返回值通过文件而不是STDIN传递时很有用</p>
<ul>
<li><code>&lt;( CMD )</code> 会执行 <code>CMD</code> 并将结果输出到一个临时文件中，并将 <code>&lt;( CMD )</code> 替换成临时文件名。。</li>
</ul>
<p>  <em>例如， <code>diff &lt;(ls foo) &lt;(ls bar)</code> 会显示文件夹 <code>foo</code> 和 <code>bar</code> 中文件的区别。</em></p>
<hr>
<h4 id="通配"><a href="#通配" class="headerlink" title="通配"></a>通配</h4><p>当执行脚本时，我们经常需要提供形式类似的参数。bash使我们可以轻松的实现这一操作，它可以基于文件扩展名展开表达式。这一技术被称为shell的 <strong>通配（globbing）</strong>。</p>
<ul>
<li><p><strong>通配符</strong>：当你想要利用通配符进行匹配时，你可以分别使用 <code>?</code> 和 <code>*</code> 来匹配一个或任意个字符。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 对于文件foo, foo1, foo2, foo10 和 bar</span></span><br><span class="line">$ <span class="built_in">rm</span> foo?	<span class="comment"># 删除 foo1 和 foo2</span></span><br><span class="line">$ <span class="built_in">rm</span> foo*	<span class="comment"># 删除除了`bar`之外的所有文件</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>**花括号<code>&#123;&#125;</code>**：当你有一系列的指令，其中包含一段公共子串时，可以用花括号来自动展开这些命令。这在批量移动或转换文件时非常方便。</p>
</li>
</ul>
<hr>
<h4 id="shebang"><a href="#shebang" class="headerlink" title="shebang"></a>shebang</h4><p>注意，脚本并不一定只有用 bash 写才能在终端里调用。比如说，这是一段 Python 脚本，作用是将输入的参数倒序输出：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/local/bin/python</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">for</span> arg <span class="keyword">in</span> <span class="built_in">reversed</span>(sys.argv[<span class="number">1</span>:]):</span><br><span class="line">    <span class="built_in">print</span>(arg)</span><br></pre></td></tr></table></figure>

<p>内核知道去用 python 解释器而不是 shell 命令来运行这段脚本，是因为脚本的开头第一行的 <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Shebang_(Unix)">shebang</a>。</p>
<p>在 <code>shebang</code> 行中使用 <code>env</code> 命令是一种很好的实践，它会利用环境变量中的程序来解析该脚本，这样就提高来您的脚本的可移植性。<code>env</code> 会利用我们第一节讲座中介绍过的<code>PATH</code> 环境变量来进行定位。 例如，此处使用了<code>env</code>的shebang看上去时这样的<code>#!/usr/bin/env python</code>。</p>
<hr>
<h4 id="shell-函数-VS-脚本"><a href="#shell-函数-VS-脚本" class="headerlink" title="shell 函数 VS 脚本"></a>shell 函数 VS 脚本</h4><p>初次接触的小伙伴们可能有些疑惑，我们敲进命令行的一条条函数和脚本有什么区别呢？粗略地看，有如下一些不同点：</p>
<ul>
<li>函数只能与shell使用相同的语言，脚本可以使用任意语言。因此在脚本中包含 <code>shebang</code> 是很重要的。</li>
<li>函数仅在定义时被加载，脚本会在每次被执行时加载。这让函数的加载比脚本略快一些，但每次修改函数定义，都要重新加载一次。</li>
<li>函数会在当前的shell环境中执行，脚本会在单独的进程中执行。因此，函数可以对环境变量进行更改，比如改变当前工作目录，脚本则不行。脚本需要使用 <code>export</code>将环境变量导出，并将值传递给环境变量。</li>
<li>与其他程序语言一样，函数可以提高代码模块性、代码复用性并创建清晰性的结构。shell脚本中往往也会包含它们自己的函数定义。</li>
</ul>
<h3 id="shell-工具"><a href="#shell-工具" class="headerlink" title="shell 工具"></a>shell 工具</h3><h4 id="查看命令如何使用"><a href="#查看命令如何使用" class="headerlink" title="查看命令如何使用"></a>查看命令如何使用</h4><p><code>man</code>命令是手册（manual）的缩写，它提供了命令的用户手册。</p>
<hr>
<h4 id="查找文件"><a href="#查找文件" class="headerlink" title="查找文件"></a>查找文件</h4><p>所有的类UNIX系统都包含一个名为 <code>find</code>的工具，它是 shell 上用于查找文件的绝佳工具。<code>find</code>命令会递归地搜索符合条件的文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查找所有名称为src的文件夹</span></span><br><span class="line">$ find . -name src -<span class="built_in">type</span> d</span><br><span class="line"><span class="comment"># 查找前一天修改的所有文件</span></span><br><span class="line">$ find . -mtime -1</span><br></pre></td></tr></table></figure>

<p>除了列出所寻找的文件之外，<code>find</code> 还能对所有查找到的文件进行操作。这能极大地简化一些单调的任务。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除全部扩展名为.tmp 的文件</span></span><br><span class="line">$ find . -name <span class="string">&#x27;*.tmp&#x27;</span> -<span class="built_in">exec</span> <span class="built_in">rm</span> &#123;&#125; \;</span><br><span class="line"><span class="comment"># 查找全部的 PNG 文件并将其转换为 JPG</span></span><br><span class="line">$ find . -name <span class="string">&#x27;*.png&#x27;</span> -<span class="built_in">exec</span> convert &#123;&#125; &#123;&#125;.jpg \;w</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="查看代码"><a href="#查看代码" class="headerlink" title="查看代码"></a>查看代码</h4><p>很多类UNIX的系统都提供了<code>grep</code>命令，它是用于对输入文本进行匹配的通用工具。</p>
<p><code>grep</code> 有很多选项，这也使它成为一个非常全能的工具。其中我们经常使用的有：</p>
<ul>
<li><code>-C</code> ：获取查找结果的上下文（Context）。</li>
<li><code>-v</code> ：将对结果进行反选（Invert），也就是输出不匹配的结果。</li>
<li><code>-R</code> ：递归地进入子目录并搜索所有的文本文件。</li>
</ul>
<p>举例来说， <code>grep -C 5</code> 会输出匹配结果前后五行。</p>
<hr>
<h4 id="查找-shell-命令"><a href="#查找-shell-命令" class="headerlink" title="查找 shell 命令"></a>查找 shell 命令</h4><p>随着你使用shell的时间越来越久，你可能想要找到之前输入过的某条命令。</p>
<ul>
<li><p>按<strong>向上的方向键</strong>会显示你使用过的上一条命令，继续按上键则会遍历整个历史记录。</p>
</li>
<li><p><strong><code>history</code></strong> 命令允许您以程序员的方式来访问shell中输入的历史命令。这个命令会在标准输出中打印shell中的里面命令。如果我们要搜索历史记录，则可以利用管道将输出结果传递给 <code>grep</code> 进行模式搜索。 例如：<code>history | grep find</code> 会打印包含find子串的命令。</p>
</li>
<li><p>对于大多数的shell来说，你可以使用 <strong><code>Ctrl+R</code></strong> 对命令历史记录进行回溯搜索。敲 <code>Ctrl+R</code> 后您可以输入子串来进行匹配，查找历史命令行。</p>
</li>
</ul>
<h3 id="更多"><a href="#更多" class="headerlink" title="更多"></a>更多</h3><p>详见：<a target="_blank" rel="noopener" href="https://missing.csail.mit.edu/">missing semester</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">xht03</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">12</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xht03</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  















    <div id="pjax">
  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://book-written-on-water.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

    </div>
</body>
</html>
